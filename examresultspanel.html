<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCST - Exam & Results Management with Unit System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2062f0;
            --primary-light: #4a86f8;
            --primary-dark: #0a3cb9;
            --secondary: #3943d6;
            --accent: #a3defd;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background: #f5f7fb;
            color: #333;
            transition: var(--transition);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 100;
            box-shadow: 2px 0 15px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
            position: relative;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .sidebar-header p {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Mobile close button for sidebar */
        .sidebar-close {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .sidebar-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            text-decoration: none;
            color: white;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: rgba(255,255,255,0.5);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: white;
        }

        .menu-item i {
            margin-right: 12px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .menu-item span {
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
            width: calc(100% - var(--sidebar-width));
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            color: var(--dark);
            padding: 0 25px;
            height: var(--header-height);
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 99;
            width: 100%;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .toggle-sidebar {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--secondary);
            cursor: pointer;
            margin-right: 15px;
            display: none;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .header-right {
            display: flex;
            align-items: center;
        }

        #searchBox {
            padding: 10px 18px;
            border-radius: 30px;
            border: 1px solid #e0e0e0;
            width: 250px;
            margin-right: 15px;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        #searchBox:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(32, 98, 240, 0.1);
        }

        .user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 30px;
            transition: var(--transition);
        }

        .user-profile:hover {
            background: var(--light);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--secondary);
            cursor: pointer;
            margin-left: 15px;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: var(--light);
            color: var(--primary);
        }

        /* Main */
        main {
            padding: 30px;
            max-width: 100%;
            overflow-x: auto;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: var(--transition);
            border: 1px solid #f0f0f0;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: var(--primary-light);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .card-icon.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .card-icon.success {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
        }

        .card-icon.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #fd7e14 100%);
        }

        .card-icon.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #e83e8c 100%);
        }

        .card-icon.info {
            background: linear-gradient(135deg, var(--info) 0%, #5bc0de 100%);
        }

        .card-icon.purple {
            background: linear-gradient(135deg, #8a2be2 0%, #9d4edd 100%);
        }

        .card-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--primary-dark);
        }

        .card-footer {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }

        /* Unit Management Section */
        .unit-management {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 35px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .unit-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .unit-info-item {
            padding: 20px;
            background: linear-gradient(to right, #f8f9fa, #ffffff);
            border-radius: 10px;
            border: 1px solid #eaeaea;
        }

        .unit-info-item h4 {
            margin-bottom: 15px;
            color: var(--secondary);
            font-size: 1.1rem;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-bottom: 1px solid #eaeaea;
        }

        .tab {
            padding: 18px 25px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: rgba(32, 98, 240, 0.05);
        }

        .tab:hover:not(.active) {
            background: rgba(0,0,0,0.03);
            color: var(--primary-dark);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 35px;
            border: 1px solid #f0f0f0;
            border-top: none;
            width: 100%;
            overflow-x: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th, td {
            padding: 16px 20px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
            white-space: nowrap;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: rgba(32, 98, 240, 0.03);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            white-space: nowrap;
            font-size: 0.85rem;
            padding: 7px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .action-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Buttons */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(32, 98, 240, 0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(32, 98, 240, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #218838 0%, var(--success) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #fd7e14 100%);
            color: #000;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, var(--warning) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #e83e8c 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, var(--danger) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info) 0%, #5bc0de 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.2);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, var(--info) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(23, 162, 184, 0.3);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8a2be2 0%, #9d4edd 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.2);
        }

        .btn-purple:hover {
            background: linear-gradient(135deg, #7a1ed2 0%, #8a2be2 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(138, 43, 226, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.2);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(108, 117, 125, 0.3);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--secondary);
            font-size: 0.95rem;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            transition: var(--transition);
            font-size: 0.95rem;
            background: #fff;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(32, 98, 240, 0.15);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content h3 {
            margin-bottom: 25px;
            color: var(--primary);
            font-weight: 600;
            font-size: 1.5rem;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eaeaea;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
            color: white;
            padding: 18px 30px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(150%);
            transition: transform 0.4s ease;
        }

        .success-message.show {
            transform: translateX(0);
        }

        /* Class Allocation Section */
        .class-allocation {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        .class-list, .student-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }

        .class-list h3, .student-list h3 {
            margin-bottom: 20px;
            color: var(--secondary);
            font-size: 1.2rem;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
        }

        .class-item {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: var(--transition);
            background: #fafafa;
        }

        .class-item:hover {
            background: linear-gradient(to right, #f8f9ff, #ffffff);
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .class-item.active {
            background: linear-gradient(to right, rgba(32, 98, 240, 0.1), rgba(32, 98, 240, 0.05));
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(32, 98, 240, 0.1);
        }

        .student-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .student-item:hover {
            background: #f8fafc;
            border-radius: 8px;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-info {
            display: flex;
            flex-direction: column;
        }

        .student-name {
            font-weight: 600;
            color: #333;
        }

        .student-details {
            font-size: 0.85rem;
            color: #666;
            margin-top: 4px;
        }

        /* Status badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
        }

        .status-badge.inactive {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
        }

        .status-badge.pending {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
        }

        .status-badge.enrolled {
            background: linear-gradient(135deg, #cce5ff 0%, #b3d7ff 100%);
            color: #004085;
        }

        .status-badge.completed {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            color: #0c5460;
        }

        /* Undo Notification */
        .undo-notification {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.4s ease;
            border-left: 4px solid var(--warning);
        }

        .undo-notification.show {
            transform: translateX(-50%) translateY(0);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(32, 98, 240, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 30px;
            color: #666;
        }

        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        /* Dark Theme */
        .dark {
            background: #121212;
            color: #f8f9fa;
        }

        .dark .sidebar {
            background: linear-gradient(180deg, #1a1a1a 0%, #000 100%);
        }

        .dark header {
            background: #1e1e1e;
            color: #f8f9fa;
        }

        .dark .card {
            background: #1e1e1e;
            color: #f8f9fa;
            border-color: #333;
        }

        .dark .table-container {
            background: #1e1e1e;
            border-color: #333;
        }

        .dark th {
            background: #2d2d2d;
            color: #f8f9fa;
            border-color: #444;
        }

        .dark td {
            border-color: #444;
        }

        .dark tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .dark .modal-content {
            background: #2d2d2d;
            color: #f8f9fa;
        }

        .dark .form-group input, .dark .form-group select, .dark .form-group textarea {
            background: #2d2d2d;
            border-color: #444;
            color: #f8f9fa;
        }

        .dark #searchBox {
            background: #2d2d2d;
            border-color: #444;
            color: #f8f9fa;
        }

        .dark .user-profile:hover {
            background: #2d2d2d;
        }

        .dark .tabs {
            background: #1e1e1e;
            border-color: #333;
        }

        .dark .tab-content {
            background: #1e1e1e;
            border-color: #333;
        }

        .dark .unit-management {
            background: #1e1e1e;
            border-color: #333;
        }

        .dark .unit-info-item {
            background: #2d2d2d;
            border-color: #444;
        }

        .dark .class-list, .dark .student-list {
            background: #1e1e1e;
            border-color: #333;
        }

        .dark .class-item {
            background: #2d2d2d;
            border-color: #444;
        }

        .dark .student-item {
            border-color: #444;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 900px;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .toggle-sidebar {
                display: block;
            }

            /* Show close button in sidebar on mobile */
            .sidebar-close {
                display: flex;
            }

            .dashboard-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .class-allocation {
                grid-template-columns: 1fr;
            }

            .unit-info {
                grid-template-columns: 1fr;
            }

            /* Adjust header title for mobile */
            header h1 {
                font-size: 1.3rem;
                padding-top: 5px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
            }

            #searchBox {
                width: 180px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 15px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }
            
            .table-container {
                margin: 0 -15px;
                width: calc(100% + 30px);
            }

            /* Further adjust header title for smaller screens */
            header h1 {
                font-size: 1.2rem;
                line-height: 1.3;
                padding-top: 8px;
            }
        }

        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            header {
                padding: 0 15px;
                height: 60px;
            }

            #searchBox {
                width: 150px;
                padding: 8px 12px;
            }

            .user-info {
                display: none;
            }

            main {
                padding: 20px;
            }
            
            .class-allocation {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 15px;
            }

            /* Adjust header for very small screens */
            header h1 {
                font-size: 1.1rem;
                max-width: 180px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                padding-top: 5px;
            }

            .header-left {
                flex: 1;
                min-width: 0; /* Allows text truncation */
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1rem;
                max-width: 150px;
            }

            .toggle-sidebar {
                margin-right: 10px;
            }
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="sidebar-close" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
            <h2>UCST College</h2>
            <p>Exam & Unit Management</p>
        </div>
        
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="units">
                <i class="fas fa-layer-group"></i>
                <span>Manage Units</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="exams">
                <i class="fas fa-book"></i>
                <span>Manage Exams</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="results">
                <i class="fas fa-upload"></i>
                <span>Upload Results</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="transcripts">
                <i class="fas fa-file-alt"></i>
                <span>Generate Transcripts</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Reports & Analytics</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <div class="header-left">
                <button class="toggle-sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <h1>Exam & Unit Management System</h1>
            </div>
            
            <div class="header-right">
                <input type="text" id="searchBox" placeholder="Search students, exams, units...">
                
                <div class="user-profile">
                    <div class="user-avatar">EO</div>
                    <div class="user-info">
                        <div class="user-name">Exam Officer</div>
                        <div class="user-role">Exam Department</div>
                    </div>
                </div>
                
                <button class="theme-toggle" id="toggleTheme">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </header>

        <main>
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Students</div>
                            <div class="card-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalStudents">0</div>
                        <div class="card-footer">Registered in your classes</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Units</div>
                            <div class="card-icon purple">
                                <i class="fas fa-layer-group"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalUnits">0</div>
                        <div class="card-footer">Units under management</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Active Exams</div>
                            <div class="card-icon success">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                        </div>
                        <div class="card-value" id="activeExams">0</div>
                        <div class="card-footer">Currently running exams</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Pending Results</div>
                            <div class="card-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="card-value" id="pendingResults">0</div>
                        <div class="card-footer">Results awaiting upload</div>
                    </div>
                </div>

                <!-- Unit Management Overview -->
                <div class="unit-management">
                    <div class="unit-header">
                        <h3>Unit Management Overview</h3>
                        <button class="btn-purple" onclick="openUnitModal()">
                            <i class="fas fa-plus"></i> Assign New Unit
                        </button>
                    </div>
                    
                    <div class="unit-info">
                        <div class="unit-info-item">
                            <h4>Your Assigned Classes</h4>
                            <div id="assignedClassesList">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                        
                        <div class="unit-info-item">
                            <h4>Students in Your Classes</h4>
                            <div id="studentCountInfo">
                                <div class="loading-spinner"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Exams Table -->
                <div class="table-container">
                    <div class="card-header" style="padding: 20px;">
                        <h3 style="margin: 0; color: var(--secondary);">Recent Exams by Unit</h3>
                        <button class="btn-primary" onclick="openExamModal()">
                            <i class="fas fa-plus"></i> Create New Exam
                        </button>
                    </div>
                    <table id="recentExamsTable">
                        <thead>
                            <tr>
                                <th>Exam ID</th>
                                <th>Exam Name</th>
                                <th>Unit</th>
                                <th>Date</th>
                                <th>Class</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentExamsTableBody">
                            <tr><td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner" style="margin: 0 auto;"></div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Units Tab -->
            <div class="tab-content" id="units">
                <div class="card-header" style="padding: 20px; background: white; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: var(--secondary);">Unit Management</h3>
                    <div>
                        <button class="btn-purple" onclick="openUnitModal()">
                            <i class="fas fa-plus"></i> Assign New Unit
                        </button>
                        <button class="btn-info" onclick="fetchMyClasses()">
                            <i class="fas fa-sync-alt"></i> Refresh Classes
                        </button>
                    </div>
                </div>
                
                <!-- Class Allocation Section -->
                <div class="class-allocation">
                    <div class="class-list">
                        <h3>My Assigned Classes</h3>
                        <div id="myClassesList">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    
                    <div class="student-list">
                        <h3>Students in Selected Class</h3>
                        <div id="classStudentsList">
                            <p style="color: #666; text-align: center; padding: 20px;">Select a class to view students</p>
                        </div>
                    </div>
                </div>
                
                <!-- Units Table -->
                <div class="table-container">
                    <table id="unitsTable">
                        <thead>
                            <tr>
                                <th>Unit Code</th>
                                <th>Unit Name</th>
                                <th>Course</th>
                                <th>Semester</th>
                                <th>Credits</th>
                                <th>Class</th>
                                <th>Students</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="unitsTableBody">
                            <tr><td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-layer-group"></i>
                                    <h4>No Units Assigned</h4>
                                    <p>Start by assigning your first unit to a class</p>
                                    <button class="btn-purple" onclick="openUnitModal()" style="margin-top: 15px;">
                                        <i class="fas fa-plus"></i> Assign Unit
                                    </button>
                                </div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Exams Tab -->
            <div class="tab-content" id="exams">
                <div class="card-header" style="padding: 20px; background: white; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: var(--secondary);">Exam Management by Unit</h3>
                    <button class="btn-primary" onclick="openExamModal()">
                        <i class="fas fa-plus"></i> Create New Exam
                    </button>
                </div>
                
                <!-- Unit Filter -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="examUnitFilter">Filter by Unit</label>
                    <select id="examUnitFilter" onchange="filterExamsByUnit()">
                        <option value="">All Units</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table id="examsTable">
                        <thead>
                            <tr>
                                <th>Exam ID</th>
                                <th>Exam Name</th>
                                <th>Unit</th>
                                <th>Class</th>
                                <th>Exam Type</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="examsTableBody">
                            <tr><td colspan="8" style="text-align: center; padding: 40px;">
                                <div class="loading-spinner" style="margin: 0 auto;"></div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Upload Results Tab -->
            <div class="tab-content" id="results">
                <div class="card-header" style="padding: 20px; background: white; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: var(--secondary);">Result Upload by Unit</h3>
                    <div>
                        <button class="btn-success" onclick="openUploadModal()">
                            <i class="fas fa-upload"></i> Upload Results
                        </button>
                        <button class="btn-info" onclick="openBulkUploadModal()">
                            <i class="fas fa-file-import"></i> Bulk Upload by Unit
                        </button>
                    </div>
                </div>
                
                <!-- Unit Filter for Results -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="resultUnitFilter">Filter by Unit</label>
                    <select id="resultUnitFilter" onchange="filterResultsByUnit()">
                        <option value="">All Units</option>
                    </select>
                </div>
                
                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Admission No</th>
                                <th>Student Name</th>
                                <th>Unit</th>
                                <th>Class</th>
                                <th>Exam</th>
                                <th>Marks</th>
                                <th>Grade</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <tr><td colspan="9" style="text-align: center; padding: 40px;">
                                <div class="empty-state">
                                    <i class="fas fa-upload"></i>
                                    <h4>No Results Uploaded</h4>
                                    <p>Upload results to see them here</p>
                                    <button class="btn-success" onclick="openUploadModal()" style="margin-top: 15px;">
                                        <i class="fas fa-upload"></i> Upload Results
                                    </button>
                                </div>
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Generate Transcripts Tab -->
            <div class="tab-content" id="transcripts">
                <div class="card-header" style="padding: 20px; background: white; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: var(--secondary);">Transcript Generation</h3>
                    <button class="btn-primary" onclick="generateTranscript()">
                        <i class="fas fa-file-pdf"></i> Generate Transcript
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="studentSelect">Select Student</label>
                    <select id="studentSelect">
                        <option value="">-- Select Student --</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="transcriptType">Transcript Type</label>
                    <select id="transcriptType">
                        <option value="official">Official Transcript</option>
                        <option value="unofficial">Unofficial Transcript</option>
                        <option value="provisional">Provisional Certificate</option>
                    </select>
                </div>
                
                <div id="transcriptPreview" class="table-container" style="margin-top: 20px; display: none;">
                    <h4 style="padding: 15px; border-bottom: 1px solid #ddd;">Transcript Preview</h4>
                    <table id="transcriptTable">
                        <thead>
                            <tr>
                                <th>Unit Code</th>
                                <th>Unit Name</th>
                                <th>Credits</th>
                                <th>Grade</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody id="transcriptTableBody">
                        </tbody>
                    </table>
                    <div style="padding: 15px; text-align: right;">
                        <strong>GPA: <span id="gpaValue">0.00</span></strong>
                    </div>
                </div>
            </div>

            <!-- Reports & Analytics Tab -->
            <div class="tab-content" id="reports">
                <div class="card-header" style="padding: 20px; background: white; border-radius: 12px; margin-bottom: 25px;">
                    <h3 style="margin: 0; color: var(--secondary);">Reports & Analytics by Unit</h3>
                    <div>
                        <button class="btn-info" onclick="generatePerformanceReport()">
                            <i class="fas fa-chart-line"></i> Performance Report
                        </button>
                        <button class="btn-warning" onclick="generateGradeDistribution()">
                            <i class="fas fa-chart-pie"></i> Grade Distribution
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportUnit">Unit</label>
                        <select id="reportUnit">
                            <option value="">All Units</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportClass">Class</label>
                        <select id="reportClass">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportSemester">Semester</label>
                        <select id="reportSemester">
                            <option value="">All Semesters</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                        </select>
                    </div>
                </div>
                
                <div id="reportResults" class="table-container" style="margin-top: 20px;">
                    <h4 style="padding: 15px; border-bottom: 1px solid #ddd;">Report Data</h4>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Unit</th>
                                <th>Class</th>
                                <th>Students</th>
                                <th>Average Score</th>
                                <th>Pass Rate</th>
                                <th>High Score</th>
                                <th>Low Score</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr><td colspan="7" style="text-align: center; padding: 30px; color: #666;">
                                Select filters to generate report
                            </td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="card">
                    <div class="card-header" style="padding-bottom: 20px;">
                        <h3 style="color: var(--secondary);">System Settings</h3>
                    </div>
                    <div class="form-group">
                        <label for="institutionName">Institution Name</label>
                        <input type="text" id="institutionName" value="UCST College" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="gradingSystem">Grading System</label>
                        <select id="gradingSystem" class="form-control">
                            <option value="standard">Standard Grading (A-F)</option>
                            <option value="percentage">Percentage Based</option>
                            <option value="custom">Custom Grading</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="passingGrade">Passing Grade (%)</label>
                        <input type="number" id="passingGrade" value="50" min="0" max="100" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="defaultCredits">Default Credits per Unit</label>
                        <input type="number" id="defaultCredits" value="3" min="1" max="10" class="form-control">
                    </div>
                    <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Unit Assignment Modal -->
<div class="modal" id="unitModal">
    <div class="modal-content">
        <h3>Assign Unit to Class</h3>
        <form id="unitForm">
            <div class="form-group">
                <label for="unitCode">Unit Code *</label>
                <input type="text" id="unitCode" required placeholder="e.g., DED209">
            </div>
            
            <div class="form-group">
                <label for="unitName">Unit Name *</label>
                <input type="text" id="unitName" required placeholder="e.g., Introduction to Education">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="unitCourse">Course *</label>
                    <select id="unitCourse" required>
                        <option value="">-- Select Course --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unitSemester">Semester *</label>
                    <select id="unitSemester" required>
                        <option value="">-- Select Semester --</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="unitClass">Assign to Class *</label>
                    <select id="unitClass" required>
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="unitCredits">Credits *</label>
                    <input type="number" id="unitCredits" min="1" max="10" value="3" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="unitDescription">Description (Optional)</label>
                <textarea id="unitDescription" rows="3" placeholder="Brief description of the unit..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-check"></i> Assign Unit
                </button>
                <button type="button" class="btn-secondary" onclick="closeUnitModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Unit Modal -->
<div class="modal" id="editUnitModal">
    <div class="modal-content">
        <h3>Edit Unit</h3>
        <form id="editUnitForm">
            <input type="hidden" id="editUnitId">
            
            <div class="form-group">
                <label for="editUnitCode">Unit Code *</label>
                <input type="text" id="editUnitCode" required>
            </div>
            
            <div class="form-group">
                <label for="editUnitName">Unit Name *</label>
                <input type="text" id="editUnitName" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="editUnitCourse">Course *</label>
                    <select id="editUnitCourse" required>
                        <option value="">-- Select Course --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUnitSemester">Semester *</label>
                    <select id="editUnitSemester" required>
                        <option value="">-- Select Semester --</option>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="editUnitClass">Class *</label>
                    <select id="editUnitClass" required>
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editUnitCredits">Credits *</label>
                    <input type="number" id="editUnitCredits" min="1" max="10" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="editUnitDescription">Description</label>
                <textarea id="editUnitDescription" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn-secondary" onclick="closeEditUnitModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Exam Modal -->
<div class="modal" id="examModal">
    <div class="modal-content">
        <h3>Create New Exam for Unit</h3>
        <form id="examForm">
            <div class="form-group">
                <label for="examName">Exam Name *</label>
                <input type="text" id="examName" required placeholder="e.g., CAT 1, Final Exam">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="examUnit">Select Unit *</label>
                    <select id="examUnit" required>
                        <option value="">-- Select Unit --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="examType">Exam Type *</label>
                    <select id="examType" required>
                        <option value="">-- Select Type --</option>
                        <option value="CAT">CAT (Continuous Assessment Test)</option>
                        <option value="Final">Final Exam</option>
                        <option value="Supplementary">Supplementary Exam</option>
                        <option value="Practical">Practical Exam</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="examClass">Class *</label>
                    <select id="examClass" required>
                        <option value="">-- Select Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="examDate">Exam Date *</label>
                    <input type="date" id="examDate" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="examMaxMarks">Maximum Marks *</label>
                <input type="number" id="examMaxMarks" min="1" max="200" value="100" required>
            </div>
            
            <div class="form-group">
                <label for="examDescription">Description (Optional)</label>
                <textarea id="examDescription" rows="3" placeholder="Exam description..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i> Create Exam
                </button>
                <button type="button" class="btn-secondary" onclick="closeExamModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Upload Results Modal -->
<div class="modal" id="uploadModal">
    <div class="modal-content">
        <h3>Upload Results by Unit</h3>
        <form id="uploadForm">
            <div class="form-group">
                <label for="uploadUnit">Select Unit *</label>
                <select id="uploadUnit" required>
                    <option value="">-- Select Unit --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="uploadExam">Select Exam *</label>
                <select id="uploadExam" required>
                    <option value="">-- Select Exam --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="uploadStudent">Select Student *</label>
                <select id="uploadStudent" required>
                    <option value="">-- Select Student --</option>
                    <option value="manual_entry">-- Or Enter Manually --</option>
                </select>
            </div>
            
            <!-- Manual Entry Fields (hidden by default) -->
            <div id="manualEntryFields" style="display: none;">
                <div class="form-group">
                    <label for="manualAdmissionNo">Admission Number *</label>
                    <input type="text" id="manualAdmissionNo" placeholder="e.g., STD001">
                </div>
                <div class="form-group">
                    <label for="manualStudentName">Student Name *</label>
                    <input type="text" id="manualStudentName" placeholder="e.g., John Doe">
                </div>
            </div>
            
            <div class="form-group">
                <label for="uploadMarks">Marks Obtained *</label>
                <input type="number" id="uploadMarks" min="0" max="200" required oninput="updateGrade()">
                <small style="color: #666; display: block; margin-top: 5px;">Enter marks between 0-200</small>
            </div>
            
            <div class="form-group">
                <label for="uploadGrade">Grade (Auto-calculated)</label>
                <input type="text" id="uploadGrade" readonly style="background: #f8f9fa; font-weight: bold;">
            </div>
            
            <div class="form-group">
                <label for="uploadRemarks">Remarks (Optional)</label>
                <textarea id="uploadRemarks" rows="2" placeholder="Any remarks about the result..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-upload"></i> Save Result
                </button>
                <button type="button" class="btn-secondary" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Upload Modal -->
<div class="modal" id="bulkUploadModal">
    <div class="modal-content">
        <h3>Bulk Upload Results by Unit</h3>
        <div class="form-group">
            <label for="bulkUploadUnit">Select Unit *</label>
            <select id="bulkUploadUnit" required>
                <option value="">-- Select Unit --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="bulkUploadExam">Select Exam *</label>
            <select id="bulkUploadExam" required>
                <option value="">-- Select Exam --</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="bulkUploadFile">Upload CSV File *</label>
            <input type="file" id="bulkUploadFile" accept=".csv" required>
            <small style="color: #666; display: block; margin-top: 5px;">
                Download template: <a href="#" onclick="downloadCSVTemplate()" style="color: var(--primary);">results_template.csv</a>
            </small>
            <small style="color: #666; display: block; margin-top: 5px;">
                CSV Format: AdmissionNo,StudentName,Marks,Remarks (optional)
            </small>
        </div>
        
        <div id="bulkUploadPreview" style="margin-top: 20px; display: none;">
            <h4>Preview (First 5 rows)</h4>
            <div class="table-container">
                <table id="bulkPreviewTable">
                    <thead>
                        <tr>
                            <th>Admission No</th>
                            <th>Student Name</th>
                            <th>Marks</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="bulkPreviewTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="modal-actions">
            <button type="button" class="btn-success" onclick="processBulkUpload()">
                <i class="fas fa-upload"></i> Upload Results
            </button>
            <button type="button" class="btn-secondary" onclick="closeBulkUploadModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
    <i class="fas fa-check-circle"></i>
    <span id="successMessageText">Operation completed successfully!</span>
</div>

<!-- Undo Notification -->
<div class="undo-notification" id="undoNotification">
    <i class="fas fa-exclamation-triangle" style="color: var(--warning); font-size: 1.2rem;"></i>
    <div>
        <strong id="undoMessage">Item deleted</strong>
        <small style="display: block; color: #666;">You can undo this action</small>
    </div>
    <button class="btn-warning" onclick="undoLastDelete()" style="padding: 8px 15px;">
        <i class="fas fa-undo"></i> Undo
    </button>
    <button class="btn-secondary" onclick="closeUndoNotification()" style="padding: 8px 15px;">
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- Firebase and PDF Libraries -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyAQZ1_Grh00sFgOp8pxkKff10sMFSw9xlc",
    authDomain: "jnnp-system.firebaseapp.com",
    databaseURL: "https://jnnp-system-default-rtdb.firebaseio.com",
    projectId: "jnnp-system",
    storageBucket: "jnnp-system.firebasestorage.app", 
    messagingSenderId: "769232855377",
    appId: "1:769232855377:web:e3ba51e3e25cc24735f370"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global variables
let admissions = {};
let courses = {};
let exams = {};
let results = {};
let units = {};
let classes = {};
let classAllocations = {};
let isDataLoaded = false;

// Undo functionality
let lastDeletedItem = null;
let lastDeletedType = null;
let lastDeletedId = null;

// Grading scale
const gradingScale = [
    { min: 80, max: 200, grade: 'DISTINCTION1', points: 4.0 },
    { min: 75, max: 79, grade: 'DISTINCTION2', points: 3.7 },
    { min: 70, max: 74, grade: 'DISTINCTION2', points: 3.3 },
    { min: 65, max: 69, grade: 'CREDIT1', points: 3.0 },
    { min: 60, max: 64, grade: 'CREDIT', points: 2.7 },
    { min: 55, max: 59, grade: 'PASS', points: 2.3 },
    { min: 50, max: 54, grade: 'PASS', points: 2.0 },
    { min: 45, max: 49, grade: 'PASS', points: 1.7 },
    { min: 40, max: 44, grade: 'PASS', points: 1.3 },
    { min: 35, max: 39, grade: 'REFER', points: 1.0 },
    { min: 0, max: 34, grade: 'FAIL', points: 0.0 }
];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    loadData();
});

// Load data from Firebase
function loadData() {
    console.log("Loading data from Firebase...");
    
    // Load admissions
    db.ref("admissions").once("value").then(snapshot => {
        admissions = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(admissions).length} admissions`);
        updateStudentSelects();
        checkDataLoaded();
    });

    // Load courses
    db.ref("courses").once("value").then(snapshot => {
        courses = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(courses).length} courses`);
        updateCourseSelects();
        checkDataLoaded();
    });

    // Load exams
    db.ref("exams").once("value").then(snapshot => {
        exams = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(exams).length} exams`);
        renderExamsTable();
        renderRecentExamsTable();
        updateDashboardCards();
        checkDataLoaded();
    });

    // Load results
    db.ref("results").once("value").then(snapshot => {
        results = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(results).length} results`);
        renderResultsTable();
        updateDashboardCards();
        checkDataLoaded();
    });

    // Load units
    db.ref("units").once("value").then(snapshot => {
        units = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(units).length} units`);
        renderUnitsTable();
        updateUnitSelects();
        updateDashboardCards();
        checkDataLoaded();
    });

    // Load classes
    db.ref("classes").once("value").then(snapshot => {
        classes = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(classes).length} classes`);
        fetchMyClasses();
        updateClassSelects();
        checkDataLoaded();
    });

    // Load class allocations
    db.ref("classAllocations").once("value").then(snapshot => {
        classAllocations = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(classAllocations).length} class allocations`);
        checkDataLoaded();
    });
}

function checkDataLoaded() {
    if (Object.keys(admissions).length > 0 && 
        Object.keys(courses).length > 0 && 
        Object.keys(classes).length >= 0) {
        isDataLoaded = true;
        console.log("All data loaded successfully");
    }
}

// Setup event listeners
function setupEventListeners() {
    // Tab switching
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Update active menu item
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // Close sidebar on mobile when clicking a menu item
            if (window.innerWidth <= 992) {
                document.querySelector('.sidebar').classList.remove('active');
            }
        });
    });

    // Theme toggle
    document.getElementById('toggleTheme').addEventListener('click', function() {
        document.body.classList.toggle('dark');
        const icon = this.querySelector('i');
        if (document.body.classList.contains('dark')) {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
        }
    });

    // Search functionality
    document.getElementById('searchBox').addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        
        // Search in exams table
        const examRows = document.querySelectorAll('#examsTableBody tr, #recentExamsTableBody tr');
        examRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
        
        // Search in results table
        const resultRows = document.querySelectorAll('#resultsTableBody tr');
        resultRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
        
        // Search in units table
        const unitRows = document.querySelectorAll('#unitsTableBody tr');
        unitRows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    // Form submissions
    document.getElementById('unitForm').addEventListener('submit', handleUnitSubmit);
    document.getElementById('editUnitForm').addEventListener('submit', handleEditUnitSubmit);
    document.getElementById('examForm').addEventListener('submit', handleExamSubmit);
    document.getElementById('uploadForm').addEventListener('submit', handleResultUpload);

    // Manual entry toggle
    document.getElementById('uploadStudent').addEventListener('change', function() {
        const manualEntryFields = document.getElementById('manualEntryFields');
        if (this.value === 'manual_entry') {
            manualEntryFields.style.display = 'block';
        } else {
            manualEntryFields.style.display = 'none';
        }
    });

    // Bulk upload file preview
    document.getElementById('bulkUploadFile').addEventListener('change', function(e) {
        previewCSVFile(e.target.files[0]);
    });

    // Sidebar toggle for mobile
    document.querySelector('.toggle-sidebar').addEventListener('click', function() {
        document.querySelector('.sidebar').classList.toggle('active');
    });

    // Sidebar close button for mobile
    document.getElementById('sidebarClose').addEventListener('click', function() {
        document.querySelector('.sidebar').classList.remove('active');
    });

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.querySelector('.toggle-sidebar');
        
        if (window.innerWidth <= 992 && 
            sidebar.classList.contains('active') &&
            !sidebar.contains(event.target) && 
            !toggleBtn.contains(event.target)) {
            sidebar.classList.remove('active');
        }
    });
}

// Fetch classes assigned to the current user
function fetchMyClasses() {
    const userId = 'exam_officer_001';
    
    // In this demo, we'll assume all classes are assigned to the exam officer
    // In a real system, you would filter by lecturerId or classAllocations
    const myClasses = Object.entries(classes);
    
    updateMyClassesUI(myClasses);
    updateDashboardCards();
}

// Update UI with my classes
function updateMyClassesUI(myClasses) {
    const myClassesList = document.getElementById('myClassesList');
    const assignedClassesList = document.getElementById('assignedClassesList');
    
    if (myClasses.length === 0) {
        myClassesList.innerHTML = '<div class="empty-state"><i class="fas fa-chalkboard-teacher"></i><p>No classes assigned to you yet.</p></div>';
        assignedClassesList.innerHTML = '<p>No classes assigned</p>';
        return;
    }
    
    let classesHTML = '';
    let assignedHTML = '<div style="max-height: 200px; overflow-y: auto;">';
    
    myClasses.forEach(([classId, classData]) => {
        const studentsInClass = Object.values(admissions).filter(admission => 
            admission.classId === classId || admission.class === classId
        ).length;
        
        classesHTML += `
            <div class="class-item" onclick="selectClass('${classId}')">
                <strong>${classData.className || 'Unnamed Class'}</strong><br>
                <small>Course: ${classData.courseName || 'N/A'} | Students: ${studentsInClass}</small>
            </div>
        `;
        
        assignedHTML += `
            <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                <strong>${classData.className || 'Unnamed Class'}</strong> 
                <span style="float: right; background: #e9ecef; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">
                    ${studentsInClass} students
                </span>
            </div>
        `;
    });
    
    assignedHTML += '</div>';
    
    myClassesList.innerHTML = classesHTML;
    assignedClassesList.innerHTML = assignedHTML;
    
    // Update student count info
    const totalStudents = myClasses.reduce((total, [classId]) => {
        return total + Object.values(admissions).filter(admission => 
            admission.classId === classId || admission.class === classId
        ).length;
    }, 0);
    
    document.getElementById('studentCountInfo').innerHTML = `
        <div style="font-size: 2rem; font-weight: bold; color: var(--primary);">${totalStudents}</div>
        <p>Students across ${myClasses.length} classes</p>
    `;
}

// Select a class to view its students
function selectClass(classId) {
    const classData = classes[classId];
    if (!classData) return;
    
    // Update active class in UI
    document.querySelectorAll('.class-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.closest('.class-item').classList.add('active');
    
    // Get students in this class - fixed to match your data structure
    const studentsInClass = Object.entries(admissions).filter(([id, admission]) => {
        return admission.classId === classId || 
               admission.class === classId || 
               (admission.courseCode && classData.courseCode && admission.courseCode === classData.courseCode);
    });
    
    const studentList = document.getElementById('classStudentsList');
    
    if (studentsInClass.length === 0) {
        studentList.innerHTML = '<div class="empty-state"><i class="fas fa-user-graduate"></i><p>No students enrolled in this class yet.</p></div>';
        return;
    }
    
    let studentsHTML = '';
    
    studentsInClass.forEach(([id, admission]) => {
        const admissionNo = admission.admNo || 'N/A';
        const studentName = admission.fullName || 'Unknown';
        const courseName = admission.courseName || 'N/A';
        
        studentsHTML += `
            <div class="student-item">
                <div class="student-info">
                    <div class="student-name">${studentName}</div>
                    <div class="student-details">
                        ${admissionNo} | ${courseName}
                    </div>
                </div>
                <span class="status-badge enrolled">Enrolled</span>
            </div>
        `;
    });
    
    studentList.innerHTML = studentsHTML;
}

// Update dashboard cards with unit information
function updateDashboardCards() {
    // Total students in all classes
    const totalStudents = Object.keys(admissions).length;
    document.getElementById('totalStudents').textContent = totalStudents;
    
    // Total units assigned to me
    const myUnits = Object.keys(units).length;
    document.getElementById('totalUnits').textContent = myUnits;
    
    // Active exams
    const activeExams = Object.values(exams).filter(exam => 
        exam.status === 'Active' || exam.status === 'Scheduled'
    ).length;
    document.getElementById('activeExams').textContent = activeExams;
    
    // Pending results (exams without results)
    const pendingResults = Object.keys(exams).length - Object.keys(results).length;
    document.getElementById('pendingResults').textContent = pendingResults > 0 ? pendingResults : 0;
}

// Update student dropdowns - FIXED to use your data structure
function updateStudentSelects() {
    const studentSelects = [
        document.getElementById('studentSelect'),
        document.getElementById('uploadStudent')
    ];
    
    studentSelects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Student --</option>';
            
            Object.entries(admissions).forEach(([id, admission]) => {
                const option = document.createElement('option');
                option.value = id;
                
                const admissionNo = admission.admNo || 'N/A';
                const studentName = admission.fullName || 'Unknown Student';
                const courseName = admission.courseName || 'No Course';
                const level = admission.courseLevel || 'N/A';
                
                option.textContent = `${admissionNo} - ${studentName}`;
                option.setAttribute('data-admno', admissionNo);
                option.setAttribute('data-course', courseName);
                option.setAttribute('data-level', level);
                
                select.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue && admissions[currentValue]) {
                select.value = currentValue;
            }
        }
    });
}

// Update unit dropdowns
function updateUnitSelects() {
    const unitSelects = [
        document.getElementById('examUnitFilter'),
        document.getElementById('resultUnitFilter'),
        document.getElementById('reportUnit'),
        document.getElementById('uploadUnit'),
        document.getElementById('examUnit'),
        document.getElementById('bulkUploadUnit')
    ];
    
    unitSelects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Units</option>';
            
            Object.entries(units).forEach(([id, unit]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${unit.unitCode} - ${unit.unitName}`;
                select.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue && units[currentValue]) {
                select.value = currentValue;
            }
        }
    });
}

// Update class dropdowns - FIXED to use your data structure
function updateClassSelects() {
    const classSelects = [
        document.getElementById('unitClass'),
        document.getElementById('examClass'),
        document.getElementById('reportClass')
    ];
    
    classSelects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Class --</option>';
            
            Object.entries(classes).forEach(([id, classData]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = classData.className || `Class ${id}`;
                select.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue && classes[currentValue]) {
                select.value = currentValue;
            }
        }
    });
}

// Update course dropdowns
function updateCourseSelects() {
    const courseSelects = [
        document.getElementById('unitCourse'),
        document.getElementById('reportCourse'),
        document.getElementById('editUnitCourse')
    ];
    
    courseSelects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Course --</option>';
            
            Object.entries(courses).forEach(([id, course]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = course.courseName || 'Unknown Course';
                select.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue && courses[currentValue]) {
                select.value = currentValue;
            }
        }
    });
}

// Render units table - FIXED to properly display data
function renderUnitsTable() {
    const tbody = document.getElementById('unitsTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(units).length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="8" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                    <i class="fas fa-layer-group"></i>
                    <h4>No Units Assigned</h4>
                    <p>Start by assigning your first unit to a class</p>
                    <button class="btn-purple" onclick="openUnitModal()" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> Assign Unit
                    </button>
                </div>
            </td></tr>
        `;
        return;
    }
    
    Object.entries(units).forEach(([id, unit]) => {
        const classData = classes[unit.classId];
        const courseData = courses[unit.courseId];
        
        // Count students in this unit's class
        const studentCount = Object.values(admissions).filter(admission => {
            return admission.classId === unit.classId || 
                   admission.class === unit.classId ||
                   (admission.courseCode && classData?.courseCode && admission.courseCode === classData.courseCode);
        }).length;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${unit.unitCode || 'N/A'}</strong></td>
            <td>${unit.unitName || 'Unnamed Unit'}</td>
            <td>${courseData?.courseName || unit.courseName || 'N/A'}</td>
            <td>${unit.semester || '1'}</td>
            <td>${unit.credits || '3'}</td>
            <td>${classData?.className || unit.className || 'N/A'}</td>
            <td><span class="status-badge enrolled">${studentCount}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="editUnit('${id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn-danger" onclick="deleteUnit('${id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Render exams table
function renderExamsTable() {
    const tbody = document.getElementById('examsTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(exams).length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No exams found. Create your first exam.</td></tr>';
        return;
    }
    
    Object.entries(exams).forEach(([id, exam]) => {
        const unitData = units[exam.unitId];
        const classData = classes[exam.classId];
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${exam.examId || id}</strong></td>
            <td>${exam.examName}</td>
            <td>${unitData?.unitName || exam.unitName || 'N/A'}</td>
            <td>${classData?.className || exam.className || 'N/A'}</td>
            <td>${exam.examType}</td>
            <td>${exam.examDate}</td>
            <td><span class="status-badge ${exam.status === 'Active' ? 'active' : 'inactive'}">${exam.status || 'Scheduled'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="editExam('${id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-warning" onclick="toggleExamStatus('${id}')">
                        <i class="fas ${exam.status === 'Active' ? 'fa-pause' : 'fa-play'}"></i>
                    </button>
                    <button class="btn-danger" onclick="deleteExam('${id}')"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Render recent exams table
function renderRecentExamsTable() {
    const tbody = document.getElementById('recentExamsTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(exams).length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No exams found</td></tr>';
        return;
    }
    
    // Show only recent 5 exams
    const recentExams = Object.entries(exams)
        .sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0))
        .slice(0, 5);
    
    recentExams.forEach(([id, exam]) => {
        const unitData = units[exam.unitId];
        const classData = classes[exam.classId];
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${exam.examId || id}</strong></td>
            <td>${exam.examName}</td>
            <td>${unitData?.unitName || exam.unitName || 'N/A'}</td>
            <td>${exam.examDate}</td>
            <td>${classData?.className || exam.className || 'N/A'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="editExam('${id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-danger" onclick="deleteExam('${id}')"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Render results table - FIXED to show proper student information
function renderResultsTable() {
    const tbody = document.getElementById('resultsTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(results).length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="9" style="text-align: center; padding: 40px;">
                <div class="empty-state">
                    <i class="fas fa-upload"></i>
                    <h4>No Results Uploaded</h4>
                    <p>Upload results to see them here</p>
                    <button class="btn-success" onclick="openUploadModal()" style="margin-top: 15px;">
                        <i class="fas fa-upload"></i> Upload Results
                    </button>
                </div>
            </td></tr>
        `;
        return;
    }
    
    Object.entries(results).forEach(([id, result]) => {
        // Find the admission record
        let admission = null;
        let admissionId = null;
        
        // Try to find by studentId
        if (result.studentId && admissions[result.studentId]) {
            admission = admissions[result.studentId];
            admissionId = result.studentId;
        }
        
        // If not found, search by admission number
        if (!admission && result.studentAdmNo) {
            Object.entries(admissions).forEach(([admId, adm]) => {
                if (adm.admNo === result.studentAdmNo) {
                    admission = adm;
                    admissionId = admId;
                }
            });
        }
        
        const exam = exams[result.examId] || {};
        const unit = units[exam.unitId] || {};
        const classData = classes[exam.classId] || {};
        const grade = result.grade || calculateGrade(result.marks);
        
        // Use the actual data from admissions if found, otherwise use what's in result
        const admissionNo = admission?.admNo || result.studentAdmNo || result.studentId || 'N/A';
        const studentName = admission?.fullName || result.studentName || 'Unknown Student';
        const unitName = unit.unitName || exam.unitName || 'Unknown Unit';
        const className = classData.className || exam.className || 'Unknown Class';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${admissionNo}</strong></td>
            <td>${studentName}</td>
            <td>${unitName}</td>
            <td>${className}</td>
            <td>${exam.examName || 'Unknown Exam'}</td>
            <td><strong>${result.marks}/${exam.maxMarks || 100}</strong></td>
            <td><span class="status-badge ${grade === 'FAIL' ? 'inactive' : 'active'}">${grade}</span></td>
            <td><span class="status-badge ${result.status === 'Published' ? 'active' : 'pending'}">${result.status || 'Pending'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="editResult('${id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-warning" onclick="toggleResultStatus('${id}')">
                        <i class="fas ${result.status === 'Published' ? 'fa-eye-slash' : 'fa-eye'}"></i>
                    </button>
                    <button class="btn-danger" onclick="deleteResult('${id}')"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Calculate grade based on marks
function calculateGrade(marks) {
    const maxMarks = 100; // Assuming 100 as max for grading calculation
    const percentage = (marks / maxMarks) * 100;
    
    for (const grade of gradingScale) {
        if (percentage >= grade.min && percentage <= grade.max) {
            return grade.grade;
        }
    }
    return 'FAIL';
}

// Update grade based on marks input
function updateGrade() {
    const marks = parseInt(document.getElementById('uploadMarks').value) || 0;
    const grade = calculateGrade(marks);
    document.getElementById('uploadGrade').value = grade;
}

// Calculate grade points
function calculateGradePoints(grade) {
    for (const g of gradingScale) {
        if (g.grade === grade) {
            return g.points;
        }
    }
    return 0.0;
}

// Unit modal functions
function openUnitModal() {
    updateClassSelects();
    updateCourseSelects();
    document.getElementById('unitModal').style.display = 'flex';
}

function closeUnitModal() {
    document.getElementById('unitModal').style.display = 'none';
    document.getElementById('unitForm').reset();
}

// Handle unit form submission
function handleUnitSubmit(e) {
    e.preventDefault();
    
    const courseId = document.getElementById('unitCourse').value;
    const courseData = courses[courseId];
    const classId = document.getElementById('unitClass').value;
    const classData = classes[classId];
    
    const unitData = {
        unitCode: document.getElementById('unitCode').value,
        unitName: document.getElementById('unitName').value,
        courseId: courseId,
        courseName: courseData?.courseName || 'Unknown',
        courseCode: courseData?.courseCode || '',
        semester: document.getElementById('unitSemester').value,
        classId: classId,
        className: classData?.className || 'Unknown',
        credits: document.getElementById('unitCredits').value,
        description: document.getElementById('unitDescription').value,
        assignedTo: 'exam_officer_001',
        assignedAt: new Date().toISOString(),
        status: 'Active'
    };
    
    // Generate unit ID
    const unitId = 'UNT' + Date.now();
    
    // Save to Firebase
    db.ref('units/' + unitId).set(unitData)
        .then(() => {
            showSuccessMessage(`Unit "${unitData.unitName}" assigned successfully!`);
            closeUnitModal();
            logAudit('ASSIGN_UNIT', `Assigned unit: ${unitData.unitName} to class: ${unitData.className}`);
            // Refresh units data
            loadData();
        })
        .catch(error => {
            alert('Error assigning unit: ' + error.message);
        });
}

// Edit unit modal
function openEditUnitModal(unitId) {
    const unit = units[unitId];
    if (!unit) return;
    
    document.getElementById('editUnitId').value = unitId;
    document.getElementById('editUnitCode').value = unit.unitCode || '';
    document.getElementById('editUnitName').value = unit.unitName || '';
    document.getElementById('editUnitCredits').value = unit.credits || 3;
    document.getElementById('editUnitDescription').value = unit.description || '';
    
    // Set course
    const courseSelect = document.getElementById('editUnitCourse');
    courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
    Object.entries(courses).forEach(([id, course]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = course.courseName;
        if (id === unit.courseId) option.selected = true;
        courseSelect.appendChild(option);
    });
    
    // Set class
    const classSelect = document.getElementById('editUnitClass');
    classSelect.innerHTML = '<option value="">-- Select Class --</option>';
    Object.entries(classes).forEach(([id, classData]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = classData.className;
        if (id === unit.classId) option.selected = true;
        classSelect.appendChild(option);
    });
    
    // Set semester
    const semesterSelect = document.getElementById('editUnitSemester');
    semesterSelect.value = unit.semester || '1';
    
    document.getElementById('editUnitModal').style.display = 'flex';
}

function closeEditUnitModal() {
    document.getElementById('editUnitModal').style.display = 'none';
    document.getElementById('editUnitForm').reset();
}

function handleEditUnitSubmit(e) {
    e.preventDefault();
    
    const unitId = document.getElementById('editUnitId').value;
    const unit = units[unitId];
    if (!unit) return;
    
    const courseId = document.getElementById('editUnitCourse').value;
    const courseData = courses[courseId];
    const classId = document.getElementById('editUnitClass').value;
    const classData = classes[classId];
    
    const updatedUnitData = {
        ...unit,
        unitCode: document.getElementById('editUnitCode').value,
        unitName: document.getElementById('editUnitName').value,
        courseId: courseId,
        courseName: courseData?.courseName || 'Unknown',
        courseCode: courseData?.courseCode || '',
        semester: document.getElementById('editUnitSemester').value,
        classId: classId,
        className: classData?.className || 'Unknown',
        credits: document.getElementById('editUnitCredits').value,
        description: document.getElementById('editUnitDescription').value,
        updatedAt: new Date().toISOString()
    };
    
    // Update in Firebase
    db.ref('units/' + unitId).update(updatedUnitData)
        .then(() => {
            showSuccessMessage(`Unit "${updatedUnitData.unitName}" updated successfully!`);
            closeEditUnitModal();
            logAudit('UPDATE_UNIT', `Updated unit: ${updatedUnitData.unitName}`);
            loadData();
        })
        .catch(error => {
            alert('Error updating unit: ' + error.message);
        });
}

// Exam modal functions
function openExamModal() {
    updateUnitSelects();
    updateClassSelects();
    document.getElementById('examModal').style.display = 'flex';
}

function closeExamModal() {
    document.getElementById('examModal').style.display = 'none';
    document.getElementById('examForm').reset();
}

// Handle exam form submission
function handleExamSubmit(e) {
    e.preventDefault();
    
    const unitId = document.getElementById('examUnit').value;
    const unitData = units[unitId];
    const classId = document.getElementById('examClass').value;
    const classData = classes[classId];
    
    const examData = {
        examName: document.getElementById('examName').value,
        unitId: unitId,
        unitName: unitData?.unitName || 'Unknown',
        unitCode: unitData?.unitCode || '',
        classId: classId,
        className: classData?.className || 'Unknown',
        examType: document.getElementById('examType').value,
        examDate: document.getElementById('examDate').value,
        maxMarks: document.getElementById('examMaxMarks').value,
        description: document.getElementById('examDescription').value,
        status: 'Scheduled',
        createdAt: new Date().toISOString(),
        createdBy: 'exam_officer'
    };
    
    // Generate exam ID
    const examId = 'EXM' + Date.now();
    examData.examId = examId;
    
    // Save to Firebase
    db.ref('exams/' + examId).set(examData)
        .then(() => {
            showSuccessMessage(`Exam "${examData.examName}" created successfully!`);
            closeExamModal();
            logAudit('CREATE_EXAM', `Created exam: ${examData.examName} for unit: ${examData.unitName}`);
            loadData();
        })
        .catch(error => {
            alert('Error creating exam: ' + error.message);
        });
}

// Upload modal functions - FIXED: Now shows all exams and students regardless of unit selection
function openUploadModal() {
    updateUnitSelects();
    // Load all exams and students initially
    updateAllExams();
    updateAllStudents();
    document.getElementById('uploadModal').style.display = 'flex';
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
    document.getElementById('uploadForm').reset();
    document.getElementById('uploadGrade').value = '';
    document.getElementById('manualEntryFields').style.display = 'none';
}

// Update all exams in the dropdown
function updateAllExams() {
    const examSelect = document.getElementById('uploadExam');
    examSelect.innerHTML = '<option value="">-- Select Exam --</option>';
    
    Object.entries(exams).forEach(([id, exam]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${exam.examName} - ${exam.unitName || 'Unknown Unit'}`;
        examSelect.appendChild(option);
    });
}

// Update all students in the dropdown
function updateAllStudents() {
    const studentSelect = document.getElementById('uploadStudent');
    const currentValue = studentSelect.value;
    studentSelect.innerHTML = '<option value="">-- Select Student --</option><option value="manual_entry">-- Or Enter Manually --</option>';
    
    Object.entries(admissions).forEach(([id, admission]) => {
        const option = document.createElement('option');
        option.value = id;
        
        const admissionNo = admission.admNo || 'N/A';
        const studentName = admission.fullName || 'Unknown';
        
        option.textContent = `${admissionNo} - ${studentName}`;
        studentSelect.appendChild(option);
    });
    
    // Restore selection if still valid
    if (currentValue && (currentValue === 'manual_entry' || admissions[currentValue])) {
        studentSelect.value = currentValue;
    }
}

// Handle result upload - FIXED to handle both dropdown and manual entry
function handleResultUpload(e) {
    e.preventDefault();
    
    const examId = document.getElementById('uploadExam').value;
    const studentSelect = document.getElementById('uploadStudent');
    const studentValue = studentSelect.value;
    const marks = parseInt(document.getElementById('uploadMarks').value);
    const remarks = document.getElementById('uploadRemarks').value;
    
    const exam = exams[examId];
    if (!exam) {
        alert('Please select a valid exam');
        return;
    }
    
    if (marks < 0 || marks > (exam.maxMarks || 200)) {
        alert(`Marks must be between 0 and ${exam.maxMarks || 200}`);
        return;
    }
    
    let resultData = {};
    let studentAdmNo = '';
    let studentName = '';
    let firebaseStudentId = '';
    
    if (studentValue === 'manual_entry') {
        // Manual entry
        studentAdmNo = document.getElementById('manualAdmissionNo').value.trim();
        studentName = document.getElementById('manualStudentName').value.trim();
        
        if (!studentAdmNo || !studentName) {
            alert('Please enter both Admission Number and Student Name for manual entry');
            return;
        }
        
        // For manual entry, we'll use admission number as ID
        firebaseStudentId = studentAdmNo;
    } else {
        // Dropdown selection
        const admission = admissions[studentValue];
        if (!admission) {
            alert('Please select a valid student');
            return;
        }
        studentAdmNo = admission.admNo || studentValue;
        studentName = admission.fullName || 'Unknown';
        firebaseStudentId = studentValue;
    }
    
    resultData = {
        examId: examId,
        studentId: firebaseStudentId,
        studentAdmNo: studentAdmNo,
        studentName: studentName,
        marks: marks,
        grade: calculateGrade(marks),
        remarks: remarks,
        status: 'Pending',
        uploadedAt: new Date().toISOString(),
        uploadedBy: 'exam_officer'
    };
    
    // Generate result ID
    const resultId = 'RES' + Date.now();
    
    // Save to Firebase
    db.ref('results/' + resultId).set(resultData)
        .then(() => {
            showSuccessMessage(`Result for ${studentName} uploaded successfully!`);
            closeUploadModal();
            logAudit('UPLOAD_RESULT', `Uploaded result for student: ${studentName}, Exam: ${exam.examName}`);
            loadData();
        })
        .catch(error => {
            alert('Error uploading result: ' + error.message);
        });
}

// Filter exams by unit
function filterExamsByUnit() {
    const unitId = document.getElementById('examUnitFilter').value;
    const rows = document.querySelectorAll('#examsTableBody tr');
    
    rows.forEach(row => {
        if (!unitId) {
            row.style.display = '';
            return;
        }
        
        const unitCell = row.cells[2];
        const unitName = unitCell.textContent;
        const unitData = units[unitId];
        const shouldShow = unitName.includes(unitData?.unitCode) || unitName.includes(unitData?.unitName);
        
        row.style.display = shouldShow ? '' : 'none';
    });
}

// Filter results by unit
function filterResultsByUnit() {
    const unitId = document.getElementById('resultUnitFilter').value;
    const rows = document.querySelectorAll('#resultsTableBody tr');
    
    rows.forEach(row => {
        if (!unitId) {
            row.style.display = '';
            return;
        }
        
        const unitCell = row.cells[2];
        const unitName = unitCell.textContent;
        const unitData = units[unitId];
        const shouldShow = unitName.includes(unitData?.unitCode) || unitName.includes(unitData?.unitName);
        
        row.style.display = shouldShow ? '' : 'none';
    });
}

// Unit management functions
function editUnit(unitId) {
    openEditUnitModal(unitId);
}

function deleteUnit(unitId) {
    const unit = units[unitId];
    if (!unit) return;
    
    if (confirm(`Are you sure you want to delete the unit "${unit.unitName}"? This action cannot be undone.`)) {
        // Save for undo
        lastDeletedItem = { ...unit, id: unitId };
        lastDeletedType = 'unit';
        lastDeletedId = unitId;
        
        db.ref('units/' + unitId).remove()
            .then(() => {
                showUndoNotification(`Unit "${unit.unitName}" deleted`, `You can undo this action within 30 seconds.`);
                logAudit('DELETE_UNIT', `Deleted unit: ${unit.unitName}`);
                loadData();
            })
            .catch(error => {
                alert('Error deleting unit: ' + error.message);
                lastDeletedItem = null;
                lastDeletedType = null;
            });
    }
}

// Existing exam functions
function editExam(examId) {
    alert(`Edit exam ${examId} - This would open the exam form with pre-filled data`);
}

function toggleExamStatus(examId) {
    const exam = exams[examId];
    if (!exam) return;
    
    const newStatus = exam.status === 'Active' ? 'Inactive' : 'Active';
    
    db.ref('exams/' + examId).update({ status: newStatus })
        .then(() => {
            showSuccessMessage(`Exam ${newStatus.toLowerCase()} successfully`);
            logAudit('TOGGLE_EXAM_STATUS', `Changed status of exam ${exam.examName} to ${newStatus}`);
            loadData();
        })
        .catch(error => alert('Error updating exam status: ' + error.message));
}

function deleteExam(examId) {
    const exam = exams[examId];
    if (!exam) return;
    
    if (confirm(`Are you sure you want to delete the exam "${exam.examName}"? This action cannot be undone.`)) {
        // Save for undo
        lastDeletedItem = { ...exam, id: examId };
        lastDeletedType = 'exam';
        lastDeletedId = examId;
        
        db.ref('exams/' + examId).remove()
            .then(() => {
                showUndoNotification(`Exam "${exam.examName}" deleted`, `You can undo this action within 30 seconds.`);
                logAudit('DELETE_EXAM', `Deleted exam: ${exam.examName}`);
                loadData();
            })
            .catch(error => {
                alert('Error deleting exam: ' + error.message);
                lastDeletedItem = null;
                lastDeletedType = null;
            });
    }
}

// Existing result functions
function editResult(resultId) {
    alert(`Edit result ${resultId} - This would open the result form with pre-filled data`);
}

function toggleResultStatus(resultId) {
    const result = results[resultId];
    if (!result) return;
    
    const newStatus = result.status === 'Published' ? 'Pending' : 'Published';
    
    db.ref('results/' + resultId).update({ status: newStatus })
        .then(() => {
            showSuccessMessage(`Result ${newStatus.toLowerCase()} successfully`);
            logAudit('TOGGLE_RESULT_STATUS', `Changed status of result to ${newStatus}`);
            loadData();
        })
        .catch(error => alert('Error updating result status: ' + error.message));
}

function deleteResult(resultId) {
    const result = results[resultId];
    if (!result) return;
    
    if (confirm('Are you sure you want to delete this result? This action cannot be undone.')) {
        // Save for undo
        lastDeletedItem = { ...result, id: resultId };
        lastDeletedType = 'result';
        lastDeletedId = resultId;
        
        db.ref('results/' + resultId).remove()
            .then(() => {
                showUndoNotification('Result deleted', 'You can undo this action within 30 seconds.');
                logAudit('DELETE_RESULT', 'Deleted a result record');
                loadData();
            })
            .catch(error => {
                alert('Error deleting result: ' + error.message);
                lastDeletedItem = null;
                lastDeletedType = null;
            });
    }
}

// Undo functionality
function showUndoNotification(title, message) {
    document.getElementById('undoMessage').textContent = title;
    document.getElementById('undoNotification').classList.add('show');
    
    // Auto-hide after 30 seconds
    setTimeout(() => {
        if (document.getElementById('undoNotification').classList.contains('show')) {
            closeUndoNotification();
        }
    }, 30000);
}

function closeUndoNotification() {
    document.getElementById('undoNotification').classList.remove('show');
    lastDeletedItem = null;
    lastDeletedType = null;
    lastDeletedId = null;
}

function undoLastDelete() {
    if (!lastDeletedItem || !lastDeletedType || !lastDeletedId) {
        alert('Nothing to undo');
        return;
    }
    
    const item = lastDeletedItem;
    const type = lastDeletedType;
    const id = lastDeletedId;
    
    // Restore the item
    db.ref(`${type}s/${id}`).set(item)
        .then(() => {
            showSuccessMessage(`${type.charAt(0).toUpperCase() + type.slice(1)} restored successfully!`);
            closeUndoNotification();
            logAudit('UNDO_DELETE', `Restored ${type}: ${item.name || item.unitName || item.examName || 'Unknown'}`);
            loadData();
        })
        .catch(error => {
            alert('Error restoring item: ' + error.message);
        });
}

// Show success message
function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    document.getElementById('successMessageText').textContent = message;
    successMsg.classList.add('show');
    
    setTimeout(() => {
        successMsg.classList.remove('show');
    }, 5000);
}

// Bulk Upload Functions
function openBulkUploadModal() {
    updateUnitSelects();
    document.getElementById('bulkUploadModal').style.display = 'flex';
}

function closeBulkUploadModal() {
    document.getElementById('bulkUploadModal').style.display = 'none';
    document.getElementById('bulkUploadFile').value = '';
    document.getElementById('bulkUploadPreview').style.display = 'none';
}

function downloadCSVTemplate() {
    const csvContent = "data:text/csv;charset=utf-8,AdmissionNo,StudentName,Marks,Remarks\nSTD001,John Doe,85,Good performance\nSTD002,Jane Smith,72,\nSTD003,Robert Johnson,45,Needs improvement";
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "results_template.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function previewCSVFile(file) {
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const contents = e.target.result;
        const rows = contents.split('\n');
        const previewBody = document.getElementById('bulkPreviewTableBody');
        previewBody.innerHTML = '';
        
        // Show first 5 rows (excluding header)
        for (let i = 1; i < Math.min(6, rows.length); i++) {
            if (rows[i].trim()) {
                const cells = rows[i].split(',');
                const tr = document.createElement('tr');
                cells.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                previewBody.appendChild(tr);
            }
        }
        
        document.getElementById('bulkUploadPreview').style.display = 'block';
    };
    reader.readAsText(file);
}

function processBulkUpload() {
    const fileInput = document.getElementById('bulkUploadFile');
    const unitId = document.getElementById('bulkUploadUnit').value;
    const examId = document.getElementById('bulkUploadExam').value;
    
    if (!unitId || !examId || !fileInput.files[0]) {
        alert('Please select unit, exam, and CSV file');
        return;
    }
    
    const exam = exams[examId];
    if (!exam) {
        alert('Invalid exam selected');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const contents = e.target.result;
        const rows = contents.split('\n');
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        // Skip header row
        for (let i = 1; i < rows.length; i++) {
            if (rows[i].trim()) {
                const cells = rows[i].split(',');
                if (cells.length >= 3) {
                    const admissionNo = cells[0].trim();
                    const studentName = cells[1].trim();
                    const marks = parseInt(cells[2].trim());
                    const remarks = cells[3] ? cells[3].trim() : '';
                    
                    if (!admissionNo || !studentName || isNaN(marks)) {
                        errors.push(`Row ${i}: Invalid data format`);
                        errorCount++;
                        continue;
                    }
                    
                    const resultData = {
                        examId: examId,
                        studentId: admissionNo,
                        studentAdmNo: admissionNo,
                        studentName: studentName,
                        marks: marks,
                        grade: calculateGrade(marks),
                        remarks: remarks,
                        status: 'Pending',
                        uploadedAt: new Date().toISOString(),
                        uploadedBy: 'exam_officer_bulk'
                    };
                    
                    const resultId = 'RES' + Date.now() + '_' + i;
                    
                    // Save to Firebase
                    db.ref('results/' + resultId).set(resultData)
                        .then(() => {
                            successCount++;
                        })
                        .catch(error => {
                            errors.push(`Row ${i}: ${error.message}`);
                            errorCount++;
                        });
                }
            }
        }
        
        // Wait a moment for all Firebase operations
        setTimeout(() => {
            let message = `Bulk upload completed. Success: ${successCount}, Errors: ${errorCount}`;
            if (errors.length > 0) {
                message += '\n\nErrors:\n' + errors.join('\n');
            }
            alert(message);
            closeBulkUploadModal();
            loadData();
        }, 2000);
    };
    reader.readAsText(fileInput.files[0]);
}

// Audit logging
function logAudit(action, details) {
    const logId = 'LOG' + Date.now();
    const logData = {
        action: action,
        details: details,
        timestamp: new Date().toISOString(),
        user: 'exam_officer',
        userRole: 'Exam Officer'
    };
    
    db.ref('auditLogs/' + logId).set(logData)
        .catch(error => console.error('Error logging audit:', error));
}

// Initialize the application
window.onload = function() {
    // Set default dates
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(today.getDate() + 7);
    document.getElementById('examDate').valueAsDate = nextWeek;
};

// Placeholder for other functions
function generateTranscriptPreview(studentId) {
    // Implementation for transcript preview
}

function generateTranscript() {
    // Implementation for transcript generation
}

function generatePerformanceReport() {
    // Implementation for performance report
}

function generateGradeDistribution() {
    // Implementation for grade distribution
}

function saveSettings() {
    // Implementation for saving settings
}
</script>
</body>
</html>