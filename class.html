<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel ‚Äî JNNP</title>
<style>
:root {
  --primary-color: #51abc7;
  --secondary-color: #5097c0;
  --accent-color: #0077b6;
  --light-bg: #f9f9f9;
  --dark-bg: #121212;
  --card-bg: #fff;
  --dark-card-bg: #1e1e1e;
  --text-light: #333;
  --text-dark: #fff;
  --sidebar-width: 250px;
  --header-height: 70px;
}

* {
  box-sizing: border-box;
  transition: background 0.3s, color 0.3s;
}

body {
  font-family: Georgia, 'Times New Roman', Times, serif;
  background: var(--light-bg);
  margin: 0;
  padding: 0;
  color: var(--text-light);
  display: flex;
  min-height: 100vh;
}

/* Sidebar Styles */
.sidebar {
  width: var(--sidebar-width);
  background: var(--primary-color);
  color: white;
  height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  overflow-y: auto;
  z-index: 100;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}

.sidebar-header {
  padding: 20px;
  text-align: center;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.sidebar-header h2 {
  margin: 0;
  font-size: 1.5rem;
}

.sidebar-menu {
  list-style: none;
  padding: 0;
  margin: 20px 0;
}

.sidebar-menu li {
  padding: 0;
}

.sidebar-menu a {
  display: block;
  padding: 15px 20px;
  color: white;
  text-decoration: none;
  border-left: 4px solid transparent;
}

.sidebar-menu a:hover, .sidebar-menu a.active {
  background: rgba(255,255,255,0.1);
  border-left: 4px solid var(--secondary-color);
}

.sidebar-menu i {
  margin-right: 10px;
}

/* Main Content Styles */
.main-content {
  flex: 1;
  margin-left: var(--sidebar-width);
  padding: 20px;
  width: calc(100% - var(--sidebar-width));
}

.header {
  background: var(--card-bg);
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header h1 {
  margin: 0;
  color: var(--primary-color);
}

.header-controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

/* Card Styles */
.card {
  background: var(--card-bg);
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  margin-bottom: 30px;
  overflow: hidden;
}

.card-header {
  padding: 15px 20px;
  background: var(--secondary-color);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-body {
  padding: 0;
  overflow-x: auto;
}

/* Table Styles */
table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  border: 1px solid #ddd;
  text-align: left;
  white-space: nowrap;
}

th {
  background: var(--secondary-color);
  color: #fff;
}

tr:nth-child(even) {
  background: #f2f2f2;
}

/* Button Styles */
.btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin-right: 6px;
  transition: transform 0.2s, opacity 0.2s;
}

.btn:hover {
  transform: scale(1.05);
  opacity: 0.85;
}

.approve { background: #28a745; color: #fff; }
.pending { background: #ffc107; color: #000; }
.save { background: #0077b6; color: #fff; }
.delete { background: #dc3545; color: #fff; }
.print { background: #6c757d; color: #fff; }
.export { background: #0077b6; color: #fff; }

.action-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: var(--card-bg);
  margin: 5% auto;
  padding: 20px;
  border-radius: 8px;
  width: 500px;
  position: relative;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-content h2 {
  margin-top: 0;
  color: var(--primary-color);
}

.modal-content label {
  display: block;
  margin: 8px 0 4px;
}

.modal-content input, .modal-content select {
  width: 100%;
  padding: 6px;
  margin-bottom: 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.modal-close {
  position: absolute;
  right: 10px;
  top: 10px;
  cursor: pointer;
  font-weight: bold;
  font-size: 18px;
}

/* Search and Dark Mode */
#searchInput {
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ccc;
}

#darkModeBtn {
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 4px;
  border: none;
  background: var(--accent-color);
  color: #fff;
  cursor: pointer;
}

#darkModeBtn:hover {
  opacity: 0.85;
}

/* Dark Mode Styles */
body.dark-mode {
  background: var(--dark-bg);
  color: var(--text-dark);
}

body.dark-mode .sidebar {
  background: #0a1a3a;
}

body.dark-mode .card, 
body.dark-mode .header,
body.dark-mode .modal-content {
  background: var(--dark-card-bg);
}

body.dark-mode table {
  background: var(--dark-card-bg);
  color: var(--text-dark);
}

body.dark-mode th {
  background: var(--accent-color);
  color: var(--text-dark);
}

body.dark-mode tr:nth-child(even) {
  background: #2c2c2c;
}

body.dark-mode .modal-content input, 
body.dark-mode .modal-content select {
  background: #2c2c2c;
  color: var(--text-dark);
  border: 1px solid #444;
}

/* Responsive Styles */
@media (max-width: 768px) {
  .sidebar {
    width: 70px;
  }
  
  .sidebar-header h2, .sidebar-menu span {
    display: none;
  }
  
  .sidebar-menu a {
    text-align: center;
    padding: 15px 10px;
  }
  
  .sidebar-menu i {
    margin-right: 0;
    font-size: 1.2rem;
  }
  
  .main-content {
    margin-left: 70px;
    width: calc(100% - 70px);
  }
  
  .header {
    flex-direction: column;
    gap: 10px;
  }
  
  .modal-content {
    width: 95%;
  }
}

/* Stats Cards */
.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  text-align: center;
}

.stat-card h3 {
  margin: 0 0 10px;
  font-size: 1.2rem;
  color: var(--primary-color);
}

.stat-card .number {
  font-size: 2rem;
  font-weight: bold;
  color: var(--secondary-color);
}

body.dark-mode .stat-card {
  background: var(--dark-card-bg);
}

/* Settings Panel Styles */
.settings-panel {
  display: none;
  background: var(--card-bg);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.settings-panel h2 {
  margin-top: 0;
  color: var(--primary-color);
}

.setting-item {
  margin-bottom: 20px;
}

.setting-item label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
}

.setting-item select, .setting-item input {
  width: 100%;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.reports-container {
  display: none;
  background: var(--card-bg);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 30px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.reports-container h2 {
  margin-top: 0;
  color: var(--primary-color);
}

.report-option {
  margin-bottom: 15px;
  padding: 15px;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  transition: background 0.3s;
}

.report-option:hover {
  background: #f5f5f5;
}

body.dark-mode .report-option:hover {
  background: #2c2c2c;
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <h2>JNNP Admin</h2>
  </div>
  <ul class="sidebar-menu">
    <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
    <li><a href="#applications"><i class="fas fa-file-alt"></i> <span>Applications</span></a></li>
    <li><a href="#admissions"><i class="fas fa-user-graduate"></i> <span>Admissions</span></a></li>
    <li><a href="#courses"><i class="fas fa-book"></i> <span>Courses</span></a></li>
    <li><a href="#reports"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
    <li><a href="#settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
  </ul>
</div>

<!-- Main Content -->
<div class="main-content">
  <div class="header">
    <h1>Registra Dashboard</h1>
    <div class="header-controls">
      <input type="text" id="searchInput" placeholder="Search table...">
      <button id="darkModeBtn">Toggle Dark/Light</button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-container">
    <div class="stat-card">
      <h3>Total Applications</h3>
      <div class="number" id="totalApplications">0</div>
    </div>
    <div class="stat-card">
      <h3>Admitted Students</h3>
      <div class="number" id="totalAdmissions">0</div>
    </div>
    <div class="stat-card">
      <h3>Pending Applications</h3>
      <div class="number" id="pendingApplications">0</div>
    </div>
    <div class="stat-card">
      <h3>Courses Available</h3>
      <div class="number" id="totalCourses">0</div>
    </div>
  </div>

  <!-- Applications Card -->
  <div class="card" id="applications">
    <div class="card-header">
      <h2><i class="fas fa-file-alt"></i> Student Applications</h2>
    </div>
    <div class="card-body">
      <table id="applicationsTable">
        <thead>
          <tr>
            <th>Full Name</th><th>Email</th><th>Phone</th><th>Course</th><th>Level</th><th>Duration</th><th>Exam Body</th><th>Fee</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Admissions Card -->
  <div class="card" id="admissions">
    <div class="card-header">
      <h2><i class="fas fa-user-graduate"></i> Admitted Students</h2>
      <div>
        <button class="btn save" onclick="openAddModal()">‚ûï Add Student</button>
        <button class="btn print" onclick="window.print()">üñ®Ô∏è Print</button>
        <button class="btn export" onclick="exportPDF()">üìÑ Export PDF</button>
      </div>
    </div>
    <div class="card-body">
      <table id="admissionsTable">
        <thead>
          <tr>
            <th>Admission No</th><th>Full Name</th><th>Email</th><th>Phone</th><th>Course</th><th>Course Code</th><th>Level</th><th>Duration</th><th>Exam Body</th><th>Fee</th><th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Reports Section -->
  <div class="reports-container" id="reports">
    <h2><i class="fas fa-chart-bar"></i> Reports</h2>
    <div class="report-option" onclick="generateReport('applications')">
      <h3>Applications Report</h3>
      <p>Generate a detailed report of all student applications</p>
    </div>
    <div class="report-option" onclick="generateReport('admissions')">
      <h3>Admissions Report</h3>
      <p>Generate a detailed report of all admitted students</p>
    </div>
    <div class="report-option" onclick="generateReport('courses')">
      <h3>Courses Report</h3>
      <p>Generate a detailed report of all available courses</p>
    </div>
    <div class="report-option" onclick="generateReport('performance')">
      <h3>Performance Report</h3>
      <p>Generate a performance analysis report</p>
    </div>
  </div>

  <!-- Settings Section -->
  <div class="settings-panel" id="settings">
    <h2><i class="fas fa-cog"></i> Settings</h2>
    <div class="setting-item">
      <label for="themeSetting">Theme</label>
      <select id="themeSetting">
        <option value="light">Light Mode</option>
        <option value="dark">Dark Mode</option>
        <option value="auto">Auto (System Preference)</option>
      </select>
    </div>
    <div class="setting-item">
      <label for="languageSetting">Language</label>
      <select id="languageSetting">
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="sw">Swahili</option>
      </select>
    </div>
    <div class="setting-item">
      <label for="notificationsSetting">Notifications</label>
      <select id="notificationsSetting">
        <option value="enabled">Enabled</option>
        <option value="disabled">Disabled</option>
      </select>
    </div>
    <div class="setting-item">
      <label for="autoSaveSetting">Auto Save</label>
      <select id="autoSaveSetting">
        <option value="enabled">Enabled</option>
        <option value="disabled">Disabled</option>
      </select>
    </div>
    <div class="setting-item">
      <button class="btn save" onclick="saveSettings()">Save Settings</button>
      <button class="btn" onclick="resetSettings()">Reset to Default</button>
    </div>
  </div>
</div>

<!-- Add Student Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeAddModal()">&times;</span>
    <h2>Add New Student</h2>
    <form id="addForm">
      <label>Full Name:</label><input type="text" id="addFullName" required>
      <label>Email:</label><input type="email" id="addEmail" required>
      <label>Phone:</label><input type="text" id="addPhone" required>
      <label>Date of Birth:</label><input type="date" id="addDOB" required>
      <label>Gender:</label>
      <select id="addGender" required>
        <option value="">--Select--</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>
      <label>Course Selection:</label>
      <select id="addCourse" required onchange="populateCourseDetails()">
        <option value="">--Select Course--</option>
      </select>
      <label>Previous School:</label><input type="text" id="addPrevSchool">
      <label>KCPE Marks:</label><input type="number" id="addKCPE" min="0" max="500">
      <label>KCPE Year:</label><input type="number" id="addKCPEYear" min="1900" max="2100">
      <label>KCSE Grade:</label><input type="text" id="addKCSEGrade">
      <label>KCSE Year:</label><input type="number" id="addKCSEYear" min="1900" max="2100">
      <label>Parent Name:</label><input type="text" id="addParentName">
      <label>Parent Phone:</label><input type="text" id="addParentPhone">
      <label>Relationship:</label><input type="text" id="addRelationship">
      <label>Marital Status:</label>
      <select id="addMarital">
        <option value="">--Select--</option>
        <option value="Single">Single</option>
        <option value="Married">Married</option>
        <option value="Divorced">Divorced</option>
        <option value="Widowed">Widowed</option>
      </select>
      <label>Sponsor (if any):</label><input type="text" id="addSponsor">
      <h4>Course Details (Auto-filled):</h4>
      <p>Course Code: <span id="courseCode"></span></p>
      <p>Level: <span id="courseLevel"></span></p>
      <p>Duration: <span id="courseDuration"></span></p>
      <p>Exam Body: <span id="examBody"></span></p>
      <p>Fee: <span id="courseFee"></span></p>
      <label>Status:</label>
      <select id="addStatus">
        <option value="Admitted">Admitted</option>
        <option value="Pending">Pending</option>
      </select>
      <button type="submit" class="btn save">Add Student</button>
    </form>
  </div>
</div>

<!-- Edit Student Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <h2>Edit Admitted Student</h2>
    <form id="editForm">
      <input type="hidden" id="editKey">
      <label>Full Name</label><input type="text" id="editFullName">
      <label>Email</label><input type="email" id="editEmail">
      <label>Phone</label><input type="text" id="editPhone">
      <label>Course</label><input type="text" id="editCourseName">
      <label>Course Code</label><input type="text" id="editCourseCode">
      <label>Level</label><input type="text" id="editLevel">
      <label>Duration</label><input type="text" id="editDuration">
      <label>Exam Body</label><input type="text" id="editExamBody">
      <label>Fee</label><input type="text" id="editFee">
      <label>Status</label><input type="text" id="editStatus">
      <button type="submit" class="btn save">Save Changes</button>
    </form>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAQZ1_Grh00sFgOp8pxkKff10sMFSw9xlc",
  authDomain: "jnnp-system.firebaseapp.com",
  databaseURL: "https://jnnp-system-default-rtdb.firebaseio.com",
  projectId: "jnnp-system",
  storageBucket: "jnnp-system.firebasestorage.app", 
  messagingSenderId: "769232855377",
  appId: "1:769232855377:web:e3ba51e3e25cc24735f370"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const tableBody = document.querySelector("#applicationsTable tbody");
const admissionsBody = document.querySelector("#admissionsTable tbody");
const searchInput = document.getElementById("searchInput");
let coursesCache = {};
let latestApplicationsSnapshot = null;
let latestAdmissionsSnapshot = null;

// Fetch courses
db.ref("courses").on("value", snapshot => {
  const raw = snapshot.val() || {};
  coursesCache = {};
  Object.keys(raw).forEach(key => {
    const v = raw[key] || {};
    coursesCache[key] = {
      courseName: v.courseName || v.name || v.course || "",
      courseCode: v.courseCode || v.code || "",
      courseLevel: v.courseLevel || v.level || "",
      courseFee: v.courseFee || v.fee || "",
      courseDuration: v.courseDuration || v.duration || v.length || "",
      examBody: v.examBody || v.exam || v.exam_body || ""
    };
  });
  populateCourseOptions();
  renderApplications(latestApplicationsSnapshot);
  renderAdmissions(latestAdmissionsSnapshot);
  updateStats();
});

// Fetch applications
db.ref("applications").on("value", snapshot => {
  latestApplicationsSnapshot = snapshot;
  renderApplications(snapshot);
  updateStats();
});

// Fetch admissions
db.ref("admissions").on("value", snapshot => {
  latestAdmissionsSnapshot = snapshot;
  renderAdmissions(snapshot);
  updateStats();
});

// Functions for rendering tables
function escapeHtml(text) { if(!text) return ""; return text.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }
function renderApplications(snapshot) {
  tableBody.innerHTML = "";
  if(!snapshot) return;
  snapshot.forEach(appSnap=>{
    const app = appSnap.val()||{};
    const key = appSnap.key;
    const course = resolveCourseFromApp(app);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(app.fullName)}</td>
    <td>${escapeHtml(app.email)}</td>
    <td>${escapeHtml(app.phone)}</td>
    <td>${escapeHtml(course.courseName)}</td>
    <td>${escapeHtml(course.courseLevel)}</td>
    <td>${escapeHtml(course.courseDuration)}</td>
    <td>${escapeHtml(course.examBody)}</td>
    <td>${escapeHtml(course.courseFee)}</td>
    <td id="status-${key}">${escapeHtml(app.status||"Pending")}</td>
    <td class="action-buttons">
      <button class="btn approve" onclick="approveApplication('${key}')">Approve</button>
      <button class="btn pending" onclick="updateStatus('${key}','Pending')">Pending</button>
      <button class="btn save" onclick="saveApplication('${key}')">Save</button>
      <button class="btn delete" onclick="deleteApplication('${key}')">Delete</button>
    </td>`;
    tableBody.appendChild(tr);
  });
}
function renderAdmissions(snapshot) {
  admissionsBody.innerHTML="";
  if(!snapshot) return;
  snapshot.forEach(appSnap=>{
    const app = appSnap.val()||{};
    const key = appSnap.key;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(app.admNo)}</td>
    <td>${escapeHtml(app.fullName)}</td>
    <td>${escapeHtml(app.email)}</td>
    <td>${escapeHtml(app.phone)}</td>
    <td>${escapeHtml(app.courseName)}</td>
    <td>${escapeHtml(app.courseCode)}</td>
    <td>${escapeHtml(app.courseLevel)}</td>
    <td>${escapeHtml(app.courseDuration)}</td>
    <td>${escapeHtml(app.examBody)}</td>
    <td>${escapeHtml(app.courseFee)}</td>
    <td>${escapeHtml(app.status)}</td>
    <td class="action-buttons">
      <button class="btn save" onclick="openEditModal('${key}')">Edit</button>
      <button class="btn delete" onclick="deleteAdmission('${key}')">Delete</button>
    </td>`;
    admissionsBody.appendChild(tr);
  });
}

// Update stats cards
function updateStats() {
  // Total applications
  const totalApps = latestApplicationsSnapshot ? latestApplicationsSnapshot.numChildren() : 0;
  document.getElementById('totalApplications').textContent = totalApps;
  
  // Total admissions
  const totalAdmissions = latestAdmissionsSnapshot ? latestAdmissionsSnapshot.numChildren() : 0;
  document.getElementById('totalAdmissions').textContent = totalAdmissions;
  
  // Pending applications
  let pendingApps = 0;
  if (latestApplicationsSnapshot) {
    latestApplicationsSnapshot.forEach(appSnap => {
      const app = appSnap.val() || {};
      if (app.status === 'Pending') pendingApps++;
    });
  }
  document.getElementById('pendingApplications').textContent = pendingApps;
  
  // Total courses
  const totalCourses = Object.keys(coursesCache).length;
  document.getElementById('totalCourses').textContent = totalCourses;
}

// Course resolver
function resolveCourseFromApp(app) {
  if(app.courseId && coursesCache[app.courseId]) return coursesCache[app.courseId];
  if(app.course && coursesCache[app.course]) return coursesCache[app.course];
  return {courseName: app.courseName || app.course || "", courseCode: app.courseCode || "", courseLevel: app.courseLevel || "", courseDuration: app.courseDuration || "", examBody: app.examBody || "", courseFee: app.courseFee || ""};
}

// ‚úÖ Add Student Modal Functions
function populateCourseOptions() {
  const select = document.getElementById("addCourse");
  select.innerHTML = '<option value="">--Select Course--</option>';
  Object.keys(coursesCache).forEach(key => {
    const course = coursesCache[key];
    select.innerHTML += `<option value="${key}">${course.courseName}</option>`;
  });
}
function populateCourseDetails() {
  const key = document.getElementById("addCourse").value;
  if(coursesCache[key]){
    const course = coursesCache[key];
    document.getElementById("courseCode").innerText = course.courseCode||"";
    document.getElementById("courseLevel").innerText = course.courseLevel||"";
    document.getElementById("courseDuration").innerText = course.courseDuration||"";
    document.getElementById("examBody").innerText = course.examBody||"";
    document.getElementById("courseFee").innerText = course.courseFee||"";
  } else { document.getElementById("courseCode").innerText=""; document.getElementById("courseLevel").innerText=""; document.getElementById("courseDuration").innerText=""; document.getElementById("examBody").innerText=""; document.getElementById("courseFee").innerText=""; }
}
function openAddModal(){ populateCourseOptions(); document.getElementById("addModal").style.display="block"; }
function closeAddModal(){ document.getElementById("addModal").style.display="none"; }

// Add Student Submit
document.getElementById("addForm").addEventListener("submit",function(e){
  e.preventDefault();
  const fullName=document.getElementById("addFullName").value.trim();
  const email=document.getElementById("addEmail").value.trim();
  const phone=document.getElementById("addPhone").value.trim();
  const dob=document.getElementById("addDOB").value;
  const gender=document.getElementById("addGender").value;
  const courseId=document.getElementById("addCourse").value;
  const prevSchool=document.getElementById("addPrevSchool").value;
  const kcpeMarks=document.getElementById("addKCPE").value;
  const kcpeYear=document.getElementById("addKCPEYear").value;
  const kcseGrade=document.getElementById("addKCSEGrade").value;
  const kcseYear=document.getElementById("addKCSEYear").value;
  const parentName=document.getElementById("addParentName").value;
  const parentPhone=document.getElementById("addParentPhone").value;
  const relationship=document.getElementById("addRelationship").value;
  const maritalStatus=document.getElementById("addMarital").value;
  const sponsor=document.getElementById("addSponsor").value;
  const status=document.getElementById("addStatus").value;
  if(!courseId){ alert("Select a course"); return; }
  const course = coursesCache[courseId];

  db.ref("admissions").once("value").then(snapshot=>{
    let lastNo=12000;
    snapshot.forEach(child=>{ const n=parseInt(child.val().admNo); if(!isNaN(n) && n>lastNo) lastNo=n; });
    const newAdmNo=lastNo+1;
    const newKey=db.ref("admissions").push().key;
    const newStudent={ admNo:newAdmNo, fullName,email,phone,dob,gender,prevSchool,kcpeMarks,kcpeYear,kcseGrade,kcseYear,parentName,parentPhone,relationship,
maritalStatus,sponsor,status,
      courseName: course.courseName,
      courseCode: course.courseCode,
      courseLevel: course.courseLevel,
      courseDuration: course.courseDuration,
      examBody: course.examBody,
      courseFee: course.courseFee
    };
    db.ref("admissions/" + newKey).set(newStudent)
      .then(()=>{
        alert(`‚úÖ Student added successfully with Admission No: ${newAdmNo}`);
        closeAddModal();
        document.getElementById("addForm").reset();
      })
      .catch(err=>alert("‚ùå Error adding student: "+err));
  });
});

// Edit Modal Functions
function openEditModal(key){
  db.ref("admissions/"+key).once("value").then(snap=>{
    const data=snap.val();
    if(!data){ alert("Student not found"); return; }
    document.getElementById("editKey").value=key;
    document.getElementById("editFullName").value=data.fullName||"";
    document.getElementById("editEmail").value=data.email||"";
    document.getElementById("editPhone").value=data.phone||"";
    document.getElementById("editCourseName").value=data.courseName||"";
    document.getElementById("editCourseCode").value=data.courseCode||"";
    document.getElementById("editLevel").value=data.courseLevel||"";
    document.getElementById("editDuration").value=data.courseDuration||"";
    document.getElementById("editExamBody").value=data.examBody||"";
    document.getElementById("editFee").value=data.courseFee||"";
    document.getElementById("editStatus").value=data.status||"";
    document.getElementById("editModal").style.display="block";
  });
}
function closeModal(){ document.getElementById("editModal").style.display="none"; }

document.getElementById("editForm").addEventListener("submit",function(e){
  e.preventDefault();
  const key=document.getElementById("editKey").value;
  const updatedData={
    fullName:document.getElementById("editFullName").value,
    email:document.getElementById("editEmail").value,
    phone:document.getElementById("editPhone").value,
    courseName:document.getElementById("editCourseName").value,
    courseCode:document.getElementById("editCourseCode").value,
    courseLevel:document.getElementById("editLevel").value,
    courseDuration:document.getElementById("editDuration").value,
    examBody:document.getElementById("editExamBody").value,
    courseFee:document.getElementById("editFee").value,
    status:document.getElementById("editStatus").value
  };
  db.ref("admissions/"+key).update(updatedData)
    .then(()=>{ alert("‚úÖ Updated successfully"); closeModal(); })
    .catch(err=>alert("‚ùå "+err));
});

// Application actions
function approveApplication(key){
  db.ref("applications/"+key).once("value").then(snap=>{
    const app=snap.val();
    if(!app){ alert("Application not found"); return; }
    db.ref("admissions").orderByChild("email").equalTo(app.email).once("value",admSnap=>{
      if(admSnap.exists()){ alert("‚ùå Student already admitted"); return; }
      db.ref("admissions").once("value").then(allSnap=>{
        let lastNo=12000;
        allSnap.forEach(child=>{ const n=parseInt(child.val().admNo); if(!isNaN(n)&&n>lastNo) lastNo=n; });
        const newAdmNo=lastNo+1;
        const course=resolveCourseFromApp(app);
        const admissionData={ admNo:newAdmNo, fullName:app.fullName,email:app.email,phone:app.phone,
          courseName:course.courseName,courseCode:course.courseCode,courseLevel:course.courseLevel,
          courseDuration:course.courseDuration,examBody:course.examBody,courseFee:course.courseFee,
          status:"Admitted" };
        const newKey=db.ref("admissions").push().key;
        db.ref("admissions/"+newKey).set(admissionData)
          .then(()=>{ db.ref("applications/"+key).remove(); alert(`‚úÖ Student admitted with Admission No: ${newAdmNo}`); })
          .catch(err=>alert("‚ùå "+err));
      });
    });
  });
}
function updateStatus(key,status){ db.ref("applications/"+key).update({status}).then(()=>{ document.getElementById("status-"+key).innerText=status; }).catch(err=>alert("‚ùå "+err)); }
function saveApplication(key){ alert("Application saved successfully"); }
function deleteApplication(key){ if(confirm("Are you sure to delete this application?")){ db.ref("applications/"+key).remove().then(()=>alert("‚úÖ Deleted")).catch(err=>alert("‚ùå "+err)); } }
function deleteAdmission(key){ if(confirm("Are you sure to delete this admitted student?")){ db.ref("admissions/"+key).remove().then(()=>alert("‚úÖ Deleted")).catch(err=>alert("‚ùå "+err)); } }

// Dark Mode
document.getElementById("darkModeBtn").addEventListener("click",()=>{ document.body.classList.toggle("dark-mode"); });

// Search
searchInput.addEventListener("input",function(){
  const filter=this.value.toLowerCase();
  [tableBody,admissionsBody].forEach(tbody=>{
    Array.from(tbody.rows).forEach(row=>{
      row.style.display=Array.from(row.cells).some(td=>td.textContent.toLowerCase().includes(filter))?"":"none";
    });
  });
});

// Export PDF
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Admitted Students",14,15);
  doc.autoTable({ html:"#admissionsTable", startY:20, styles:{ fontSize:8 }, headStyles:{ fillColor:[0,119,182] } });
  doc.save("Admitted_Students.pdf");
}

// Sidebar navigation
document.querySelectorAll('.sidebar-menu a').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const targetId = this.getAttribute('href').substring(1);
    
    // Update active state
    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
    this.classList.add('active');
    
    // Handle navigation based on target
    if (targetId === 'courses') {
      // Redirect to courses.html
      window.location.href = 'courses.html';
    } else if (targetId === 'applications') {
      // Redirect to application.html
      window.location.href = 'application.html';
    } else if (targetId === 'admissions') {
      // Redirect to student-list.html
      window.location.href = 'student-list.html';
    } else if (targetId === 'reports') {
      // Show reports section
      document.getElementById('reports').style.display = 'block';
      document.getElementById('settings').style.display = 'none';
      document.getElementById('reports').scrollIntoView({ behavior: 'smooth' });
    } else if (targetId === 'settings') {
      // Show settings section
      document.getElementById('settings').style.display = 'block';
      document.getElementById('reports').style.display = 'none';
      document.getElementById('settings').scrollIntoView({ behavior: 'smooth' });
    } else {
      // Scroll to section for dashboard
      const targetElement = document.getElementById(targetId);
      if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
});

// Reports functionality
function generateReport(type) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  switch(type) {
    case 'applications':
      doc.text("Student Applications Report", 14, 15);
      doc.autoTable({ 
        html: "#applicationsTable", 
        startY: 20, 
        styles: { fontSize: 8 }, 
        headStyles: { fillColor: [0, 119, 182] } 
      });
      doc.save("Applications_Report.pdf");
      break;
      
    case 'admissions':
      doc.text("Admitted Students Report", 14, 15);
      doc.autoTable({ 
        html: "#admissionsTable", 
        startY: 20, 
        styles: { fontSize: 8 }, 
        headStyles: { fillColor: [0, 119, 182] } 
      });
      doc.save("Admissions_Report.pdf");
      break;
      
    case 'courses':
      doc.text("Courses Report", 14, 15);
      // Create a simple table for courses
      doc.autoTable({
        head: [['Course Name', 'Course Code', 'Level', 'Duration', 'Exam Body', 'Fee']],
        body: Object.values(coursesCache).map(course => [
          course.courseName,
          course.courseCode,
          course.courseLevel,
          course.courseDuration,
          course.examBody,
          course.courseFee
        ]),
        startY: 20,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [0, 119, 182] }
      });
      doc.save("Courses_Report.pdf");
      break;
      
    case 'performance':
      doc.text("Performance Analysis Report", 14, 15);
      // Create a performance summary
      const totalApps = latestApplicationsSnapshot ? latestApplicationsSnapshot.numChildren() : 0;
      const totalAdmissions = latestAdmissionsSnapshot ? latestAdmissionsSnapshot.numChildren() : 0;
      const admissionRate = totalApps > 0 ? ((totalAdmissions / totalApps) * 100).toFixed(2) : 0;
      
      doc.text(`Total Applications: ${totalApps}`, 14, 30);
      doc.text(`Total Admissions: ${totalAdmissions}`, 14, 40);
      doc.text(`Admission Rate: ${admissionRate}%`, 14, 50);
      doc.text(`Courses Available: ${Object.keys(coursesCache).length}`, 14, 60);
      
      doc.save("Performance_Report.pdf");
      break;
  }
}

// Settings functionality
function saveSettings() {
  const theme = document.getElementById('themeSetting').value;
  const language = document.getElementById('languageSetting').value;
  const notifications = document.getElementById('notificationsSetting').value;
  const autoSave = document.getElementById('autoSaveSetting').value;
  
  // Apply theme setting
  if (theme === 'dark') {
    document.body.classList.add('dark-mode');
  } else if (theme === 'light') {
    document.body.classList.remove('dark-mode');
  } else if (theme === 'auto') {
    // Auto theme based on system preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.body.classList.add('dark-mode');
    } else {
      document.body.classList.remove('dark-mode');
    }
  }
  
  // Save settings to localStorage
  const settings = {
    theme,
    language,
    notifications,
    autoSave
  };
  localStorage.setItem('adminSettings', JSON.stringify(settings));
  
  alert('Settings saved successfully!');
}

function resetSettings() {
  document.getElementById('themeSetting').value = 'light';
  document.getElementById('languageSetting').value = 'en';
  document.getElementById('notificationsSetting').value = 'enabled';
  document.getElementById('autoSaveSetting').value = 'enabled';
  
  document.body.classList.remove('dark-mode');
  localStorage.removeItem('adminSettings');
  
  alert('Settings reset to default!');
}

// Load saved settings on page load
window.addEventListener('load', function() {
  const savedSettings = localStorage.getItem('adminSettings');
  if (savedSettings) {
    const settings = JSON.parse(savedSettings);
    document.getElementById('themeSetting').value = settings.theme || 'light';
    document.getElementById('languageSetting').value = settings.language || 'en';
    document.getElementById('notificationsSetting').value = settings.notifications || 'enabled';
    document.getElementById('autoSaveSetting').value = settings.autoSave || 'enabled';
    
    // Apply theme
    if (settings.theme === 'dark') {
      document.body.classList.add('dark-mode');
    } else if (settings.theme === 'auto') {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark-mode');
      }
    }
  }
});
</script>
</body>
</html>