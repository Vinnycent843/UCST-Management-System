<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trainer Dashboard — UCST College</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2062f0;
      --primary-light: #4a86f8;
      --primary-dark: #0a3cb9;
      --secondary: #3943d6;
      --accent: #a3defd;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #212529;
      --header-height: 70px;
      --transition: all 0.3s ease;
      --card-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 8px 24px rgba(0,0,0,0.12);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Georgia, 'Times New Roman', Times, serif;
      background: linear-gradient(135deg, #f5f7fb 0%, #e4e8f0 100%);
      color: #333;
      transition: var(--transition);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Layout */
    .dashboard-container {
      width: 100%;
      min-height: 100vh;
      padding: 0;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      color: var(--dark);
      padding: 0 25px;
      height: var(--header-height);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 99;
      flex-wrap: wrap;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.2rem;
    }

    .logo-text h1 {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.2;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .logo-text p {
      font-size: 0.8rem;
      color: var(--secondary);
      opacity: 0.8;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    #searchBox {
      padding: 10px 15px;
      border-radius: 30px;
      border: 1px solid #e0e0e0;
      width: 250px;
      transition: var(--transition);
      background: #f8f9fa;
      font-size: 0.9rem;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    #searchBox::placeholder {
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    #searchBox:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(32, 98, 240, 0.1);
      background: white;
    }

    .user-profile {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 5px 12px;
      border-radius: 30px;
      transition: var(--transition);
      background: #f8f9fa;
    }

    .user-profile:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      margin-right: 10px;
      font-size: 0.9rem;
    }

    .user-info {
      display: flex;
      flex-direction: column;
    }

    .user-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--dark);
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .user-role {
      font-size: 0.75rem;
      color: var(--secondary);
      opacity: 0.8;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f8f9fa;
      border: none;
      font-size: 1.1rem;
      color: var(--secondary);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: #e9ecef;
      color: var(--primary);
      transform: rotate(15deg);
    }

    /* Main Content */
    main {
      padding: 25px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    /* Top Navigation Tabs */
    .top-nav {
      display: flex;
      background: white;
      border-radius: var(--card-radius);
      padding: 5px;
      margin-bottom: 25px;
      box-shadow: var(--shadow);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .top-nav::-webkit-scrollbar {
      display: none;
    }

    .nav-tab {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: var(--secondary);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .nav-tab:hover {
      background: rgba(32, 98, 240, 0.05);
      color: var(--primary);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(32, 98, 240, 0.2);
    }

    .nav-tab i {
      font-size: 1rem;
    }

    /* Dashboard Cards */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: var(--card-radius);
      padding: 22px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid #f0f0f0;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
      border-color: var(--primary-light);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .card-title {
      font-size: 0.85rem;
      color: var(--secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .card-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .card-icon.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
    }

    .card-icon.success {
      background: linear-gradient(135deg, var(--success), #20c997);
    }

    .card-icon.warning {
      background: linear-gradient(135deg, var(--warning), #fd7e14);
    }

    .card-icon.danger {
      background: linear-gradient(135deg, var(--danger), #e83e8c);
    }

    .card-icon.info {
      background: linear-gradient(135deg, var(--info), #0dcaf0);
    }

    .card-icon.purple {
      background: linear-gradient(135deg, #8a2be2, #9d4edd);
    }

    .card-icon.teal {
      background: linear-gradient(135deg, #17a2b8, #0dcaf0);
    }

    .card-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--dark);
      line-height: 1.2;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .card-footer {
      font-size: 0.8rem;
      color: #666;
      margin-top: auto;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    /* Table Containers */
    .table-section {
      background: white;
      border-radius: var(--card-radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 30px;
      border: 1px solid #f0f0f0;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-bottom: 1px solid #f0f0f0;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .section-header h3 i {
      color: var(--secondary);
    }

    /* Buttons */
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(32, 98, 240, 0.2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(32, 98, 240, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #20c997);
      color: white;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(40, 167, 69, 0.3);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning), #fd7e14);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.2);
    }

    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 193, 7, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger), #e83e8c);
      color: white;
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(220, 53, 69, 0.3);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--info), #0dcaf0);
      color: white;
      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.2);
    }

    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(23, 162, 184, 0.3);
    }

    .btn-purple {
      background: linear-gradient(135deg, #8a2be2, #9d4edd);
      color: white;
      box-shadow: 0 4px 12px rgba(138, 43, 226, 0.2);
    }

    .btn-purple:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(138, 43, 226, 0.3);
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      width: 100%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th {
      padding: 16px 15px;
      text-align: left;
      background: #f8f9fa;
      font-weight: 600;
      color: var(--secondary);
      border-bottom: 2px solid #e9ecef;
      white-space: nowrap;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: middle;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    tr:hover {
      background: rgba(32, 98, 240, 0.02);
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .status-badge.active {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
      border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .status-badge.inactive {
      background: rgba(108, 117, 125, 0.1);
      color: #6c757d;
      border: 1px solid rgba(108, 117, 125, 0.2);
    }

    .status-badge.pending {
      background: rgba(255, 193, 7, 0.1);
      color: var(--warning);
      border: 1px solid rgba(255, 193, 7, 0.2);
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      width: 36px;
      height: 36px;
      padding: 0;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--secondary);
      font-size: 0.9rem;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      transition: var(--transition);
      font-size: 0.95rem;
      background: white;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .form-group input::placeholder,
    .form-group select::placeholder,
    .form-group textarea::placeholder {
      font-family: Georgia, 'Times New Roman', Times, serif;
      color: #999;
    }

    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(32, 98, 240, 0.1);
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: #fff;
      padding: 28px;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .modal-content h3 {
      margin-bottom: 22px;
      color: var(--primary);
      font-weight: 600;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .modal-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-modal-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #666;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      margin-left: auto;
    }

    .close-modal-btn:hover {
      background: #f8f9fa;
      color: var(--danger);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }

    /* Success Message */
    .success-message {
      position: fixed;
      top: 25px;
      right: 25px;
      background: linear-gradient(135deg, var(--success), #20c997);
      color: white;
      padding: 16px 24px;
      border-radius: 10px;
      box-shadow: var(--shadow-hover);
      z-index: 1100;
      display: flex;
      align-items: center;
      gap: 12px;
      transform: translateX(150%);
      transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .success-message.show {
      transform: translateX(0);
    }

    /* Settings Styles */
    .settings-section {
      background: white;
      border-radius: var(--card-radius);
      padding: 22px;
      box-shadow: var(--shadow);
      margin-bottom: 22px;
      border: 1px solid #f0f0f0;
    }

    .settings-section h3 {
      margin-bottom: 18px;
      color: var(--primary);
      border-bottom: 1px solid #eee;
      padding-bottom: 12px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .settings-section h3 i {
      color: var(--secondary);
    }

    .settings-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid #f8f8f8;
      font-family: Georgia, 'Times New Roman', Times, serif;
    }

    .settings-option:last-child {
      border-bottom: none;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 54px;
      height: 28px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* Allocation Table Styles */
    .allocation-summary {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .allocation-card {
      background: white;
      border-radius: var(--card-radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border-left: 4px solid var(--primary);
    }

    .allocation-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 10px;
    }

    .trainer-name {
      font-weight: 600;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .allocation-details {
      margin-top: 10px;
    }

    .allocation-item {
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid var(--info);
    }

    .allocation-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .class-name {
      font-weight: 600;
      color: var(--secondary);
    }

    .unit-name {
      color: #666;
      font-size: 0.9rem;
      margin-top: 3px;
    }

    /* Dark Theme */
    .dark {
      background: linear-gradient(135deg, #121212 0%, #1a1a1a 100%);
      color: #e0e0e0;
    }

    .dark header {
      background: #1e1e1e;
      color: #e0e0e0;
      border-bottom: 1px solid #333;
    }

    .dark .user-profile {
      background: #2d2d2d;
    }

    .dark .user-profile:hover {
      background: #3d3d3d;
    }

    .dark #searchBox {
      background: #2d2d2d;
      border-color: #444;
      color: #e0e0e0;
    }

    .dark #searchBox:focus {
      background: #3d3d3d;
      border-color: var(--primary-light);
    }

    .dark .theme-toggle {
      background: #2d2d2d;
      color: #e0e0e0;
    }

    .dark .theme-toggle:hover {
      background: #3d3d3d;
      color: var(--primary-light);
    }

    .dark .top-nav {
      background: #1e1e1e;
      border: 1px solid #333;
    }

    .dark .nav-tab {
      color: #b0b0b0;
    }

    .dark .nav-tab:hover {
      background: rgba(32, 98, 240, 0.1);
      color: var(--primary-light);
    }

    .dark .nav-tab.active {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .dark .card {
      background: #1e1e1e;
      border-color: #333;
    }

    .dark .card-value {
      color: #e0e0e0;
    }

    .dark .card-footer {
      color: #b0b0b0;
      border-color: #333;
    }

    .dark .table-section {
      background: #1e1e1e;
      border-color: #333;
    }

    .dark .section-header {
      border-color: #333;
    }

    .dark .section-header h3 {
      color: var(--primary-light);
    }

    .dark table th {
      background: #2d2d2d;
      color: #e0e0e0;
      border-color: #444;
    }

    .dark table td {
      border-color: #444;
    }

    .dark tr:hover {
      background: rgba(32, 98, 240, 0.05);
    }

    .dark .modal-content {
      background: #2d2d2d;
      color: #e0e0e0;
    }

    .dark .form-group input,
    .dark .form-group select,
    .dark .form-group textarea {
      background: #1e1e1e;
      border-color: #444;
      color: #e0e0e0;
    }

    .dark .modal-actions {
      border-color: #444;
    }

    .dark .close-modal-btn {
      color: #b0b0b0;
    }

    .dark .close-modal-btn:hover {
      background: #3d3d3d;
      color: #ff6b6b;
    }

    .dark .settings-section {
      background: #1e1e1e;
      border-color: #333;
    }

    .dark .settings-section h3 {
      border-color: #444;
      color: var(--primary-light);
    }

    .dark .settings-option {
      border-color: #333;
    }

    .dark .allocation-card {
      background: #1e1e1e;
      border-color: #333;
    }

    .dark .allocation-item {
      background: #2d2d2d;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      main {
        padding: 20px;
      }
      
      .dashboard-cards {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }
    }

    @media (max-width: 992px) {
      header {
        padding: 0 20px;
      }
      
      .logo-text h1 {
        font-size: 1.2rem;
      }
      
      #searchBox {
        width: 200px;
      }
      
      .dashboard-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0;
      }
    }

    @media (max-width: 768px) {
      header {
        height: auto;
        padding: 15px;
        gap: 15px;
      }
      
      .header-left, .header-right {
        width: 100%;
        justify-content: space-between;
      }
      
      .logo {
        flex: 1;
      }
      
      #searchBox {
        flex: 1;
        max-width: 300px;
      }
      
      .user-info {
        display: none;
      }
      
      .user-avatar {
        margin-right: 0;
      }
      
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .top-nav {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .nav-tab {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
      
      .section-header {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      
      .section-header h3 {
        font-size: 1.1rem;
      }
      
      .modal-content {
        padding: 20px;
        max-width: 95%;
      }

      .allocation-summary {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 576px) {
      main {
        padding: 15px;
      }
      
      .card {
        padding: 18px;
      }
      
      .card-value {
        font-size: 1.8rem;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .action-buttons button {
        width: 100%;
        height: 32px;
      }
      
      .modal-content {
        padding: 18px;
      }
      
      .success-message {
        top: 15px;
        right: 15px;
        left: 15px;
        padding: 12px 18px;
        text-align: center;
        justify-content: center;
      }
      
      .toggle-switch {
        width: 48px;
        height: 24px;
      }
      
      .toggle-slider:before {
        height: 16px;
        width: 16px;
      }
    }

    @media (max-width: 400px) {
      .logo-text h1 {
        font-size: 1.1rem;
      }
      
      .logo-icon {
        width: 35px;
        height: 35px;
        font-size: 1rem;
      }
      
      #searchBox {
        font-size: 0.85rem;
        padding: 8px 12px;
      }
      
      .theme-toggle {
        width: 35px;
        height: 35px;
      }
      
      .nav-tab {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      
      button {
        padding: 8px 15px;
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <!-- Header -->
  <header>
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div class="logo-text">
          <h1>UCST College</h1>
          <p>Trainer Management Dashboard</p>
        </div>
      </div>
    </div>
    
    <div class="header-right">
      <input type="text" id="searchBox" placeholder="Search trainers, classes, units...">
      
      <div class="user-profile">
        <div class="user-avatar">AD</div>
        <div class="user-info">
          <div class="user-name">Admin User</div>
          <div class="user-role">Administrator</div>
        </div>
      </div>
      
      <button class="theme-toggle" id="toggleTheme">
        <i class="fas fa-moon"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Top Navigation -->
    <div class="top-nav">
      <button class="nav-tab active" data-tab="dashboard">
        <i class="fas fa-tachometer-alt"></i>
        Dashboard
      </button>
      
      <button class="nav-tab" data-tab="trainers">
        <i class="fas fa-users"></i>
        All Trainers
      </button>
      
      <button class="nav-tab" data-tab="allocations">
        <i class="fas fa-calendar-check"></i>
        Allocations
      </button>
      
      <button class="nav-tab" data-tab="departments">
        <i class="fas fa-building"></i>
        Departments
      </button>
      
      <button class="nav-tab" data-tab="settings">
        <i class="fas fa-cog"></i>
        Settings
      </button>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard">
      <!-- Dashboard Cards -->
      <div class="dashboard-cards">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Total Trainers</div>
            <div class="card-icon primary">
              <i class="fas fa-users"></i>
            </div>
          </div>
          <div class="card-value" id="totalTrainers">0</div>
          <div class="card-footer">Registered trainers in system</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Active Trainers</div>
            <div class="card-icon success">
              <i class="fas fa-user-check"></i>
            </div>
          </div>
          <div class="card-value" id="activeTrainers">0</div>
          <div class="card-footer">Currently teaching</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Classes Assigned</div>
            <div class="card-icon warning">
              <i class="fas fa-chalkboard"></i>
            </div>
          </div>
          <div class="card-value" id="totalClassesAssigned">0</div>
          <div class="card-footer">Classes allocated to trainers</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <div class="card-title">Units Assigned</div>
            <div class="card-icon info">
              <i class="fas fa-book"></i>
            </div>
          </div>
          <div class="card-value" id="totalUnitsAssigned">0</div>
          <div class="card-footer">Units allocated to trainers</div>
        </div>
      </div>

      <!-- Recent Allocations Summary -->
      <div class="table-section">
        <div class="section-header">
          <h3><i class="fas fa-clock"></i> Recent Allocations</h3>
          <button class="btn-purple" onclick="openAllocationModal()">
            <i class="fas fa-plus"></i> New Allocation
          </button>
        </div>
        <div class="allocation-summary" id="recentAllocations">
          <!-- Recent allocations will be dynamically generated here -->
        </div>
      </div>

      <!-- Recent Trainers Table -->
      <div class="table-section">
        <div class="section-header">
          <h3><i class="fas fa-user-clock"></i> Recent Trainers</h3>
          <button class="btn-primary" onclick="openTrainerModal()">
            <i class="fas fa-plus"></i> Add New Trainer
          </button>
        </div>
        <div class="table-container">
          <table id="trainersTable">
            <thead>
              <tr>
                <th>Reg No</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Department</th>
                <th>Allocations</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="trainersTableBody">
              <tr><td colspan="8">Loading trainers...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Trainers Tab -->
    <div class="tab-content" id="trainers">
      <div class="table-section">
        <div class="section-header">
          <h3><i class="fas fa-users"></i> All Trainers</h3>
          <div>
            <button class="btn-primary" onclick="openTrainerModal()">
              <i class="fas fa-plus"></i> Add New Trainer
            </button>
            <button class="btn-purple" onclick="openAllocationModal()">
              <i class="fas fa-calendar-plus"></i> Allocate Classes
            </button>
          </div>
        </div>
        <div class="table-container">
          <table id="trainersFullTable">
            <thead>
              <tr>
                <th>Reg No</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Department</th>
                <th>Classes Assigned</th>
                <th>Units Assigned</th>
                <th>Qualification</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="trainersFullTableBody">
              <tr><td colspan="10">Loading trainers...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Allocations Tab -->
    <div class="tab-content" id="allocations">
      <div class="table-section">
        <div class="section-header">
          <h3><i class="fas fa-calendar-check"></i> Class & Unit Allocations</h3>
          <div>
            <button class="btn-primary" onclick="openAllocationModal()">
              <i class="fas fa-plus"></i> New Allocation
            </button>
            <button class="btn-info" onclick="openManualAllocationModal()">
              <i class="fas fa-edit"></i> Manual Allocation
            </button>
          </div>
        </div>
        <div class="table-container">
          <table id="allocationsTable">
            <thead>
              <tr>
                <th>Trainer</th>
                <th>Reg No</th>
                <th>Class</th>
                <th>Class Code</th>
                <th>Units Assigned</th>
                <th>Allocation Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allocationsTableBody">
              <tr><td colspan="8">Loading allocations...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Trainer Allocation Summary -->
      <div class="table-section">
        <div class="section-header">
          <h3><i class="fas fa-chart-bar"></i> Trainer Workload Summary</h3>
        </div>
        <div class="allocation-summary" id="trainerWorkloadSummary">
          <!-- Trainer workload summary will be dynamically generated here -->
        </div>
      </div>
    </div>

    <!-- Departments Tab -->
    <div class="tab-content" id="departments">
      <div class="table-section">
        <div class="section-header">
          <h3><i class="fas fa-building"></i> Department Management</h3>
          <button class="btn-primary" onclick="openDepartmentModal()">
            <i class="fas fa-plus"></i> Add New Department
          </button>
        </div>
        <div class="table-container">
          <table id="departmentsTable">
            <thead>
              <tr>
                <th>Department Name</th>
                <th>Courses</th>
                <th>Trainers</th>
                <th>Classes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="departmentsTableBody">
              <tr><td colspan="5">Loading departments...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" id="settings">
      <div class="settings-section">
        <h3><i class="fas fa-sliders-h"></i> General Settings</h3>
        <div class="settings-option">
          <div>
            <strong>Dark Mode</strong>
            <p>Toggle between light and dark theme</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <div>
            <strong>Email Notifications</strong>
            <p>Receive email alerts for new allocations</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="emailNotifications" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-option">
          <div>
            <strong>Auto Backup</strong>
            <p>Automatically backup data weekly</p>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="autoBackup" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <h3><i class="fas fa-info-circle"></i> System Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="institutionName">Institution Name</label>
            <input type="text" id="institutionName" value="UCST College" placeholder="Enter institution name">
          </div>
          <div class="form-group">
            <label for="adminEmail">Admin Email</label>
            <input type="email" id="adminEmail" value="admin@ucst.ac.ke" placeholder="Enter admin email">
          </div>
        </div>
        <div class="form-group">
          <label for="systemVersion">System Version</label>
          <input type="text" id="systemVersion" value="v2.1.0" readonly>
        </div>
        <button class="btn-primary" onclick="saveSystemSettings()">
          <i class="fas fa-save"></i> Save Settings
        </button>
      </div>

      <div class="settings-section">
        <h3><i class="fas fa-database"></i> Data Management</h3>
        <div class="form-row">
          <div class="form-group">
            <button class="btn-info" style="width: 100%;" onclick="exportData()">
              <i class="fas fa-download"></i> Export Data
            </button>
          </div>
          <div class="form-group">
            <button class="btn-warning" style="width: 100%;" onclick="importData()">
              <i class="fas fa-upload"></i> Import Data
            </button>
          </div>
        </div>
        <div class="form-group">
          <button class="btn-danger" style="width: 100%;" onclick="clearAllData()">
            <i class="fas fa-trash"></i> Clear All Data
          </button>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Trainer Modal -->
<div class="modal" id="trainerModal">
  <div class="modal-content">
    <h3>
      <div class="modal-header">
        <i class="fas fa-user-plus"></i>
        <span id="trainerModalTitle">Add Trainer</span>
      </div>
      <button class="close-modal-btn" onclick="closeTrainerModal()">×</button>
    </h3>
    
    <div class="form-group">
      <label for="fullName">Full Name *</label>
      <input type="text" id="fullName" placeholder="Enter trainer's full name" required>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" placeholder="Enter email address" required>
      </div>
      <div class="form-group">
        <label for="phone">Phone *</label>
        <input type="text" id="phone" placeholder="Enter phone number" required>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="deptSelect">Department *</label>
        <select id="deptSelect" required>
          <option value="">Select Department</option>
        </select>
      </div>
      <div class="form-group">
        <label for="statusSelect">Status *</label>
        <select id="statusSelect" required>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
          <option value="On Leave">On Leave</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="qualification">Qualification *</label>
      <input type="text" id="qualification" placeholder="Enter qualification details" required>
    </div>

    <div class="form-group">
      <label for="regNo">Registration Number</label>
      <input type="text" id="regNo" placeholder="Enter registration number (optional)">
    </div>
    
    <div class="form-group">
      <label for="specialization">Specialization</label>
      <textarea id="specialization" rows="3" placeholder="Enter areas of specialization..."></textarea>
    </div>
    
    <div class="modal-actions">
      <button type="submit" class="btn-primary" onclick="saveTrainer()">
        <i class="fas fa-save"></i> Save Trainer
      </button>
      <button type="button" class="btn-danger" onclick="closeTrainerModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Department Modal -->
<div class="modal" id="departmentModal">
  <div class="modal-content">
    <h3>
      <div class="modal-header">
        <i class="fas fa-building"></i>
        <span id="departmentModalTitle">Add Department</span>
      </div>
      <button class="close-modal-btn" onclick="closeDepartmentModal()">×</button>
    </h3>
    
    <div class="form-group">
      <label for="departmentName">Department Name *</label>
      <input type="text" id="departmentName" placeholder="Enter department name" required>
    </div>
    
    <div class="form-group">
      <label for="departmentCourses">Courses (one per line)</label>
      <textarea id="departmentCourses" rows="5" placeholder="Enter courses, one per line"></textarea>
      <small style="color: #666; font-size: 0.85rem; font-family: Georgia, 'Times New Roman', Times, serif;">Example: Diploma in Computer Science<br>Certificate in IT<br>Bachelor in Software Engineering</small>
    </div>
    
    <div class="modal-actions">
      <button type="submit" class="btn-primary" onclick="saveDepartment()">
        <i class="fas fa-save"></i> Save Department
      </button>
      <button type="button" class="btn-danger" onclick="closeDepartmentModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Allocation Modal -->
<div class="modal" id="allocationModal">
  <div class="modal-content">
    <h3>
      <div class="modal-header">
        <i class="fas fa-calendar-plus"></i>
        <span id="allocationModalTitle">Allocate Class & Units</span>
      </div>
      <button class="close-modal-btn" onclick="closeAllocationModal()">×</button>
    </h3>
    
    <div class="form-group">
      <label for="allocTrainer">Select Trainer *</label>
      <select id="allocTrainer" required onchange="updateTrainerClasses()">
        <option value="">-- Select Trainer --</option>
      </select>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="allocClass">Select Class *</label>
        <select id="allocClass" required onchange="updateClassUnits()">
          <option value="">-- Select Class --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="allocUnit">Select Units *</label>
        <select id="allocUnit" multiple required style="height: 120px;">
          <option value="">-- Select Class First --</option>
        </select>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="allocationDate">Allocation Date *</label>
        <input type="date" id="allocationDate" required>
      </div>
      <div class="form-group">
        <label for="allocationStatus">Status *</label>
        <select id="allocationStatus" required>
          <option value="Active">Active</option>
          <option value="Pending">Pending</option>
          <option value="Temporary">Temporary</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="allocationNotes">Notes (Optional)</label>
      <textarea id="allocationNotes" rows="3" placeholder="Enter any notes about this allocation..."></textarea>
    </div>
    
    <div class="modal-actions">
      <button type="submit" class="btn-primary" onclick="saveAllocation()">
        <i class="fas fa-save"></i> Save Allocation
      </button>
      <button type="button" class="btn-danger" onclick="closeAllocationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Manual Allocation Modal -->
<div class="modal" id="manualAllocationModal">
  <div class="modal-content">
    <h3>
      <div class="modal-header">
        <i class="fas fa-edit"></i>
        <span>Manual Allocation Entry</span>
      </div>
      <button class="close-modal-btn" onclick="closeManualAllocationModal()">×</button>
    </h3>
    
    <div class="form-group">
      <label for="manualTrainerName">Trainer Name *</label>
      <input type="text" id="manualTrainerName" placeholder="Enter trainer's full name" required>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="manualClassName">Class Name *</label>
        <input type="text" id="manualClassName" placeholder="Enter class name" required>
      </div>
      <div class="form-group">
        <label for="manualClassCode">Class Code</label>
        <input type="text" id="manualClassCode" placeholder="Enter class code (optional)">
      </div>
    </div>
    
    <div class="form-group">
      <label for="manualUnits">Units to Teach (comma separated) *</label>
      <textarea id="manualUnits" rows="4" placeholder="Enter units separated by commas, e.g., Introduction to Programming, Database Management, Web Development" required></textarea>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="manualAllocationDate">Allocation Date *</label>
        <input type="date" id="manualAllocationDate" required>
      </div>
      <div class="form-group">
        <label for="manualStatus">Status *</label>
        <select id="manualStatus" required>
          <option value="Active">Active</option>
          <option value="Pending">Pending</option>
        </select>
      </div>
    </div>
    
    <div class="modal-actions">
      <button type="submit" class="btn-primary" onclick="saveManualAllocation()">
        <i class="fas fa-save"></i> Save Manual Allocation
      </button>
      <button type="button" class="btn-danger" onclick="closeManualAllocationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Edit Allocation Modal -->
<div class="modal" id="editAllocationModal">
  <div class="modal-content">
    <h3>
      <div class="modal-header">
        <i class="fas fa-edit"></i>
        <span>Edit Allocation</span>
      </div>
      <button class="close-modal-btn" onclick="closeEditAllocationModal()">×</button>
    </h3>
    
    <input type="hidden" id="editAllocationId">
    
    <div class="form-group">
      <label for="editTrainer">Trainer</label>
      <input type="text" id="editTrainer" readonly style="background: #f8f9fa;">
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="editClass">Class</label>
        <input type="text" id="editClass" readonly style="background: #f8f9fa;">
      </div>
      <div class="form-group">
        <label for="editClassCode">Class Code</label>
        <input type="text" id="editClassCode" readonly style="background: #f8f9fa;">
      </div>
    </div>
    
    <div class="form-group">
      <label for="editUnits">Units to Teach *</label>
      <textarea id="editUnits" rows="4" placeholder="Edit units separated by commas" required></textarea>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label for="editAllocationDate">Allocation Date *</label>
        <input type="date" id="editAllocationDate" required>
      </div>
      <div class="form-group">
        <label for="editStatus">Status *</label>
        <select id="editStatus" required>
          <option value="Active">Active</option>
          <option value="Pending">Pending</option>
          <option value="Completed">Completed</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    
    <div class="form-group">
      <label for="editNotes">Notes</label>
      <textarea id="editNotes" rows="3" placeholder="Edit allocation notes..."></textarea>
    </div>
    
    <div class="modal-actions">
      <button type="submit" class="btn-primary" onclick="updateAllocation()">
        <i class="fas fa-save"></i> Update Allocation
      </button>
      <button type="button" class="btn-danger" onclick="closeEditAllocationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
  <i class="fas fa-check-circle"></i>
  <span id="successMessageText">Operation completed successfully!</span>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAQZ1_Grh00sFgOp8pxkKff10sMFSw9xlc",
  authDomain: "jnnp-system.firebaseapp.com",
  databaseURL: "https://jnnp-system-default-rtdb.firebaseio.com",
  projectId: "jnnp-system",
  storageBucket: "jnnp-system.firebasestorage.app", 
  messagingSenderId: "769232855377",
  appId: "1:769232855377:web:e3ba51e3e25cc24735f370"
};

// Initialize Firebase
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

// Global variables
let trainers = {};
let departments = {};
let classes = {};
let courses = {};
let units = {};
let allocations = {};
let editTrainerKey = null;
let editDepartmentKey = null;
let editAllocationKey = null;

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
  loadData();
  setupEventListeners();
  setActiveTab('dashboard');
});

// Load data from Firebase
function loadData() {
  // Load trainers
  db.ref("trainers").on("value", snapshot => {
    trainers = snapshot.val() || {};
    updateDashboardCards();
    renderTrainersTable();
    renderTrainersFullTable();
    updateAllocationSelects();
    renderRecentAllocations();
    renderTrainerWorkloadSummary();
  });

  // Load departments
  db.ref("departments").on("value", snapshot => {
    departments = snapshot.val() || {};
    updateDashboardCards();
    renderDepartmentsTable();
    updateDepartmentSelects();
  });

  // Load classes
  db.ref("classes").on("value", snapshot => {
    classes = snapshot.val() || {};
    updateDashboardCards();
    updateClassSelects();
  });

  // Load courses
  db.ref("courses").on("value", snapshot => {
    courses = snapshot.val() || {};
    updateDashboardCards();
  });

  // Load units
  db.ref("units").on("value", snapshot => {
    units = snapshot.val() || {};
    updateDashboardCards();
  });

  // Load allocations
  db.ref("trainer_allocations").on("value", snapshot => {
    allocations = snapshot.val() || {};
    updateDashboardCards();
    renderAllocationsTable();
    renderRecentAllocations();
    renderTrainerWorkloadSummary();
  });
}

// Setup event listeners
function setupEventListeners() {
  // Tab switching
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      setActiveTab(tabId);
    });
  });

  // Theme toggle
  const themeToggleBtn = document.getElementById('toggleTheme');
  themeToggleBtn.addEventListener('click', function() {
    document.body.classList.toggle('dark');
    const icon = this.querySelector('i');
    if (document.body.classList.contains('dark')) {
      icon.classList.remove('fa-moon');
      icon.classList.add('fa-sun');
      localStorage.setItem('theme', 'dark');
    } else {
      icon.classList.remove('fa-sun');
      icon.classList.add('fa-moon');
      localStorage.setItem('theme', 'light');
    }
  });

  // Load saved theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.body.classList.add('dark');
    themeToggleBtn.querySelector('i').classList.remove('fa-moon');
    themeToggleBtn.querySelector('i').classList.add('fa-sun');
  }

  // Search functionality
  const searchBox = document.getElementById('searchBox');
  if (searchBox) {
    searchBox.addEventListener('keyup', function() {
      const searchTerm = this.value.toLowerCase();
      
      // Search in trainers tables
      const trainerRows = document.querySelectorAll('#trainersTableBody tr, #trainersFullTableBody tr');
      trainerRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
      
      // Search in allocations table
      const allocRows = document.querySelectorAll('#allocationsTableBody tr');
      allocRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
      
      // Search in departments table
      const deptRows = document.querySelectorAll('#departmentsTableBody tr');
      deptRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  }

  // Department change → load courses
  const deptSelect = document.getElementById('deptSelect');
  if (deptSelect) {
    deptSelect.addEventListener('change', function() {
      const dept = this.value;
      const coursesSelect = document.getElementById('coursesSelect');
      coursesSelect.innerHTML = '';
      
      if (!dept || !departments[dept] || !departments[dept].courses) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No courses found for this department';
        coursesSelect.appendChild(option);
        return;
      }
      
      departments[dept].courses.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course;
        coursesSelect.appendChild(option);
      });
    });
  }

  // Settings toggles
  const darkModeToggle = document.getElementById('darkModeToggle');
  if (darkModeToggle) {
    darkModeToggle.addEventListener('change', function() {
      document.body.classList.toggle('dark');
      const icon = document.querySelector('#toggleTheme i');
      if (document.body.classList.contains('dark')) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
        localStorage.setItem('theme', 'dark');
      } else {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
        localStorage.setItem('theme', 'light');
      }
    });
    
    // Set initial toggle state
    if (document.body.classList.contains('dark')) {
      darkModeToggle.checked = true;
    }
  }

  // Close modal when clicking outside
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
      if (e.target === this) {
        if (this.id === 'trainerModal') closeTrainerModal();
        if (this.id === 'departmentModal') closeDepartmentModal();
        if (this.id === 'allocationModal') closeAllocationModal();
        if (this.id === 'manualAllocationModal') closeManualAllocationModal();
        if (this.id === 'editAllocationModal') closeEditAllocationModal();
      }
    });
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeTrainerModal();
      closeDepartmentModal();
      closeAllocationModal();
      closeManualAllocationModal();
      closeEditAllocationModal();
    }
  });

  // Set today's date in date fields
  const today = new Date().toISOString().split('T')[0];
  const allocationDate = document.getElementById('allocationDate');
  const manualAllocationDate = document.getElementById('manualAllocationDate');
  const editAllocationDate = document.getElementById('editAllocationDate');
  
  if (allocationDate) allocationDate.value = today;
  if (manualAllocationDate) manualAllocationDate.value = today;
  if (editAllocationDate) editAllocationDate.value = today;
}

// Set active tab
function setActiveTab(tabId) {
  // Update active tab button
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
    if (tab.getAttribute('data-tab') === tabId) {
      tab.classList.add('active');
    }
  });
  
  // Update active tab content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
    if (content.id === tabId) {
      content.classList.add('active');
    }
  });
}

// Update dashboard cards
function updateDashboardCards() {
  // Total trainers
  const totalTrainersEl = document.getElementById('totalTrainers');
  if (totalTrainersEl) {
    totalTrainersEl.textContent = Object.keys(trainers).length;
  }
  
  // Active trainers
  const activeTrainersEl = document.getElementById('activeTrainers');
  if (activeTrainersEl) {
    const activeTrainers = Object.values(trainers).filter(trainer => 
      trainer.status === 'Active'
    ).length;
    activeTrainersEl.textContent = activeTrainers;
  }
  
  // Classes assigned
  const totalClassesAssignedEl = document.getElementById('totalClassesAssigned');
  if (totalClassesAssignedEl) {
    const uniqueClasses = new Set();
    Object.values(allocations).forEach(alloc => {
      if (alloc.className && alloc.status === 'Active') {
        uniqueClasses.add(alloc.className);
      }
    });
    totalClassesAssignedEl.textContent = uniqueClasses.size;
  }
  
  // Units assigned
  const totalUnitsAssignedEl = document.getElementById('totalUnitsAssigned');
  if (totalUnitsAssignedEl) {
    let totalUnits = 0;
    Object.values(allocations).forEach(alloc => {
      if (alloc.units && alloc.status === 'Active') {
        totalUnits += alloc.units.length;
      }
    });
    totalUnitsAssignedEl.textContent = totalUnits;
  }
}

// Update allocation dropdowns
function updateAllocationSelects() {
  const trainerSelect = document.getElementById('allocTrainer');
  if (!trainerSelect) return;
  
  trainerSelect.innerHTML = '<option value="">-- Select Trainer --</option>';
  
  Object.entries(trainers).forEach(([id, trainer]) => {
    if (trainer.status === 'Active') {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = `${trainer.regNo || 'N/A'} - ${trainer.fullName || ''}`;
      trainerSelect.appendChild(option);
    }
  });
}

// Update class dropdowns
function updateClassSelects() {
  const classSelect = document.getElementById('allocClass');
  if (!classSelect) return;
  
  classSelect.innerHTML = '<option value="">-- Select Class --</option>';
  
  Object.entries(classes).forEach(([id, classData]) => {
    if (classData.status === 'Active') {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = `${classData.className || ''} (${classData.courseName || ''})`;
      option.setAttribute('data-course', classData.courseName || '');
      classSelect.appendChild(option);
    }
  });
}

// Update department dropdowns
function updateDepartmentSelects() {
  const deptSelect = document.getElementById('deptSelect');
  if (!deptSelect) return;
  
  deptSelect.innerHTML = '<option value="">Select Department</option>';
  
  Object.keys(departments).forEach(deptName => {
    const option = document.createElement('option');
    option.value = deptName;
    option.textContent = deptName;
    deptSelect.appendChild(option);
  });
}

// Update classes for selected trainer
function updateTrainerClasses() {
  const trainerId = document.getElementById('allocTrainer').value;
  const classSelect = document.getElementById('allocClass');
  
  if (!trainerId) return;
  
  classSelect.innerHTML = '<option value="">-- Select Class --</option>';
  
  // Filter classes by trainer's department if available
  const trainer = trainers[trainerId];
  if (!trainer) return;
  
  Object.entries(classes).forEach(([id, classData]) => {
    if (classData.status === 'Active') {
      // Check if trainer already has this class allocated
      const hasClass = Object.values(allocations).some(alloc => 
        alloc.trainerId === trainerId && 
        alloc.classId === id && 
        alloc.status === 'Active'
      );
      
      if (!hasClass) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = `${classData.className || ''} (${classData.courseName || ''})`;
        option.setAttribute('data-course', classData.courseName || '');
        classSelect.appendChild(option);
      }
    }
  });
}

// Update units for selected class
function updateClassUnits() {
  const classId = document.getElementById('allocClass').value;
  const unitSelect = document.getElementById('allocUnit');
  
  if (!classId) {
    unitSelect.innerHTML = '<option value="">-- Select Class First --</option>';
    return;
  }
  
  const classData = classes[classId];
  if (!classData) return;
  
  unitSelect.innerHTML = '';
  
  // Get units for this class's course
  const courseName = classData.courseName;
  if (!courseName) {
    unitSelect.innerHTML = '<option value="">No units found for this course</option>';
    return;
  }
  
  // Find units for this course
  let unitsFound = false;
  Object.entries(units).forEach(([id, unit]) => {
    if (unit.courseName === courseName || unit.courseCode === classData.courseCode) {
      const option = document.createElement('option');
      option.value = id;
      option.textContent = `${unit.unitCode || ''} - ${unit.unitName || ''}`;
      unitSelect.appendChild(option);
      unitsFound = true;
    }
  });
  
  if (!unitsFound) {
    unitSelect.innerHTML = '<option value="">No units found for this course</option>';
  }
}

// Render recent allocations
function renderRecentAllocations() {
  const container = document.getElementById('recentAllocations');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (Object.keys(allocations).length === 0) {
    container.innerHTML = `
      <div class="allocation-card">
        <div class="allocation-card-header">
          <div class="trainer-name">No Allocations Yet</div>
        </div>
        <div class="allocation-details">
          <p style="color: #666; text-align: center;">Start by allocating classes to trainers</p>
        </div>
      </div>
    `;
    return;
  }
  
  // Show only recent 4 allocations
  const recentAllocations = Object.entries(allocations)
    .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0))
    .slice(0, 4);
  
  recentAllocations.forEach(([id, allocation]) => {
    const trainer = trainers[allocation.trainerId] || {};
    const classData = classes[allocation.classId] || {};
    
    const allocationCard = document.createElement('div');
    allocationCard.className = 'allocation-card';
    allocationCard.innerHTML = `
      <div class="allocation-card-header">
        <div class="trainer-name">${trainer.fullName || 'Unknown Trainer'}</div>
        <span class="status-badge ${allocation.status === 'Active' ? 'active' : 'pending'}">${allocation.status || 'Active'}</span>
      </div>
      <div class="allocation-details">
        <div class="allocation-item">
          <div class="allocation-item-header">
            <div class="class-name">${classData.className || allocation.className || 'Unknown Class'}</div>
            <small>${allocation.allocationDate || 'No date'}</small>
          </div>
          <div class="unit-name">
            <strong>Units:</strong> ${(allocation.units || []).slice(0, 3).join(', ') || 'No units assigned'}
            ${(allocation.units || []).length > 3 ? ` +${(allocation.units || []).length - 3} more` : ''}
          </div>
        </div>
      </div>
      <div class="action-buttons" style="margin-top: 15px;">
        <button class="btn-info" onclick="editAllocation('${id}')" style="padding: 6px 12px; font-size: 0.85rem;">
          <i class="fas fa-edit"></i> Edit
        </button>
        <button class="btn-danger" onclick="deleteAllocation('${id}')" style="padding: 6px 12px; font-size: 0.85rem;">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    `;
    container.appendChild(allocationCard);
  });
}

// Render trainer workload summary
function renderTrainerWorkloadSummary() {
  const container = document.getElementById('trainerWorkloadSummary');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (Object.keys(trainers).length === 0) {
    container.innerHTML = `
      <div class="allocation-card">
        <div class="allocation-card-header">
          <div class="trainer-name">No Trainers</div>
        </div>
        <div class="allocation-details">
          <p style="color: #666; text-align: center;">Add trainers to see workload summary</p>
        </div>
      </div>
    `;
    return;
  }
  
  // Calculate workload for each trainer
  const trainerWorkloads = {};
  
  Object.entries(trainers).forEach(([trainerId, trainer]) => {
    if (trainer.status === 'Active') {
      const trainerAllocations = Object.values(allocations).filter(alloc => 
        alloc.trainerId === trainerId && alloc.status === 'Active'
      );
      
      trainerWorkloads[trainerId] = {
        name: trainer.fullName || 'Unknown',
        regNo: trainer.regNo || 'N/A',
        totalClasses: trainerAllocations.length,
        totalUnits: trainerAllocations.reduce((total, alloc) => total + (alloc.units || []).length, 0),
        classes: trainerAllocations.map(alloc => ({
          className: classes[alloc.classId]?.className || alloc.className || 'Unknown',
          units: alloc.units || []
        }))
      };
    }
  });
  
  // Sort by workload (most classes first)
  const sortedTrainers = Object.entries(trainerWorkloads)
    .sort((a, b) => b[1].totalClasses - a[1].totalClasses)
    .slice(0, 6); // Show top 6 trainers
  
  sortedTrainers.forEach(([trainerId, workload]) => {
    const allocationCard = document.createElement('div');
    allocationCard.className = 'allocation-card';
    allocationCard.innerHTML = `
      <div class="allocation-card-header">
        <div class="trainer-name">${workload.name}</div>
        <span class="status-badge ${workload.totalClasses > 0 ? 'active' : 'inactive'}">
          ${workload.totalClasses} class${workload.totalClasses !== 1 ? 'es' : ''}
        </span>
      </div>
      <div class="allocation-details">
        <p><strong>Registration:</strong> ${workload.regNo}</p>
        <p><strong>Total Units:</strong> ${workload.totalUnits}</p>
        ${workload.classes.slice(0, 3).map(cls => `
          <div class="allocation-item" style="margin-top: 8px;">
            <div class="allocation-item-header">
              <div class="class-name">${cls.className}</div>
              <small>${cls.units.length} units</small>
            </div>
            ${cls.units.slice(0, 2).map(unit => `
              <div class="unit-name" style="font-size: 0.8rem;">• ${getUnitName(unit)}</div>
            `).join('')}
            ${cls.units.length > 2 ? `<div class="unit-name" style="font-size: 0.8rem;">+ ${cls.units.length - 2} more units</div>` : ''}
          </div>
        `).join('')}
        ${workload.classes.length > 3 ? `
          <div style="text-align: center; margin-top: 10px; color: var(--primary);">
            + ${workload.classes.length - 3} more classes
          </div>
        ` : ''}
      </div>
    `;
    container.appendChild(allocationCard);
  });
  
  if (sortedTrainers.length === 0) {
    container.innerHTML = `
      <div class="allocation-card">
        <div class="allocation-card-header">
          <div class="trainer-name">No Active Allocations</div>
        </div>
        <div class="allocation-details">
          <p style="color: #666; text-align: center;">Allocate classes to trainers to see workload</p>
        </div>
      </div>
    `;
  }
}

// Get unit name from unit ID or string
function getUnitName(unitId) {
  if (units[unitId]) {
    return `${units[unitId].unitCode || ''} - ${units[unitId].unitName || ''}`.trim();
  }
  return unitId; // Return the ID if unit not found
}

// Render trainers table (dashboard)
function renderTrainersTable() {
  const tbody = document.getElementById('trainersTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (Object.keys(trainers).length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">No trainers found. Add your first trainer!</td></tr>';
    return;
  }
  
  // Show only recent 5 trainers
  const recentTrainers = Object.entries(trainers)
    .sort((a, b) => (b[1].timestamp || 0) - (a[1].timestamp || 0))
    .slice(0, 5);
  
  recentTrainers.forEach(([id, trainer]) => {
    // Count allocations for this trainer
    const trainerAllocations = Object.values(allocations).filter(alloc => 
      alloc.trainerId === id && alloc.status === 'Active'
    ).length;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${trainer.regNo || 'N/A'}</strong></td>
      <td><strong>${trainer.fullName || ''}</strong></td>
      <td>${trainer.email || ''}</td>
      <td>${trainer.phone || ''}</td>
      <td>${trainer.department || ''}</td>
      <td><span class="status-badge ${trainerAllocations > 0 ? 'active' : 'inactive'}">${trainerAllocations} allocation${trainerAllocations !== 1 ? 's' : ''}</span></td>
      <td><span class="status-badge ${trainer.status === 'Active' ? 'active' : 'inactive'}">${trainer.status || ''}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-info" onclick="editTrainer('${id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="btn-danger" onclick="deleteTrainer('${id}')" title="Delete"><i class="fas fa-trash"></i></button>
          <button class="btn-purple" onclick="allocateToTrainer('${id}')" title="Allocate Classes"><i class="fas fa-calendar-plus"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Render trainers full table
function renderTrainersFullTable() {
  const tbody = document.getElementById('trainersFullTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (Object.keys(trainers).length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px; color: #666;">No trainers found. Add your first trainer!</td></tr>';
    return;
  }
  
  // Sort trainers by registration number
  const sortedTrainers = Object.entries(trainers).sort((a, b) => {
    const regA = a[1].regNo || '0000';
    const regB = b[1].regNo || '0000';
    return regA.localeCompare(regB);
  });
  
  sortedTrainers.forEach(([id, trainer]) => {
    // Get allocations for this trainer
    const trainerAllocations = Object.values(allocations).filter(alloc => 
      alloc.trainerId === id && alloc.status === 'Active'
    );
    
    const uniqueClasses = new Set();
    let totalUnits = 0;
    
    trainerAllocations.forEach(alloc => {
      if (alloc.className) uniqueClasses.add(alloc.className);
      if (alloc.units) totalUnits += alloc.units.length;
    });
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${trainer.regNo || 'N/A'}</strong></td>
      <td><strong>${trainer.fullName || ''}</strong></td>
      <td>${trainer.email || ''}</td>
      <td>${trainer.phone || ''}</td>
      <td>${trainer.department || ''}</td>
      <td><span class="status-badge ${uniqueClasses.size > 0 ? 'active' : 'inactive'}">${uniqueClasses.size} class${uniqueClasses.size !== 1 ? 'es' : ''}</span></td>
      <td><span class="status-badge ${totalUnits > 0 ? 'active' : 'inactive'}">${totalUnits} unit${totalUnits !== 1 ? 's' : ''}</span></td>
      <td>${trainer.qualification || ''}</td>
      <td><span class="status-badge ${trainer.status === 'Active' ? 'active' : 'inactive'}">${trainer.status || ''}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-info" onclick="editTrainer('${id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="btn-danger" onclick="deleteTrainer('${id}')" title="Delete"><i class="fas fa-trash"></i></button>
          <button class="btn-purple" onclick="allocateToTrainer('${id}')" title="Allocate Classes"><i class="fas fa-calendar-plus"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Render allocations table
function renderAllocationsTable() {
  const tbody = document.getElementById('allocationsTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (Object.keys(allocations).length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #666;">No allocations found. Start allocating classes to trainers!</td></tr>';
    return;
  }
  
  // Sort allocations by date (newest first)
  const sortedAllocations = Object.entries(allocations).sort((a, b) => {
    return (b[1].timestamp || 0) - (a[1].timestamp || 0);
  });
  
  sortedAllocations.forEach(([id, allocation]) => {
    const trainer = trainers[allocation.trainerId] || {};
    const classData = classes[allocation.classId] || {};
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${trainer.fullName || allocation.trainerName || 'Unknown'}</strong></td>
      <td>${trainer.regNo || 'N/A'}</td>
      <td>${classData.className || allocation.className || 'Unknown'}</td>
      <td>${classData.courseCode || allocation.classCode || 'N/A'}</td>
      <td>${(allocation.units || []).slice(0, 2).map(unit => getUnitName(unit)).join(', ')}
          ${(allocation.units || []).length > 2 ? ` +${(allocation.units || []).length - 2} more` : ''}</td>
      <td>${allocation.allocationDate || 'N/A'}</td>
      <td><span class="status-badge ${allocation.status === 'Active' ? 'active' : 
                                      allocation.status === 'Completed' ? 'success' : 
                                      allocation.status === 'Pending' ? 'pending' : 'inactive'}">${allocation.status || 'Active'}</span></td>
      <td>
        <div class="action-buttons">
          <button class="btn-info" onclick="editAllocation('${id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="btn-danger" onclick="deleteAllocation('${id}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Render departments table
function renderDepartmentsTable() {
  const tbody = document.getElementById('departmentsTableBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  if (Object.keys(departments).length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #666;">No departments found. Add your first department!</td></tr>';
    return;
  }
  
  // Sort departments alphabetically
  const sortedDepartments = Object.entries(departments).sort((a, b) => 
    a[0].localeCompare(b[0])
  );
  
  sortedDepartments.forEach(([id, dept]) => {
    // Count trainers in this department
    const deptTrainers = Object.values(trainers).filter(trainer => 
      trainer.department === id
    ).length;
    
    // Count classes for this department's courses
    let deptClasses = 0;
    Object.values(classes).forEach(cls => {
      if (cls.department === id) {
        deptClasses++;
      }
    });
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${id}</strong></td>
      <td>${(dept.courses || []).join(', ') || 'No courses'}</td>
      <td><strong>${deptTrainers}</strong> trainer${deptTrainers !== 1 ? 's' : ''}</td>
      <td><strong>${deptClasses}</strong> class${deptClasses !== 1 ? 'es' : ''}</td>
      <td>
        <div class="action-buttons">
          <button class="btn-info" onclick="editDepartment('${id}')" title="Edit"><i class="fas fa-edit"></i></button>
          <button class="btn-danger" onclick="deleteDepartment('${id}')" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Modal functions
function openTrainerModal() {
  document.getElementById('trainerModal').style.display = 'flex';
  document.getElementById('trainerModalTitle').textContent = 'Add Trainer';
  editTrainerKey = null;
  resetTrainerForm();
}

function closeTrainerModal() {
  document.getElementById('trainerModal').style.display = 'none';
}

function resetTrainerForm() {
  document.getElementById('fullName').value = '';
  document.getElementById('email').value = '';
  document.getElementById('phone').value = '';
  document.getElementById('deptSelect').value = '';
  document.getElementById('statusSelect').value = 'Active';
  document.getElementById('qualification').value = '';
  document.getElementById('regNo').value = '';
  document.getElementById('specialization').value = '';
}

function openDepartmentModal() {
  document.getElementById('departmentModal').style.display = 'flex';
  document.getElementById('departmentModalTitle').textContent = 'Add Department';
  editDepartmentKey = null;
  resetDepartmentForm();
}

function closeDepartmentModal() {
  document.getElementById('departmentModal').style.display = 'none';
}

function resetDepartmentForm() {
  document.getElementById('departmentName').value = '';
  document.getElementById('departmentName').readOnly = false;
  document.getElementById('departmentCourses').value = '';
}

function openAllocationModal() {
  document.getElementById('allocationModal').style.display = 'flex';
  document.getElementById('allocationModalTitle').textContent = 'Allocate Class & Units';
  editAllocationKey = null;
  resetAllocationForm();
}

function closeAllocationModal() {
  document.getElementById('allocationModal').style.display = 'none';
}

function resetAllocationForm() {
  document.getElementById('allocTrainer').value = '';
  document.getElementById('allocClass').value = '';
  document.getElementById('allocUnit').innerHTML = '<option value="">-- Select Class First --</option>';
  document.getElementById('allocationDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('allocationStatus').value = 'Active';
  document.getElementById('allocationNotes').value = '';
}

function openManualAllocationModal() {
  document.getElementById('manualAllocationModal').style.display = 'flex';
  resetManualAllocationForm();
}

function closeManualAllocationModal() {
  document.getElementById('manualAllocationModal').style.display = 'none';
}

function resetManualAllocationForm() {
  document.getElementById('manualTrainerName').value = '';
  document.getElementById('manualClassName').value = '';
  document.getElementById('manualClassCode').value = '';
  document.getElementById('manualUnits').value = '';
  document.getElementById('manualAllocationDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('manualStatus').value = 'Active';
}

function openEditAllocationModal(allocationId) {
  const allocation = allocations[allocationId];
  if (!allocation) return;
  
  editAllocationKey = allocationId;
  
  const trainer = trainers[allocation.trainerId] || {};
  const classData = classes[allocation.classId] || {};
  
  document.getElementById('editAllocationId').value = allocationId;
  document.getElementById('editTrainer').value = trainer.fullName || allocation.trainerName || '';
  document.getElementById('editClass').value = classData.className || allocation.className || '';
  document.getElementById('editClassCode').value = classData.courseCode || allocation.classCode || '';
  document.getElementById('editUnits').value = (allocation.units || []).map(unit => getUnitName(unit)).join(', ');
  document.getElementById('editAllocationDate').value = allocation.allocationDate || new Date().toISOString().split('T')[0];
  document.getElementById('editStatus').value = allocation.status || 'Active';
  document.getElementById('editNotes').value = allocation.notes || '';
  
  document.getElementById('editAllocationModal').style.display = 'flex';
}

function closeEditAllocationModal() {
  document.getElementById('editAllocationModal').style.display = 'none';
}

// Allocate to specific trainer
function allocateToTrainer(trainerId) {
  openAllocationModal();
  setTimeout(() => {
    document.getElementById('allocTrainer').value = trainerId;
    updateTrainerClasses();
  }, 100);
}

// Save trainer
function saveTrainer() {
  const fullName = document.getElementById('fullName').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const department = document.getElementById('deptSelect').value;
  const qualification = document.getElementById('qualification').value.trim();
  const status = document.getElementById('statusSelect').value;
  const regNoInput = document.getElementById('regNo').value.trim();
  const specialization = document.getElementById('specialization').value.trim();

  if (!fullName || !email || !phone || !department || !qualification) {
    showErrorMessage('Please fill all required fields');
    return;
  }

  let regNo = regNoInput || '0001';
  if (!editTrainerKey && !regNoInput) {
    // Generate new registration number if not provided
    const regNos = Object.values(trainers).map(t => t.regNo).filter(r => r);
    if (regNos.length) {
      const maxReg = Math.max(...regNos.map(r => parseInt(r)));
      regNo = String(maxReg + 1).padStart(4, '0');
    }
  } else if (editTrainerKey && !regNoInput) {
    // Keep existing registration number
    regNo = trainers[editTrainerKey].regNo || '0001';
  }

  const trainerData = {
    fullName,
    email,
    phone,
    department,
    qualification,
    status,
    regNo,
    specialization,
    timestamp: Date.now()
  };

  if (editTrainerKey) {
    db.ref('trainers/' + editTrainerKey).update(trainerData)
      .then(() => {
        showSuccessMessage('Trainer updated successfully!');
        closeTrainerModal();
      })
      .catch(error => showErrorMessage('Error updating trainer: ' + error.message));
  } else {
    const newRef = db.ref('trainers').push();
    trainerData.id = newRef.key;
    newRef.set(trainerData)
      .then(() => {
        showSuccessMessage('Trainer added successfully!');
        closeTrainerModal();
      })
      .catch(error => showErrorMessage('Error adding trainer: ' + error.message));
  }
}

// Save department
function saveDepartment() {
  const deptName = document.getElementById('departmentName').value.trim();
  const coursesText = document.getElementById('departmentCourses').value.trim();

  if (!deptName) {
    showErrorMessage('Please enter department name');
    return;
  }

  const courses = coursesText ? coursesText.split('\n').map(c => c.trim()).filter(c => c) : [];

  const departmentData = {
    courses,
    timestamp: Date.now()
  };

  if (editDepartmentKey) {
    db.ref('departments/' + editDepartmentKey).update(departmentData)
      .then(() => {
        showSuccessMessage('Department updated successfully!');
        closeDepartmentModal();
      })
      .catch(error => showErrorMessage('Error updating department: ' + error.message));
  } else {
    // Check if department already exists
    if (departments[deptName]) {
      showErrorMessage('Department already exists!');
      return;
    }
    
    db.ref('departments/' + deptName).set(departmentData)
      .then(() => {
        showSuccessMessage('Department added successfully!');
        closeDepartmentModal();
      })
      .catch(error => showErrorMessage('Error adding department: ' + error.message));
  }
}

// Save allocation
function saveAllocation() {
  const trainerId = document.getElementById('allocTrainer').value;
  const classId = document.getElementById('allocClass').value;
  const unitElements = document.getElementById('allocUnit').selectedOptions;
  const allocationDate = document.getElementById('allocationDate').value;
  const status = document.getElementById('allocationStatus').value;
  const notes = document.getElementById('allocationNotes').value.trim();

  if (!trainerId || !classId || unitElements.length === 0 || !allocationDate) {
    showErrorMessage('Please fill all required fields and select at least one unit');
    return;
  }

  const trainer = trainers[trainerId];
  const classData = classes[classId];
  
  if (!trainer || !classData) {
    showErrorMessage('Invalid trainer or class selection');
    return;
  }

  // Get selected unit IDs
  const units = Array.from(unitElements).map(option => option.value);

  const allocationData = {
    trainerId,
    trainerName: trainer.fullName,
    trainerRegNo: trainer.regNo,
    classId,
    className: classData.className,
    classCode: classData.courseCode,
    units,
    allocationDate,
    status,
    notes,
    timestamp: Date.now()
  };

  // Check if trainer already has this class allocated
  const existingAllocation = Object.entries(allocations).find(([id, alloc]) => 
    alloc.trainerId === trainerId && 
    alloc.classId === classId && 
    alloc.status === 'Active'
  );

  if (existingAllocation && !confirm('This trainer already has this class allocated. Update existing allocation?')) {
    return;
  }

  if (existingAllocation) {
    // Update existing allocation
    db.ref('trainer_allocations/' + existingAllocation[0]).update(allocationData)
      .then(() => {
        showSuccessMessage('Allocation updated successfully!');
        closeAllocationModal();
      })
      .catch(error => showErrorMessage('Error updating allocation: ' + error.message));
  } else {
    // Create new allocation
    const newRef = db.ref('trainer_allocations').push();
    newRef.set(allocationData)
      .then(() => {
        showSuccessMessage('Allocation created successfully!');
        closeAllocationModal();
      })
      .catch(error => showErrorMessage('Error creating allocation: ' + error.message));
  }
}

// Save manual allocation
function saveManualAllocation() {
  const trainerName = document.getElementById('manualTrainerName').value.trim();
  const className = document.getElementById('manualClassName').value.trim();
  const classCode = document.getElementById('manualClassCode').value.trim();
  const unitsText = document.getElementById('manualUnits').value.trim();
  const allocationDate = document.getElementById('manualAllocationDate').value;
  const status = document.getElementById('manualStatus').value;

  if (!trainerName || !className || !unitsText || !allocationDate) {
    showErrorMessage('Please fill all required fields');
    return;
  }

  const units = unitsText.split(',').map(unit => unit.trim()).filter(unit => unit);

  const allocationData = {
    trainerName,
    className,
    classCode,
    units,
    allocationDate,
    status,
    notes: 'Manual allocation entry',
    timestamp: Date.now()
  };

  const newRef = db.ref('trainer_allocations').push();
  newRef.set(allocationData)
    .then(() => {
      showSuccessMessage('Manual allocation saved successfully!');
      closeManualAllocationModal();
    })
    .catch(error => showErrorMessage('Error saving manual allocation: ' + error.message));
}

// Update allocation
function updateAllocation() {
  const allocationId = document.getElementById('editAllocationId').value;
  const unitsText = document.getElementById('editUnits').value.trim();
  const allocationDate = document.getElementById('editAllocationDate').value;
  const status = document.getElementById('editStatus').value;
  const notes = document.getElementById('editNotes').value.trim();

  if (!allocationId || !unitsText || !allocationDate) {
    showErrorMessage('Please fill all required fields');
    return;
  }

  const units = unitsText.split(',').map(unit => unit.trim()).filter(unit => unit);

  const updateData = {
    units,
    allocationDate,
    status,
    notes,
    updatedAt: Date.now()
  };

  db.ref('trainer_allocations/' + allocationId).update(updateData)
    .then(() => {
      showSuccessMessage('Allocation updated successfully!');
      closeEditAllocationModal();
    })
    .catch(error => showErrorMessage('Error updating allocation: ' + error.message));
}

// Edit trainer
function editTrainer(key) {
  editTrainerKey = key;
  const trainer = trainers[key];
  
  if (!trainer) return;
  
  document.getElementById('trainerModalTitle').textContent = 'Edit Trainer';
  document.getElementById('fullName').value = trainer.fullName || '';
  document.getElementById('email').value = trainer.email || '';
  document.getElementById('phone').value = trainer.phone || '';
  document.getElementById('deptSelect').value = trainer.department || '';
  document.getElementById('statusSelect').value = trainer.status || 'Active';
  document.getElementById('qualification').value = trainer.qualification || '';
  document.getElementById('regNo').value = trainer.regNo || '';
  document.getElementById('specialization').value = trainer.specialization || '';
  
  document.getElementById('trainerModal').style.display = 'flex';
}

// Edit department
function editDepartment(key) {
  editDepartmentKey = key;
  const dept = departments[key];
  
  if (!dept) return;
  
  document.getElementById('departmentModalTitle').textContent = 'Edit Department';
  document.getElementById('departmentName').value = key;
  document.getElementById('departmentName').readOnly = true;
  document.getElementById('departmentCourses').value = (dept.courses || []).join('\n');
  
  document.getElementById('departmentModal').style.display = 'flex';
}

// Edit allocation
function editAllocation(allocationId) {
  openEditAllocationModal(allocationId);
}

// Delete trainer
function deleteTrainer(key) {
  if (!confirm('Are you sure you want to delete this trainer? This will also delete all their allocations.')) {
    return;
  }
  
  // Delete trainer's allocations first
  const trainerAllocations = Object.entries(allocations).filter(([id, alloc]) => 
    alloc.trainerId === key
  );
  
  const deletePromises = trainerAllocations.map(([id, alloc]) => 
    db.ref('trainer_allocations/' + id).remove()
  );
  
  Promise.all(deletePromises)
    .then(() => {
      // Now delete the trainer
      return db.ref('trainers/' + key).remove();
    })
    .then(() => showSuccessMessage('Trainer and their allocations deleted successfully!'))
    .catch(error => showErrorMessage('Error deleting trainer: ' + error.message));
}

// Delete department
function deleteDepartment(key) {
  // Check if any trainers are assigned to this department
  const trainersInDept = Object.values(trainers).filter(trainer => 
    trainer.department === key
  ).length;
  
  if (trainersInDept > 0) {
    if (!confirm(`There are ${trainersInDept} trainer(s) assigned to this department. Deleting it will remove their department assignment. Continue?`)) {
      return;
    }
  } else {
    if (!confirm('Are you sure you want to delete this department?')) {
      return;
    }
  }
  
  db.ref('departments/' + key).remove()
    .then(() => showSuccessMessage('Department deleted successfully!'))
    .catch(error => showErrorMessage('Error deleting department: ' + error.message));
}

// Delete allocation
function deleteAllocation(key) {
  if (!confirm('Are you sure you want to delete this allocation?')) {
    return;
  }
  
  db.ref('trainer_allocations/' + key).remove()
    .then(() => showSuccessMessage('Allocation deleted successfully!'))
    .catch(error => showErrorMessage('Error deleting allocation: ' + error.message));
}

// Settings functions
function saveSystemSettings() {
  showSuccessMessage('System settings saved successfully!');
}

function exportData() {
  const data = {
    trainers: trainers,
    departments: departments,
    classes: classes,
    units: units,
    allocations: allocations,
    exportedAt: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `ucst_trainers_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showSuccessMessage('Data exported successfully!');
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => { 
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (confirm('This will overwrite all existing data. Are you sure?')) {
          // Import all data
          const promises = [];
          
          if (data.trainers) {
            promises.push(db.ref('trainers').set(data.trainers));
          }
          
          if (data.departments) {
            promises.push(db.ref('departments').set(data.departments));
          }
          
          if (data.classes) {
            promises.push(db.ref('classes').set(data.classes));
          }
          
          if (data.units) {
            promises.push(db.ref('units').set(data.units));
          }
          
          if (data.allocations) {
            promises.push(db.ref('trainer_allocations').set(data.allocations));
          }
          
          Promise.all(promises)
            .then(() => showSuccessMessage('Data imported successfully!'))
            .catch(error => showErrorMessage('Error importing data: ' + error.message));
        }
      } catch (error) {
        showErrorMessage('Error importing data: Invalid file format');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function clearAllData() {
  if (!confirm('WARNING: This will delete ALL data. This action cannot be undone. Are you absolutely sure?')) {
    return;
  }
  
  if (!confirm('FINAL WARNING: All data will be permanently deleted. Type "DELETE" to confirm.')) {
    return;
  }
  
  const userInput = prompt('Please type DELETE to confirm:');
  if (userInput !== 'DELETE') {
    showErrorMessage('Data deletion cancelled.');
    return;
  }
  
  // Clear all data from Firebase
  const promises = [
    db.ref('trainers').remove(),
    db.ref('departments').remove(),
    db.ref('trainer_allocations').remove()
  ];
  
  Promise.all(promises)
    .then(() => {
      showSuccessMessage('All data cleared successfully!');
    })
    .catch(error => showErrorMessage('Error clearing data: ' + error.message));
}

// Show success message
function showSuccessMessage(message) {
  const successMsg = document.getElementById('successMessage');
  const successText = document.getElementById('successMessageText');
  
  if (successMsg && successText) {
    successText.textContent = message;
    successMsg.classList.add('show');
    
    setTimeout(() => {
      successMsg.classList.remove('show');
    }, 3000);
  }
}

// Show error message
function showErrorMessage(message) {
  alert(message);
}

// Initialize the application
window.onload = function() {
  // Any additional initialization code
};
</script>
</body>
</html>