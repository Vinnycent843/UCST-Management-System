<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCST Integrated Management System - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-blue: #1a73e8;
            --primary-dark: #202124;
            --primary-light: #f8f9fa;
            --accent-green: #0d904f;
            --accent-orange: #ff6d00;
            --accent-red: #d93025;
            --accent-purple: #8e44ad;
            --border-radius: 12px;
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Georgia, 'Times New Roman', Times, serif;
        }

        body {
            background: var(--primary-light);
            color: #333;
            transition: var(--transition);
            line-height: 1.6;
            overflow-x: hidden;
        }

        body.dark {
            background: #121212;
            color: #e0e0e0;
        }

        /* Login Container */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
            padding: 20px;
        }

        .login-box {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 400px;
            padding: 40px;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        .dark .login-box {
            background: #1e1e1e;
            color: #e0e0e0;
        }

        .login-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .login-logo .logo-icon {
            font-size: 48px;
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
            color: white;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .login-logo h1 {
            font-size: 24px;
            color: var(--primary-blue);
            margin-bottom: 5px;
        }

        .login-logo .subtitle {
            font-size: 14px;
            color: #666;
        }

        .dark .login-logo .subtitle {
            color: #aaa;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .dark .form-group label {
            color: #ccc;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }

        .dark .form-control {
            background: #252525;
            border-color: #444;
            color: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            width: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0d62d9, #0b5cd6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border-left: 4px solid var(--accent-red);
        }

        .dark .login-error {
            background: #2c1619;
            color: #f5c6cb;
        }

        .login-footer {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .dark .login-footer {
            color: #aaa;
        }

        /* Main Application (Initially Hidden) */
        #mainApp {
            display: none;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Header */
        .main-header {
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 32px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .logo .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .header-controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .search-container {
            position: relative;
            width: 300px;
        }

        #searchBox {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 14px;
            transition: var(--transition);
        }

        #searchBox:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            width: 350px;
        }

        #searchBox::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(30deg);
        }

        /* Navigation */
        .main-nav {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 88px;
            z-index: 999;
        }

        .dark .main-nav {
            background: #1e1e1e;
            border-bottom-color: #333;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .nav-tabs {
            display: flex;
            list-style: none;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 18px 25px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dark .nav-tab {
            color: #aaa;
        }

        .nav-tab:hover {
            color: var(--primary-blue);
            background: rgba(26, 115, 232, 0.05);
        }

        .nav-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background: rgba(26, 115, 232, 0.1);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
            min-height: calc(100vh - 160px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Tab */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
            color: white;
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        .welcome-banner h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .welcome-banner p {
            opacity: 0.9;
            max-width: 600px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border-top: 4px solid var(--primary-blue);
        }

        .dark .stat-card {
            background: #1e1e1e;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 20px;
            color: white;
        }

        .stat-card:nth-child(1) .icon { background: var(--primary-blue); }
        .stat-card:nth-child(2) .icon { background: var(--accent-green); }
        .stat-card:nth-child(3) .icon { background: var(--accent-orange); }
        .stat-card:nth-child(4) .icon { background: var(--accent-purple); }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .dark .stat-card h3 {
            color: #aaa;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .trend {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .trend.up { color: var(--accent-green); }
        .trend.down { color: var(--accent-red); }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .dark .chart-container {
            background: #1e1e1e;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-header h3 {
            color: var(--primary-blue);
            font-size: 18px;
        }

        /* Recent Activity */
        .recent-activity {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
        }

        .dark .recent-activity {
            background: #1e1e1e;
        }

        .activity-list {
            margin-top: 20px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .activity-item:hover {
            background: rgba(26, 115, 232, 0.05);
        }

        .dark .activity-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .activity-icon.payment { background: var(--accent-green); }
        .activity-icon.admission { background: var(--primary-blue); }
        .activity-icon.exam { background: var(--accent-orange); }
        .activity-icon.hostel { background: var(--accent-purple); }

        .activity-content {
            flex: 1;
        }

        .activity-time {
            font-size: 12px;
            color: #666;
        }

        .dark .activity-time {
            color: #aaa;
        }

        /* Finance Tab */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: var(--primary-blue);
            font-size: 24px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-success {
            background: var(--accent-green);
            color: white;
        }

        .btn-success:hover {
            background: #0b7a3d;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--accent-orange);
            color: white;
        }

        .btn-warning:hover {
            background: #e65c00;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #c5221f;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary-blue);
            color: var(--primary-blue);
        }

        .btn-outline:hover {
            background: rgba(26, 115, 232, 0.1);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Filters */
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dark .filters-section {
            background: #1e1e1e;
        }

        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .dark .filter-group label {
            color: #ccc;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: white;
        }

        .dark .filter-group select,
        .dark .filter-group input {
            background: #252525;
            border-color: #444;
            color: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .dark .table-container {
            background: #1e1e1e;
        }

        .responsive-table {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead {
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
        }

        th {
            padding: 18px 15px;
            text-align: left;
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-bottom: 1px solid #eee;
            transition: var(--transition);
        }

        .dark tbody tr {
            border-bottom-color: #333;
        }

        tbody tr:hover {
            background: rgba(26, 115, 232, 0.05);
        }

        .dark tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        td {
            padding: 16px 15px;
            vertical-align: middle;
        }

        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
        }

        .status-unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .status-partial {
            background: #fff3cd;
            color: #856404;
        }

        /* Module Details */
        .module-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .module-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid var(--primary-blue);
        }

        .dark .module-row {
            background: #2d3748;
        }

        .module-name {
            font-weight: 600;
            color: #555;
            min-width: 80px;
        }

        .dark .module-name {
            color: #ccc;
        }

        .module-amounts {
            display: flex;
            gap: 15px;
        }

        .module-total { color: #666; }
        .module-paid { color: var(--accent-green); font-weight: 600; }
        .module-balance { color: var(--accent-red); font-weight: 600; }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .dark .info-card {
            background: #1e1e1e;
        }

        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .info-card h3 {
            color: var(--primary-blue);
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-card .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .dark .info-card .info-item {
            border-bottom-color: #333;
        }

        .info-card .info-item:last-child {
            border-bottom: none;
            font-weight: 600;
            color: var(--primary-blue);
        }

        /* Exam Results */
        .results-table {
            min-width: 800px;
        }

        .results-table th {
            background: linear-gradient(135deg, var(--accent-orange), #e65100);
        }

        .grade-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .grade-distinction {
            background: #d4edda;
            color: #155724;
        }

        .grade-credit {
            background: #d1ecf1;
            color: #0c5460;
        }

        .grade-pass {
            background: #fff3cd;
            color: #856404;
        }

        .grade-fail {
            background: #f8d7da;
            color: #721c24;
        }

        /* Modal System */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.4s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .dark .modal-content {
            background: #1e1e1e;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-blue), #0d47a1);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: calc(90vh - 100px);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px 25px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .dark .modal-actions {
            background: #252525;
            border-top-color: #333;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: var(--box-shadow);
            transform: translateX(-100%);
            transition: var(--transition);
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .dark .sidebar {
            background: #1e1e1e;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark .sidebar-header {
            border-bottom-color: #333;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-group {
            margin-bottom: 30px;
        }

        .nav-group-title {
            padding: 10px 25px;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .dark .nav-group-title {
            color: #aaa;
        }

        .nav-item {
            padding: 12px 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #555;
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .dark .nav-item {
            color: #ccc;
        }

        .nav-item:hover {
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary-blue);
            border-left-color: var(--primary-blue);
        }

        .nav-item.active {
            background: rgba(26, 115, 232, 0.15);
            color: var(--primary-blue);
            border-left-color: var(--primary-blue);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-header, .nav-container, .main-content {
                padding: 20px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .search-container {
                width: 200px;
            }
            
            #searchBox:focus {
                width: 250px;
            }
            
            .header-controls {
                gap: 10px;
            }
            
            .nav-tab {
                padding: 15px;
                font-size: 14px;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .modal-content {
                margin: 10px;
                max-height: 85vh;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 18px;
            }
            
            .logo .subtitle {
                font-size: 12px;
            }
            
            .welcome-banner {
                padding: 25px;
            }
            
            .welcome-banner h2 {
                font-size: 22px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 20px;
            display: block;
        }

        .dark .empty-state {
            color: #aaa;
        }

        .dark .empty-state i {
            color: #444;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .quick-action-btn {
            background: white;
            border: none;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .dark .quick-action-btn {
            background: #1e1e1e;
        }

        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            background: rgba(26, 115, 232, 0.05);
        }

        .quick-action-btn i {
            font-size: 24px;
            color: var(--primary-blue);
        }

        .quick-action-btn span {
            font-weight: 500;
            color: #333;
        }

        .dark .quick-action-btn span {
            color: #e0e0e0;
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .dark .page-btn {
            background: #1e1e1e;
            border-color: #444;
        }

        .page-btn:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .page-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--accent-green);
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--accent-red);
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--accent-orange);
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid var(--primary-blue);
        }

        /* Logout Button */
        .logout-btn {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
    </style>
</head>
<body>
    <!-- Login Form (Initially Visible) -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">
                <div class="logo-icon">
                    <i class="fas fa-university"></i>
                </div>
                <h1>UCST Management System</h1>
                <div class="subtitle">Integrated Academic & Financial Platform</div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-circle"></i> Invalid username or password
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application (Initially Hidden) -->
    <div id="mainApp">
        <!-- Header -->
        <header class="main-header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div>
                        <h1>UCST Management System</h1>
                        <div class="subtitle">Integrated Academic & Financial Platform</div>
                    </div>
                </div>
            </div>
            
            <div class="header-controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchBox" placeholder="Search students, courses, payments...">
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="notification-icon" onclick="showNotifications()" style="position: relative; cursor: pointer;">
                    <i class="fas fa-bell" style="font-size: 20px; color: white;"></i>
                    <span class="notification-badge">3</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="main-nav">
            <div class="nav-container">
                <ul class="nav-tabs">
                    <li class="nav-tab active" data-tab="dashboard">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </li>
                    <li class="nav-tab" data-tab="finance">
                        <i class="fas fa-money-bill-wave"></i> Finance
                    </li>
                    <li class="nav-tab" data-tab="students">
                        <i class="fas fa-users"></i> Students
                    </li>
                    <li class="nav-tab" data-tab="courses">
                        <i class="fas fa-book"></i> Courses
                    </li>
                    <li class="nav-tab" data-tab="exams">
                        <i class="fas fa-clipboard-check"></i> Exams
                    </li>
                    <li class="nav-tab" data-tab="hostel">
                        <i class="fas fa-bed"></i> Hostel
                    </li>
                    <li class="nav-tab" data-tab="classes">
                        <i class="fas fa-chalkboard-teacher"></i> Classes
                    </li>
                    <li class="nav-tab" data-tab="reports">
                        <i class="fas fa-chart-bar"></i> Reports
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Quick Navigation</h3>
                <button class="close-modal" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-group">
                    <div class="nav-group-title">Dashboard</div>
                    <a href="#" class="nav-item active" onclick="switchTab('dashboard')">
                        <i class="fas fa-home"></i> Overview
                    </a>
                    <a href="#" class="nav-item" onclick="switchTab('reports')">
                        <i class="fas fa-chart-line"></i> Analytics
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Student Management</div>
                    <a href="#" class="nav-item" onclick="switchTab('students')">
                        <i class="fas fa-user-graduate"></i> All Students
                    </a>
                    <a href="#" class="nav-item" onclick="openModal('addStudentModal')">
                        <i class="fas fa-user-plus"></i> Add Student
                    </a>
                    <a href="#" class="nav-item" onclick="switchTab('classes')">
                        <i class="fas fa-users-class"></i> Class Lists
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Academic</div>
                    <a href="#" class="nav-item" onclick="switchTab('courses')">
                        <i class="fas fa-book-open"></i> Courses
                    </a>
                    <a href="#" class="nav-item" onclick="switchTab('exams')">
                        <i class="fas fa-file-signature"></i> Exams
                    </a>
                    <a href="#" class="nav-item" onclick="switchTab('results')">
                        <i class="fas fa-award"></i> Results
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Finance</div>
                    <a href="#" class="nav-item" onclick="switchTab('finance')">
                        <i class="fas fa-wallet"></i> Financial Records
                    </a>
                    <a href="#" class="nav-item" onclick="openModal('recordPaymentModal')">
                        <i class="fas fa-money-check-alt"></i> Record Payment
                    </a>
                    <a href="#" class="nav-item" onclick="openModal('addFeeModal')">
                        <i class="fas fa-file-invoice-dollar"></i> Add Fee
                    </a>
                </div>
                
                <div class="nav-group">
                    <div class="nav-group-title">Accommodation</div>
                    <a href="#" class="nav-item" onclick="switchTab('hostel')">
                        <i class="fas fa-building"></i> Hostel Management
                    </a>
                    <a href="#" class="nav-item" onclick="openModal('allocateHostelModal')">
                        <i class="fas fa-key"></i> Allocate Room
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="welcome-banner">
                    <h2>Welcome to UCST Management System</h2>
                    <p>Manage students, courses, finances, exams, and hostel allocations from one unified platform.</p>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="openModal('addStudentModal')">
                        <i class="fas fa-user-plus"></i>
                        <span>Add Student</span>
                    </button>
                    <button class="quick-action-btn" onclick="openModal('recordPaymentModal')">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Record Payment</span>
                    </button>
                    <button class="quick-action-btn" onclick="openModal('addExamModal')">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Schedule Exam</span>
                    </button>
                    <button class="quick-action-btn" onclick="openModal('allocateHostelModal')">
                        <i class="fas fa-bed"></i>
                        <span>Allocate Hostel</span>
                    </button>
                </div>

                <!-- Statistics Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Total Students</h3>
                        <div class="value" id="totalStudents">0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>12% from last month</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-money-bill"></i>
                        </div>
                        <h3>Revenue Collected</h3>
                        <div class="value" id="totalRevenue">KES 0</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>8% from last month</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h3>Outstanding Balance</h3>
                        <div class="value" id="totalBalance">KES 0</div>
                        <div class="trend down">
                            <i class="fas fa-arrow-down"></i>
                            <span>5% from last month</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>Collection Rate</h3>
                        <div class="value" id="collectionRate">0%</div>
                        <div class="trend up">
                            <i class="fas fa-arrow-up"></i>
                            <span>3% from last month</span>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Revenue Trend</h3>
                            <select class="form-control" style="width: auto;">
                                <option>Last 7 days</option>
                                <option>Last 30 days</option>
                                <option>Last 3 months</option>
                            </select>
                        </div>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3>Student Distribution</h3>
                            <select class="form-control" style="width: auto;">
                                <option>By Course</option>
                                <option>By Gender</option>
                                <option>By Status</option>
                            </select>
                        </div>
                        <canvas id="studentDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="activityList">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Finance Tab -->
            <div id="finance" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-money-bill-wave"></i> Financial Management</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('recordPaymentModal')">
                            <i class="fas fa-plus"></i> Record Payment
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel('finance')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-outline" onclick="generateFinancialReport()">
                            <i class="fas fa-file-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Course</label>
                            <select id="financeCourseFilter">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Payment Status</label>
                            <select id="financeStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="paid">Paid</option>
                                <option value="partial">Partial</option>
                                <option value="unpaid">Unpaid</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date" id="financeDateFrom">
                        </div>
                        <div class="filter-group">
                            <label>To</label>
                            <input type="date" id="financeDateTo">
                        </div>
                    </div>
                </div>

                <!-- Financial Summary -->
                <div class="cards-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-chart-pie"></i> Fee Distribution</h3>
                        <div class="info-item">
                            <span>Course Fees</span>
                            <span id="courseFeesTotal">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Examination Fees</span>
                            <span id="examFeesTotal">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Hostel Fees</span>
                            <span id="hostelFeesTotal">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Other Fees</span>
                            <span id="otherFeesTotal">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Total Revenue</span>
                            <span id="totalRevenueSummary">KES 0</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="fas fa-percentage"></i> Collection Summary</h3>
                        <div class="info-item">
                            <span>Total Amount Due</span>
                            <span id="totalAmountDue">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Amount Collected</span>
                            <span id="amountCollected">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Outstanding Balance</span>
                            <span id="outstandingBalance">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Collection Rate</span>
                            <span id="collectionRateSummary">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Financial Records Table -->
                <div class="table-container">
                    <div class="responsive-table">
                        <table id="financeTable">
                            <thead>
                                <tr>
                                    <th>Adm No</th>
                                    <th>Student Name</th>
                                    <th>Course</th>
                                    <th>Annual Fee</th>
                                    <th>Module Payments</th>
                                    <th>Additional Fees</th>
                                    <th>Total Paid</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="financeTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Students Tab -->
            <div id="students" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> Student Management</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addStudentModal')">
                            <i class="fas fa-user-plus"></i> Add Student
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel('students')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                        <button class="btn btn-warning" onclick="bulkSmsStudents()">
                            <i class="fas fa-sms"></i> Send SMS
                        </button>
                    </div>
                </div>

                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Course</label>
                            <select id="studentCourseFilter">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Gender</label>
                            <select id="studentGenderFilter">
                                <option value="">All Genders</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Sponsorship</label>
                            <select id="studentSponsorFilter">
                                <option value="">All Sponsors</option>
                                <option value="NYS">NYS</option>
                                <option value="Self Sponsored">Self Sponsored</option>
                                <option value="HELB">HELB</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="studentStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="responsive-table">
                        <table id="studentsTable">
                            <thead>
                                <tr>
                                    <th>Adm No</th>
                                    <th>Full Name</th>
                                    <th>Gender</th>
                                    <th>Course</th>
                                    <th>Level</th>
                                    <th>Sponsorship</th>
                                    <th>Annual Fee</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Courses Tab -->
            <div id="courses" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-book"></i> Course Management</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addCourseModal')">
                            <i class="fas fa-plus"></i> Add Course
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel('courses')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-info-circle"></i> Course Summary</h3>
                        <div class="info-item">
                            <span>Total Courses</span>
                            <span id="totalCourses">0</span>
                        </div>
                        <div class="info-item">
                            <span>Diploma Courses</span>
                            <span id="diplomaCourses">0</span>
                        </div>
                        <div class="info-item">
                            <span>Certificate Courses</span>
                            <span id="certificateCourses">0</span>
                        </div>
                        <div class="info-item">
                            <span>Active Courses</span>
                            <span id="activeCourses">0</span>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="responsive-table">
                        <table id="coursesTable">
                            <thead>
                                <tr>
                                    <th>Course Code</th>
                                    <th>Course Name</th>
                                    <th>Department</th>
                                    <th>Level</th>
                                    <th>Annual Fee</th>
                                    <th>Exam Body</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="coursesTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Exams Tab -->
            <div id="exams" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-clipboard-check"></i> Examination Management</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addExamModal')">
                            <i class="fas fa-plus"></i> Schedule Exam
                        </button>
                        <button class="btn btn-warning" onclick="openModal('uploadResultsModal')">
                            <i class="fas fa-upload"></i> Upload Results
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel('exams')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                    </div>
                </div>

                <div class="filters-section">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label>Course</label>
                            <select id="examCourseFilter">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Exam Type</label>
                            <select id="examTypeFilter">
                                <option value="">All Types</option>
                                <option value="CAT">CAT</option>
                                <option value="Main">Main Exam</option>
                                <option value="Supplementary">Supplementary</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Semester</label>
                            <select id="examSemesterFilter">
                                <option value="">All Semesters</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                                <option value="3">Semester 3</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="examStatusFilter">
                                <option value="">All Statuses</option>
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="responsive-table">
                        <table id="examsTable">
                            <thead>
                                <tr>
                                    <th>Exam ID</th>
                                    <th>Exam Name</th>
                                    <th>Course</th>
                                    <th>Type</th>
                                    <th>Date</th>
                                    <th>Max Marks</th>
                                    <th>Semester</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="examsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="section-header" style="margin-top: 40px;">
                    <h2><i class="fas fa-award"></i> Examination Results</h2>
                </div>

                <div class="table-container">
                    <div class="responsive-table">
                        <table class="results-table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Adm No</th>
                                    <th>Exam</th>
                                    <th>Course</th>
                                    <th>Marks</th>
                                    <th>Grade</th>
                                    <th>Remarks</th>
                                    <th>Status</th>
                                    <th>Uploaded Date</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Hostel Tab -->
            <div id="hostel" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-bed"></i> Hostel Management</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('allocateHostelModal')">
                            <i class="fas fa-key"></i> Allocate Room
                        </button>
                        <button class="btn btn-warning" onclick="openModal('addHostelModal')">
                            <i class="fas fa-plus"></i> Add Hostel
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel('hostel')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-building"></i> Hostel Summary</h3>
                        <div class="info-item">
                            <span>Total Hostels</span>
                            <span id="totalHostels">0</span>
                        </div>
                        <div class="info-item">
                            <span>Male Hostels</span>
                            <span id="maleHostels">0</span>
                        </div>
                        <div class="info-item">
                            <span>Female Hostels</span>
                            <span id="femaleHostels">0</span>
                        </div>
                        <div class="info-item">
                            <span>Occupied Rooms</span>
                            <span id="occupiedRooms">0</span>
                        </div>
                        <div class="info-item">
                            <span>Available Rooms</span>
                            <span id="availableRooms">0</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="fas fa-users"></i> Allocation Summary</h3>
                        <div class="info-item">
                            <span>Total Students Hosted</span>
                            <span id="totalHostedStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Male Students</span>
                            <span id="maleHostedStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Female Students</span>
                            <span id="femaleHostedStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Hostel Fee Collection</span>
                            <span id="hostelFeeCollection">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Hostel Fee Balance</span>
                            <span id="hostelFeeBalance">KES 0</span>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="responsive-table">
                        <table id="hostelTable">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Adm No</th>
                                    <th>Gender</th>
                                    <th>Hostel</th>
                                    <th>Room Number</th>
                                    <th>Allocation Date</th>
                                    <th>Deallocation Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="hostelTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Classes Tab -->
            <div id="classes" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-chalkboard-teacher"></i> Class Management</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openModal('addClassModal')">
                            <i class="fas fa-plus"></i> Add Class
                        </button>
                        <button class="btn btn-success" onclick="exportToExcel('classes')">
                            <i class="fas fa-file-excel"></i> Export
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-chalkboard"></i> Class Summary</h3>
                        <div class="info-item">
                            <span>Total Classes</span>
                            <span id="totalClasses">0</span>
                        </div>
                        <div class="info-item">
                            <span>Active Classes</span>
                            <span id="activeClasses">0</span>
                        </div>
                        <div class="info-item">
                            <span>Total Capacity</span>
                            <span id="totalCapacity">0</span>
                        </div>
                        <div class="info-item">
                            <span>Enrolled Students</span>
                            <span id="enrolledStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Available Slots</span>
                            <span id="availableSlots">0</span>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="responsive-table">
                        <table id="classesTable">
                            <thead>
                                <tr>
                                    <th>Class Name</th>
                                    <th>Course</th>
                                    <th>Module</th>
                                    <th>Intake</th>
                                    <th>Capacity</th>
                                    <th>Enrolled</th>
                                    <th>Schedule</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="classesTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports" class="tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-chart-bar"></i> Comprehensive Reports</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="generateMonthlyReport()">
                            <i class="fas fa-file-pdf"></i> Monthly Report
                        </button>
                        <button class="btn btn-success" onclick="exportAllReports()">
                            <i class="fas fa-file-excel"></i> Export All
                        </button>
                        <button class="btn btn-warning" onclick="printReports()">
                            <i class="fas fa-print"></i> Print Reports
                        </button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-user-friends"></i> Gender-Based Report</h3>
                        <canvas id="genderReportChart"></canvas>
                        <div class="info-item">
                            <span>Male Students</span>
                            <span id="reportMaleStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Female Students</span>
                            <span id="reportFemaleStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Total Fees (Male)</span>
                            <span id="reportMaleFees">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Total Fees (Female)</span>
                            <span id="reportFemaleFees">KES 0</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3><i class="fas fa-graduation-cap"></i> Course-Level Report</h3>
                        <canvas id="courseLevelChart"></canvas>
                        <div class="info-item">
                            <span>Diploma Students</span>
                            <span id="reportDiplomaStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Certificate Students</span>
                            <span id="reportCertificateStudents">0</span>
                        </div>
                        <div class="info-item">
                            <span>Diploma Revenue</span>
                            <span id="reportDiplomaRevenue">KES 0</span>
                        </div>
                        <div class="info-item">
                            <span>Certificate Revenue</span>
                            <span id="reportCertificateRevenue">KES 0</span>
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div class="table-container">
                    <div class="section-header" style="margin: 20px;">
                        <h3>Fee Collection Details</h3>
                    </div>
                    <div class="responsive-table">
                        <table id="detailedReportTable">
                            <thead>
                                <tr>
                                    <th>Fee Type</th>
                                    <th>Total Amount</th>
                                    <th>Amount Paid</th>
                                    <th>Balance</th>
                                    <th>No. of Students</th>
                                    <th>Collection Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="detailedReportBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- MODALS -->
        
        <!-- Add Student Modal -->
        <div class="modal-overlay" id="addStudentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-user-plus"></i> Add New Student</h2>
                    <button class="close-modal" onclick="closeModal('addStudentModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Admission Number *</label>
                                <input type="text" class="form-control" id="studentAdmNo" required>
                            </div>
                            <div class="form-group">
                                <label>Full Name *</label>
                                <input type="text" class="form-control" id="studentName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Gender *</label>
                                <select class="form-control" id="studentGender" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="date" class="form-control" id="studentDOB">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="tel" class="form-control" id="studentPhone">
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" class="form-control" id="studentEmail">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Course *</label>
                            <select class="form-control" id="studentCourse" required onchange="updateCourseFee()">
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Sponsorship *</label>
                                <select class="form-control" id="studentSponsor" required>
                                    <option value="">Select Sponsorship</option>
                                    <option value="NYS">NYS</option>
                                    <option value="Self Sponsored">Self Sponsored</option>
                                    <option value="HELB">HELB</option>
                                    <option value="County Govt">County Government</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Intake *</label>
                                <select class="form-control" id="studentIntake" required>
                                    <option value="">Select Intake</option>
                                    <option value="January">January</option>
                                    <option value="May">May</option>
                                    <option value="September">September</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Annual Tuition Fee (KES) *</label>
                            <input type="number" class="form-control" id="studentAnnualFee" required min="0">
                        </div>
                        
                        <div class="form-group">
                            <label>Module Fee Breakdown</label>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                                <div class="info-item">
                                    <span>Module 1 (33%):</span>
                                    <span id="module1FeeDisplay">KES 0</span>
                                </div>
                                <div class="info-item">
                                    <span>Module 2 (33%):</span>
                                    <span id="module2FeeDisplay">KES 0</span>
                                </div>
                                <div class="info-item">
                                    <span>Module 3 (34%):</span>
                                    <span id="module3FeeDisplay">KES 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Address</label>
                            <textarea class="form-control" id="studentAddress" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Emergency Contact</label>
                            <input type="text" class="form-control" id="studentEmergencyContact">
                        </div>
                        
                        <div class="form-group">
                            <label>Emergency Phone</label>
                            <input type="tel" class="form-control" id="studentEmergencyPhone">
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveStudent()">Save Student</button>
                </div>
            </div>
        </div>

        <!-- Record Payment Modal -->
        <div class="modal-overlay" id="recordPaymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-money-check-alt"></i> Record Payment</h2>
                    <button class="close-modal" onclick="closeModal('recordPaymentModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <div class="form-group">
                            <label>Select Student *</label>
                            <select class="form-control" id="paymentStudent" required onchange="loadStudentBalance()">
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        
                        <div id="studentBalanceInfo" style="display: none;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h4>Current Balance Information</h4>
                                <div class="info-item">
                                    <span>Total Fees:</span>
                                    <span id="currentTotalFees">KES 0</span>
                                </div>
                                <div class="info-item">
                                    <span>Amount Paid:</span>
                                    <span id="currentAmountPaid">KES 0</span>
                                </div>
                                <div class="info-item">
                                    <span>Outstanding Balance:</span>
                                    <span id="currentOutstanding">KES 0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payment Type *</label>
                                <select class="form-control" id="paymentType" required>
                                    <option value="">Select Type</option>
                                    <option value="module1">Module 1 Fee</option>
                                    <option value="module2">Module 2 Fee</option>
                                    <option value="module3">Module 3 Fee</option>
                                    <option value="examination">Examination Fee</option>
                                    <option value="hostel">Hostel Fee</option>
                                    <option value="meals">Meals Fee</option>
                                    <option value="other">Other Fee</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Payment Method *</label>
                                <select class="form-control" id="paymentMethod" required>
                                    <option value="">Select Method</option>
                                    <option value="MPESA">MPESA</option>
                                    <option value="Bank">Bank Transfer</option>
                                    <option value="Cash">Cash</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Amount (KES) *</label>
                                <input type="number" class="form-control" id="paymentAmount" required min="0">
                            </div>
                            <div class="form-group">
                                <label>Payment Date *</label>
                                <input type="date" class="form-control" id="paymentDate" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Transaction Reference</label>
                            <input type="text" class="form-control" id="paymentReference" placeholder="MPESA Code, Cheque No, etc.">
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control" id="paymentDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('recordPaymentModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="savePayment()">Record Payment</button>
                </div>
            </div>
        </div>

        <!-- View Fees Statement Modal -->
        <div class="modal-overlay" id="viewFeesStatementModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Student Fees Statement</h2>
                    <button class="close-modal" onclick="closeModal('viewFeesStatementModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="feesStatementContent">
                        <!-- Fees statement will be loaded here -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('viewFeesStatementModal')">Close</button>
                    <button class="btn btn-primary" onclick="printFeesStatement()">
                        <i class="fas fa-print"></i> Print Statement
                    </button>
                    <button class="btn btn-success" onclick="downloadFeesStatement()">
                        <i class="fas fa-download"></i> Download PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Additional Fee Modal -->
        <div class="modal-overlay" id="addFeeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Add Additional Fee</h2>
                    <button class="close-modal" onclick="closeModal('addFeeModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="feeForm">
                        <div class="form-group">
                            <label>Select Student *</label>
                            <select class="form-control" id="feeStudent" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fee Type *</label>
                                <select class="form-control" id="feeType" required>
                                    <option value="">Select Type</option>
                                    <option value="Examination">Examination Fee</option>
                                    <option value="Hostel">Hostel Fee</option>
                                    <option value="Meals">Meals Fee</option>
                                    <option value="Registration">Registration Fee</option>
                                    <option value="Library">Library Fee</option>
                                    <option value="Activity">Activity Fee</option>
                                    <option value="Other">Other Fee</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Total Amount (KES) *</label>
                                <input type="number" class="form-control" id="feeTotalAmount" required min="0">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Amount Paid Now (KES)</label>
                                <input type="number" class="form-control" id="feeAmountPaid" min="0">
                            </div>
                            <div class="form-group">
                                <label>Due Date</label>
                                <input type="date" class="form-control" id="feeDueDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control" id="feeDescription" rows="3"></textarea>
                        </div>
                        
                        <div id="feeCalculation" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <h4>Balance Calculation</h4>
                            <div class="info-item">
                                <span>Total Amount:</span>
                                <span id="feeTotalDisplay">KES 0</span>
                            </div>
                            <div class="info-item">
                                <span>Amount Paid:</span>
                                <span id="feePaidDisplay">KES 0</span>
                            </div>
                            <div class="info-item">
                                <span>Balance:</span>
                                <span id="feeBalanceDisplay">KES 0</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('addFeeModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveFee()">Save Fee</button>
                </div>
            </div>
        </div>

        <!-- Add Course Modal -->
        <div class="modal-overlay" id="addCourseModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-book-medical"></i> Add New Course</h2>
                    <button class="close-modal" onclick="closeModal('addCourseModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="courseForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Course Code *</label>
                                <input type="text" class="form-control" id="courseCode" required>
                            </div>
                            <div class="form-group">
                                <label>Course Name *</label>
                                <input type="text" class="form-control" id="courseName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Department *</label>
                                <select class="form-control" id="courseDepartment" required>
                                    <option value="">Select Department</option>
                                    <option value="Computing & Informatics">Computing & Informatics</option>
                                    <option value="Hospitality & Tourism">Hospitality & Tourism</option>
                                    <option value="Business Studies">Business Studies</option>
                                    <option value="Health Sciences">Health Sciences</option>
                                    <option value="Engineering">Engineering</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Course Level *</label>
                                <select class="form-control" id="courseLevel" required>
                                    <option value="">Select Level</option>
                                    <option value="Certificate">Certificate</option>
                                    <option value="Diploma">Diploma</option>
                                    <option value="Higher Diploma">Higher Diploma</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Duration (Years) *</label>
                                <select class="form-control" id="courseDuration" required>
                                    <option value="">Select Duration</option>
                                    <option value="1">1 Year</option>
                                    <option value="2">2 Years</option>
                                    <option value="3">3 Years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Exam Body *</label>
                                <select class="form-control" id="courseExamBody" required>
                                    <option value="">Select Exam Body</option>
                                    <option value="KNEC">KNEC</option>
                                    <option value="CDACC">CDACC</option>
                                    <option value="KASNEB">KASNEB</option>
                                    <option value="NITA">NITA</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Annual Tuition Fee (KES) *</label>
                                <input type="number" class="form-control" id="courseAnnualFee" required min="0">
                            </div>
                            <div class="form-group">
                                <label>Semester Fee (KES)</label>
                                <input type="number" class="form-control" id="courseSemesterFee" min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Course Description</label>
                            <textarea class="form-control" id="courseDescription" rows="4"></textarea>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Intakes</label>
                                <div>
                                    <label><input type="checkbox" name="intake" value="January"> January</label>
                                    <label><input type="checkbox" name="intake" value="May"> May</label>
                                    <label><input type="checkbox" name="intake" value="September"> September</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select class="form-control" id="courseStatus">
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('addCourseModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveCourse()">Save Course</button>
                </div>
            </div>
        </div>

        <!-- Schedule Exam Modal -->
        <div class="modal-overlay" id="addExamModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-calendar-plus"></i> Schedule Examination</h2>
                    <button class="close-modal" onclick="closeModal('addExamModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="examForm">
                        <div class="form-group">
                            <label>Course *</label>
                            <select class="form-control" id="examCourse" required>
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Exam Name *</label>
                                <input type="text" class="form-control" id="examName" required>
                            </div>
                            <div class="form-group">
                                <label>Exam Type *</label>
                                <select class="form-control" id="examType" required>
                                    <option value="">Select Type</option>
                                    <option value="CAT">CAT</option>
                                    <option value="Main">Main Exam</option>
                                    <option value="Supplementary">Supplementary</option>
                                    <option value="Practical">Practical</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Exam Date *</label>
                                <input type="date" class="form-control" id="examDate" required>
                            </div>
                            <div class="form-group">
                                <label>Semester *</label>
                                <select class="form-control" id="examSemester" required>
                                    <option value="">Select Semester</option>
                                    <option value="1">Semester 1</option>
                                    <option value="2">Semester 2</option>
                                    <option value="3">Semester 3</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Maximum Marks *</label>
                                <input type="number" class="form-control" id="examMaxMarks" required min="0">
                            </div>
                            <div class="form-group">
                                <label>Pass Mark</label>
                                <input type="number" class="form-control" id="examPassMark" min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Exam Description</label>
                            <textarea class="form-control" id="examDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="examStatus">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('addExamModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveExam()">Schedule Exam</button>
                </div>
            </div>
        </div>

        <!-- Allocate Hostel Modal -->
        <div class="modal-overlay" id="allocateHostelModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-key"></i> Allocate Hostel Room</h2>
                    <button class="close-modal" onclick="closeModal('allocateHostelModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="hostelAllocationForm">
                        <div class="form-group">
                            <label>Select Student *</label>
                            <select class="form-control" id="hostelStudent" required onchange="updateStudentGender()">
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Hostel *</label>
                                <select class="form-control" id="hostelName" required onchange="updateAvailableRooms()">
                                    <option value="">Select Hostel</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Room Number *</label>
                                <select class="form-control" id="hostelRoom" required>
                                    <option value="">Select Room</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Allocation Date *</label>
                            <input type="date" class="form-control" id="allocationDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea class="form-control" id="allocationNotes" rows="3"></textarea>
                        </div>
                        
                        <div id="hostelInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                            <h4>Hostel Information</h4>
                            <div class="info-item">
                                <span>Hostel Type:</span>
                                <span id="hostelTypeDisplay">-</span>
                            </div>
                            <div class="info-item">
                                <span>Beds per Room:</span>
                                <span id="bedsPerRoomDisplay">-</span>
                            </div>
                            <div class="info-item">
                                <span>Available Beds:</span>
                                <span id="availableBedsDisplay">-</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('allocateHostelModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveHostelAllocation()">Allocate Room</button>
                </div>
            </div>
        </div>

        <!-- Add Class Modal -->
        <div class="modal-overlay" id="addClassModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-chalkboard-teacher"></i> Create New Class</h2>
                    <button class="close-modal" onclick="closeModal('addClassModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="classForm">
                        <div class="form-group">
                            <label>Course *</label>
                            <select class="form-control" id="classCourse" required>
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Class Name *</label>
                                <input type="text" class="form-control" id="className" required>
                            </div>
                            <div class="form-group">
                                <label>Module *</label>
                                <select class="form-control" id="classModule" required>
                                    <option value="">Select Module</option>
                                    <option value="Module 1">Module 1</option>
                                    <option value="Module 2">Module 2</option>
                                    <option value="Module 3">Module 3</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Intake *</label>
                                <select class="form-control" id="classIntake" required>
                                    <option value="">Select Intake</option>
                                    <option value="January">January</option>
                                    <option value="May">May</option>
                                    <option value="September">September</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Year *</label>
                                <input type="number" class="form-control" id="classYear" required min="2020" max="2030">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Capacity *</label>
                                <input type="number" class="form-control" id="classCapacity" required min="1">
                            </div>
                            <div class="form-group">
                                <label>Schedule</label>
                                <input type="text" class="form-control" id="classSchedule" placeholder="e.g., Mon-Fri 8AM-1PM">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="form-control" id="classDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="classStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('addClassModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveClass()">Create Class</button>
                </div>
            </div>
        </div>

        <!-- Upload Results Modal -->
        <div class="modal-overlay" id="uploadResultsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-upload"></i> Upload Exam Results</h2>
                    <button class="close-modal" onclick="closeModal('uploadResultsModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="uploadResultsForm">
                        <div class="form-group">
                            <label>Select Exam *</label>
                            <select class="form-control" id="uploadExam" required>
                                <option value="">Select Exam</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Upload CSV File *</label>
                            <input type="file" class="form-control" id="resultsFile" accept=".csv" required>
                            <small>CSV format: AdmNo,StudentName,Marks,Grade,Remarks</small>
                        </div>
                        
                        <div class="form-group">
                            <label>Or enter results manually:</label>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr>
                                            <th>Adm No</th>
                                            <th>Student Name</th>
                                            <th>Marks</th>
                                            <th>Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manualResultsBody">
                                        <!-- Manual entries will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Remarks</label>
                            <textarea class="form-control" id="resultsRemarks" rows="3"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="resultsStatus">
                                <option value="Pending">Pending</option>
                                <option value="Published">Published</option>
                                <option value="Archived">Archived</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('uploadResultsModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="uploadResults()">Upload Results</button>
                </div>
            </div>
        </div>

        <!-- View Student Details Modal -->
        <div class="modal-overlay" id="viewStudentModal">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2><i class="fas fa-user-graduate"></i> Student Details</h2>
                    <button class="close-modal" onclick="closeModal('viewStudentModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="studentDetailsContent">
                        <!-- Student details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Preview Modal -->
        <div class="modal-overlay" id="pdfPreviewModal">
            <div class="modal-content" style="max-width: 1000px; height: 90vh;">
                <div class="modal-header">
                    <h2><i class="fas fa-file-pdf"></i> PDF Preview</h2>
                    <button class="close-modal" onclick="closeModal('pdfPreviewModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <iframe id="pdfIframe" style="width: 100%; height: 70vh; border: none;"></iframe>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModal('pdfPreviewModal')">Close</button>
                    <button class="btn btn-primary" onclick="printPDF()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn btn-success" onclick="downloadPDF()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Login Credentials
        const VALID_CREDENTIALS = {
            username: 'admin',
            password: '1234'
        };

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAQZ1_Grh00sFgOp8pxkKff10sMFSw9xlc",
            authDomain: "jnnp-system.firebaseapp.com",
            databaseURL: "https://jnnp-system-default-rtdb.firebaseio.com",
            projectId: "jnnp-system",
            storageBucket: "jnnp-system.firebasestorage.app",
            messagingSenderId: "769232855377",
            appId: "1:769232855377:web:e3ba51e3e25cc24735f370"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global Variables
        let allData = {
            admissions: {},
            payments: {},
            additionalFees: {},
            courses: {},
            exams: {},
            results: {},
            hostelAllocations: {},
            classes: {},
            hostels: {}
        };

        let currentTab = 'dashboard';
        let currentStudent = null;
        let currentDoc = null;
        let revenueChart = null;
        let studentChart = null;
        let genderChart = null;
        let courseLevelChart = null;
        let isLoggedIn = false;

        // Module Structure
        const MODULES = [
            { id: 'module1', name: 'Module 1', percentage: 33 },
            { id: 'module2', name: 'Module 2', percentage: 33 },
            { id: 'module3', name: 'Module 3', percentage: 34 }
        ];

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in (from session storage)
            const loggedIn = sessionStorage.getItem('loggedIn');
            if (loggedIn === 'true') {
                loginSuccess();
            } else {
                // Show login form
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }

            // Set up login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleLogin();
            });

            // If logged in, initialize the rest of the application
            if (loggedIn === 'true') {
                initializeApplication();
            }
        });

        // Handle Login
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');

            // Validate credentials
            if (username === VALID_CREDENTIALS.username && password === VALID_CREDENTIALS.password) {
                // Successful login
                errorDiv.style.display = 'none';
                loginSuccess();
            } else {
                // Failed login
                errorDiv.style.display = 'block';
                // Clear password field
                document.getElementById('password').value = '';
                // Shake animation
                document.querySelector('.login-box').style.animation = 'none';
                setTimeout(() => {
                    document.querySelector('.login-box').style.animation = 'slideUp 0.5s ease, shake 0.5s ease';
                }, 10);
                
                // Remove shake animation after it completes
                setTimeout(() => {
                    document.querySelector('.login-box').style.animation = 'slideUp 0.5s ease';
                }, 600);
            }
        }

        // Login Success
        function loginSuccess() {
            isLoggedIn = true;
            sessionStorage.setItem('loggedIn', 'true');
            
            // Hide login form, show main app
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Initialize the application
            initializeApplication();
        }

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                isLoggedIn = false;
                sessionStorage.removeItem('loggedIn');
                sessionStorage.removeItem('theme');
                
                // Show login form, hide main app
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                
                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                document.getElementById('loginError').style.display = 'none';
                
                // Reset theme to default
                document.body.classList.remove('dark');
                document.querySelector('.theme-toggle').innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // Initialize Application After Login
        function initializeApplication() {
            // Load theme preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                document.querySelector('.theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
            }

            // Initialize tabs
            initializeTabs();
            
            // Load all data
            loadAllData();
            
            // Initialize charts
            initializeCharts();
            
            // Set current date in date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });

            // Add shake animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialize Tabs
        function initializeTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
        }

        // Switch Tab
        function switchTab(tabId) {
            // Update active tab
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.nav-tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Update sidebar active item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            currentTab = tabId;
            
            // Load tab-specific data
            switch(tabId) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'finance':
                    loadFinanceData();
                    break;
                case 'students':
                    loadStudentsData();
                    break;
                case 'courses':
                    loadCoursesData();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'hostel':
                    loadHostelData();
                    break;
                case 'classes':
                    loadClassesData();
                    break;
                case 'reports':
                    loadReportsData();
                    break;
            }
        }

        // Load All Data from Firebase
        function loadAllData() {
            // Show loading state
            showLoading();
            
            // Load admissions data
            db.ref("admissions").on("value", snapshot => {
                allData.admissions = snapshot.val() || {};
                updateDashboard();
                populateStudentDropdowns();
            });
            
            // Load payments data
            db.ref("payments").on("value", snapshot => {
                allData.payments = snapshot.val() || {};
                updateDashboard();
            });
            
            // Load additional fees data
            db.ref("additionalFees").on("value", snapshot => {
                allData.additionalFees = snapshot.val() || {};
                updateDashboard();
            });
            
            // Load courses data
            db.ref("courses").on("value", snapshot => {
                allData.courses = snapshot.val() || {};
                populateCourseDropdowns();
                updateDashboard();
            });
            
            // Load exams data
            db.ref("exams").on("value", snapshot => {
                allData.exams = snapshot.val() || {};
                updateDashboard();
            });
            
            // Load results data
            db.ref("results").on("value", snapshot => {
                allData.results = snapshot.val() || {};
                updateDashboard();
            });
            
            // Load hostel allocations data
            db.ref("hostelAllocations").on("value", snapshot => {
                allData.hostelAllocations = snapshot.val() || {};
                updateDashboard();
            });
            
            // Load classes data
            db.ref("classes").on("value", snapshot => {
                allData.classes = snapshot.val() || {};
                updateDashboard();
            });
            
            // Load hostels data
            db.ref("hostels").on("value", snapshot => {
                allData.hostels = snapshot.val() || {};
                updateDashboard();
            });
            
            // Hide loading after 2 seconds
            setTimeout(() => {
                hideLoading();
            }, 2000);
        }

        // Update Dashboard
        function updateDashboard() {
            if (!isLoggedIn) return;
            
            // Update statistics
            updateStatistics();
            
            // Update charts
            updateCharts();
            
            // Update recent activity
            updateRecentActivity();
        }

        // Update Statistics
        function updateStatistics() {
            const students = Object.values(allData.admissions);
            const payments = Object.values(allData.payments);
            const additionalFees = Object.values(allData.additionalFees);
            
            // Total Students
            document.getElementById('totalStudents').textContent = students.length;
            
            // Calculate total revenue
            let totalCourseFees = 0;
            students.forEach(student => {
                totalCourseFees += parseFloat(
                    student.annualTuition || 
                    (student.semesterFee ? student.semesterFee * 2 : 0) || 
                    0
                );
            });
            
            let totalAdditionalFees = 0;
            additionalFees.forEach(fee => {
                if (fee) {
                    totalAdditionalFees += parseFloat(fee.totalAmount) || 0;
                }
            });
            
            const totalRevenue = totalCourseFees + totalAdditionalFees;
            document.getElementById('totalRevenue').textContent = `KES ${totalRevenue.toLocaleString()}`;
            
            // Calculate total paid
            let totalPaid = 0;
            payments.forEach(payment => {
                if (payment) {
                    totalPaid += parseFloat(payment.amountPaid) || 0;
                }
            });
            
            additionalFees.forEach(fee => {
                if (fee) {
                    totalPaid += parseFloat(fee.amountPaid) || 0;
                }
            });
            
            const totalBalance = totalRevenue - totalPaid;
            document.getElementById('totalBalance').textContent = `KES ${totalBalance.toLocaleString()}`;
            
            // Collection rate
            const collectionRate = totalRevenue > 0 ? Math.round((totalPaid / totalRevenue) * 100) : 0;
            document.getElementById('collectionRate').textContent = `${collectionRate}%`;
            
            // Update summary cards
            document.getElementById('courseFeesTotal').textContent = `KES ${totalCourseFees.toLocaleString()}`;
            document.getElementById('totalRevenueSummary').textContent = `KES ${totalRevenue.toLocaleString()}`;
            document.getElementById('totalAmountDue').textContent = `KES ${totalRevenue.toLocaleString()}`;
            document.getElementById('amountCollected').textContent = `KES ${totalPaid.toLocaleString()}`;
            document.getElementById('outstandingBalance').textContent = `KES ${totalBalance.toLocaleString()}`;
            document.getElementById('collectionRateSummary').textContent = `${collectionRate}%`;
        }

        // Initialize Charts
        function initializeCharts() {
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue Collected',
                        data: [120000, 190000, 150000, 180000, 220000, 200000],
                        borderColor: '#1a73e8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Student Distribution Chart
            const studentCtx = document.getElementById('studentDistributionChart').getContext('2d');
            studentChart = new Chart(studentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Computing', 'Business', 'Tourism', 'Health', 'Engineering'],
                    datasets: [{
                        data: [30, 25, 20, 15, 10],
                        backgroundColor: [
                            '#1a73e8',
                            '#0d904f',
                            '#ff6d00',
                            '#8e44ad',
                            '#d93025'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update Charts
        function updateCharts() {
            // Update charts with real data
            const students = Object.values(allData.admissions);
            
            // Group students by course department
            const departmentCount = {};
            students.forEach(student => {
                const dept = student.courseDepartment || 'Unknown';
                departmentCount[dept] = (departmentCount[dept] || 0) + 1;
            });
            
            // Update student distribution chart
            studentChart.data.labels = Object.keys(departmentCount);
            studentChart.data.datasets[0].data = Object.values(departmentCount);
            studentChart.update();
        }

        // Update Recent Activity
        function updateRecentActivity() {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = '';
            
            // Collect recent activities from all data
            const activities = [];
            
            // Add payment activities
            Object.values(allData.payments).forEach(payment => {
                if (payment) {
                    activities.push({
                        type: 'payment',
                        student: findStudentByAdmNo(payment.admNo)?.fullName || 'Unknown Student',
                        amount: payment.amountPaid,
                        date: payment.timestamp,
                        icon: 'money-bill-wave',
                        color: 'payment'
                    });
                }
            });
            
            // Add admission activities
            Object.values(allData.admissions).forEach(student => {
                if (student) {
                    activities.push({
                        type: 'admission',
                        student: student.fullName,
                        course: student.courseName,
                        date: student.timestamp,
                        icon: 'user-plus',
                        color: 'admission'
                    });
                }
            });
            
            // Sort by date (newest first)
            activities.sort((a, b) => b.date - a.date);
            
            // Display latest 10 activities
            activities.slice(0, 10).forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                activityItem.innerHTML = `
                    <div class="activity-icon ${activity.color}">
                        <i class="fas fa-${activity.icon}"></i>
                    </div>
                    <div class="activity-content">
                        <strong>${getActivityDescription(activity)}</strong>
                        <div class="activity-time">${new Date(activity.date).toLocaleString()}</div>
                    </div>
                `;
                
                activityList.appendChild(activityItem);
            });
        }

        function getActivityDescription(activity) {
            switch(activity.type) {
                case 'payment':
                    return `${activity.student} paid KES ${activity.amount.toLocaleString()}`;
                case 'admission':
                    return `${activity.student} admitted for ${activity.course}`;
                default:
                    return 'New activity';
            }
        }

        // Populate Student Dropdowns
        function populateStudentDropdowns() {
            const studentSelects = [
                'paymentStudent',
                'feeStudent',
                'hostelStudent'
            ];
            
            studentSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Student</option>';
                    
                    Object.values(allData.admissions).forEach(student => {
                        if (student.admNo && student.fullName) {
                            const option = document.createElement('option');
                            option.value = student.admNo;
                            option.textContent = `${student.admNo} - ${student.fullName}`;
                            select.appendChild(option);
                        }
                    });
                }
            });
        }

        // Populate Course Dropdowns
        function populateCourseDropdowns() {
            const courseSelects = [
                'studentCourse',
                'examCourse',
                'classCourse',
                'financeCourseFilter',
                'studentCourseFilter',
                'examCourseFilter',
                'uploadExam'
            ];
            
            courseSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Course</option>';
                    
                    Object.entries(allData.courses).forEach(([key, course]) => {
                        if (course && course.courseName) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = `${course.courseCode} - ${course.courseName}`;
                            select.appendChild(option);
                        }
                    });
                }
            });
        }

        // Find Student by Admission Number
        function findStudentByAdmNo(admNo) {
            for (const [key, student] of Object.entries(allData.admissions)) {
                if (String(student.admNo) === String(admNo)) {
                    return { ...student, firebaseKey: key };
                }
            }
            return null;
        }

        // Calculate Module Payments
        function calculateModulePayments(student) {
            if (!student) return [];
            
            const studentPayments = Object.values(allData.payments).filter(p => 
                p && String(p.admNo) === String(student.admNo) && p.type && p.type.startsWith('module')
            );
            
            const annualFee = parseFloat(
                student.annualTuition || 
                (student.semesterFee ? student.semesterFee * 2 : 0) || 
                0
            );
            
            return MODULES.map(module => {
                const moduleFee = module.id === 'module1' ? student.module1Fee || Math.round(annualFee * 0.33) :
                                 module.id === 'module2' ? student.module2Fee || Math.round(annualFee * 0.33) :
                                 student.module3Fee || (annualFee - Math.round(annualFee * 0.33) - Math.round(annualFee * 0.33));
                
                const modulePayments = studentPayments.filter(p => p.type === module.id);
                const paidAmount = modulePayments.reduce((sum, p) => sum + (parseFloat(p.amountPaid) || 0), 0);
                const balance = moduleFee - paidAmount;
                
                let status = 'unpaid';
                if (paidAmount >= moduleFee) {
                    status = 'paid';
                } else if (paidAmount > 0) {
                    status = 'partial';
                }
                
                return {
                    ...module,
                    paidAmount,
                    balance,
                    status,
                    moduleFee
                };
            });
        }

        // Calculate Student Additional Fees
        function calculateStudentAdditionalFees(admNo) {
            const studentFees = Object.values(allData.additionalFees).filter(f => 
                f && String(f.admNo) === String(admNo)
            );
            
            let totalFees = 0;
            let totalPaid = 0;
            const feesByType = {};
            
            studentFees.forEach(fee => {
                totalFees += parseFloat(fee.totalAmount || 0);
                totalPaid += parseFloat(fee.amountPaid || 0);
                
                const type = fee.type || 'Other';
                if (!feesByType[type]) {
                    feesByType[type] = {
                        total: 0,
                        paid: 0,
                        balance: 0
                    };
                }
                feesByType[type].total += parseFloat(fee.totalAmount || 0);
                feesByType[type].paid += parseFloat(fee.amountPaid || 0);
                feesByType[type].balance += (parseFloat(fee.totalAmount || 0) - parseFloat(fee.amountPaid || 0));
            });
            
            return {
                totalFees,
                totalPaid,
                feesByType,
                balance: totalFees - totalPaid
            };
        }

        // Calculate Total Payments
        function calculateTotalPayments(student) {
            if (!student) return { totalPaid: 0 };
            
            const studentPayments = Object.values(allData.payments).filter(p => 
                p && String(p.admNo) === String(student.admNo)
            );
            const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
            
            const modulePayments = studentPayments
                .filter(p => p.type && p.type.startsWith('module'))
                .reduce((sum, p) => sum + (parseFloat(p.amountPaid) || 0), 0);
                
            const otherPayments = studentPayments
                .filter(p => !p.type || !p.type.startsWith('module'))
                .reduce((sum, p) => sum + (parseFloat(p.amountPaid) || 0), 0);
                
            const totalPaid = modulePayments + otherPayments + additionalFeesData.totalPaid;
            
            return {
                modulePayments,
                otherPayments,
                additionalFeesPaid: additionalFeesData.totalPaid,
                totalPaid
            };
        }

        // Load Student Balance
        function loadStudentBalance() {
            const studentSelect = document.getElementById('paymentStudent');
            const student = findStudentByAdmNo(studentSelect.value);
            
            if (student) {
                const annualFee = parseFloat(
                    student.annualTuition || 
                    (student.semesterFee ? student.semesterFee * 2 : 0) || 
                    0
                );
                const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
                const totalPayments = calculateTotalPayments(student);
                
                const totalFees = annualFee + additionalFeesData.totalFees;
                const totalPaid = totalPayments.totalPaid;
                const outstanding = totalFees - totalPaid;
                
                document.getElementById('currentTotalFees').textContent = `KES ${totalFees.toLocaleString()}`;
                document.getElementById('currentAmountPaid').textContent = `KES ${totalPaid.toLocaleString()}`;
                document.getElementById('currentOutstanding').textContent = `KES ${outstanding.toLocaleString()}`;
                
                document.getElementById('studentBalanceInfo').style.display = 'block';
            } else {
                document.getElementById('studentBalanceInfo').style.display = 'none';
            }
        }

        // Update Course Fee
        function updateCourseFee() {
            const courseSelect = document.getElementById('studentCourse');
            const course = allData.courses[courseSelect.value];
            
            if (course) {
                const annualFee = parseFloat(course.annualTuition) || 0;
                const module1Fee = Math.round(annualFee * 0.33);
                const module2Fee = Math.round(annualFee * 0.33);
                const module3Fee = annualFee - module1Fee - module2Fee;
                
                document.getElementById('studentAnnualFee').value = annualFee;
                document.getElementById('module1FeeDisplay').textContent = `KES ${module1Fee.toLocaleString()}`;
                document.getElementById('module2FeeDisplay').textContent = `KES ${module2Fee.toLocaleString()}`;
                document.getElementById('module3FeeDisplay').textContent = `KES ${module3Fee.toLocaleString()}`;
            }
        }

        // Save Student
        function saveStudent() {
            if (!isLoggedIn) return;
            
            const admNo = document.getElementById('studentAdmNo').value.trim();
            const fullName = document.getElementById('studentName').value.trim();
            const gender = document.getElementById('studentGender').value;
            const courseId = document.getElementById('studentCourse').value;
            const sponsor = document.getElementById('studentSponsor').value;
            const intake = document.getElementById('studentIntake').value;
            const annualFee = parseFloat(document.getElementById('studentAnnualFee').value) || 0;
            
            if (!admNo || !fullName || !gender || !courseId || !sponsor || !intake || annualFee <= 0) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const course = allData.courses[courseId] || {};
            const module1Fee = Math.round(annualFee * 0.33);
            const module2Fee = Math.round(annualFee * 0.33);
            const module3Fee = annualFee - module1Fee - module2Fee;
            
            const studentData = {
                admNo,
                fullName,
                gender,
                courseId,
                courseCode: course.courseCode || '',
                courseName: course.courseName || 'General Course',
                courseDepartment: course.courseDepartment || '',
                courseLevel: course.courseLevel || 'Diploma',
                annualTuition: annualFee,
                module1Fee,
                module2Fee,
                module3Fee,
                sponsor,
                intake,
                status: 'Active',
                phone: document.getElementById('studentPhone').value,
                email: document.getElementById('studentEmail').value,
                dob: document.getElementById('studentDOB').value,
                address: document.getElementById('studentAddress').value,
                emergencyContact: document.getElementById('studentEmergencyContact').value,
                emergencyPhone: document.getElementById('studentEmergencyPhone').value,
                createdAt: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            const newStudentRef = db.ref('admissions').push();
            newStudentRef.set(studentData)
                .then(() => {
                    showAlert('Student added successfully!', 'success');
                    closeModal('addStudentModal');
                    document.getElementById('studentForm').reset();
                })
                .catch(error => {
                    console.error('Error adding student:', error);
                    showAlert('Error adding student. Please try again.', 'error');
                });
        }

        // Save Payment
        function savePayment() {
            if (!isLoggedIn) return;
            
            const admNo = document.getElementById('paymentStudent').value;
            const type = document.getElementById('paymentType').value;
            const method = document.getElementById('paymentMethod').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const date = document.getElementById('paymentDate').value;
            const reference = document.getElementById('paymentReference').value;
            const description = document.getElementById('paymentDescription').value;
            
            if (!admNo || !type || !method || amount <= 0 || !date) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const student = findStudentByAdmNo(admNo);
            if (!student) {
                showAlert('Student not found', 'error');
                return;
            }
            
            const paymentData = {
                admNo,
                type,
                method,
                amountPaid: amount,
                paymentDate: date,
                reference,
                description,
                recordedBy: 'Admin',
                timestamp: Date.now(),
                studentName: student.fullName
            };
            
            const newPaymentRef = db.ref('payments').push();
            newPaymentRef.set(paymentData)
                .then(() => {
                    showAlert('Payment recorded successfully!', 'success');
                    
                    // Generate receipt
                    generateReceipt(admNo, paymentData);
                    
                    closeModal('recordPaymentModal');
                    document.getElementById('paymentForm').reset();
                })
                .catch(error => {
                    console.error('Error recording payment:', error);
                    showAlert('Error recording payment. Please try again.', 'error');
                });
        }

        // View Fees Statement
        function viewFeesStatement(admNo) {
            const student = findStudentByAdmNo(admNo);
            if (!student) {
                showAlert('Student not found', 'error');
                return;
            }
            
            const modules = calculateModulePayments(student);
            const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
            const totalPayments = calculateTotalPayments(student);
            const annualFee = parseFloat(
                student.annualTuition || 
                (student.semesterFee ? student.semesterFee * 2 : 0) || 
                0
            );
            const totalFees = annualFee + additionalFeesData.totalFees;
            const totalPaid = totalPayments.totalPaid;
            const outstanding = totalFees - totalPaid;
            
            const content = document.getElementById('feesStatementContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h3>Student Information</h3>
                        <div class="info-item">
                            <span>Admission Number:</span>
                            <span>${student.admNo}</span>
                        </div>
                        <div class="info-item">
                            <span>Full Name:</span>
                            <span>${student.fullName}</span>
                        </div>
                        <div class="info-item">
                            <span>Course:</span>
                            <span>${student.courseName}</span>
                        </div>
                        <div class="info-item">
                            <span>Intake:</span>
                            <span>${student.intake}</span>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Financial Summary</h3>
                        <div class="info-item">
                            <span>Annual Course Fee:</span>
                            <span>KES ${annualFee.toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Additional Fees:</span>
                            <span>KES ${additionalFeesData.totalFees.toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Total Amount Due:</span>
                            <span>KES ${totalFees.toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Total Amount Paid:</span>
                            <span>KES ${totalPaid.toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Outstanding Balance:</span>
                            <span style="color: ${outstanding > 0 ? '#d93025' : '#0d904f'}; font-weight: bold;">
                                KES ${outstanding.toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3>Module Fee Breakdown</h3>
                    <div class="module-details">
                        ${modules.map(module => `
                            <div class="module-row">
                                <div class="module-name">${module.name}</div>
                                <div class="module-amounts">
                                    <div class="module-total">KES ${module.moduleFee.toLocaleString()}</div>
                                    <div class="module-paid">KES ${module.paidAmount.toLocaleString()}</div>
                                    <div class="module-balance">KES ${module.balance.toLocaleString()}</div>
                                </div>
                                <span class="status-badge status-${module.status}">${module.status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3>Additional Fees Breakdown</h3>
                    <div class="module-details">
                        ${Object.entries(additionalFeesData.feesByType).map(([type, data]) => `
                            <div class="module-row">
                                <div class="module-name">${type}</div>
                                <div class="module-amounts">
                                    <div class="module-total">KES ${data.total.toLocaleString()}</div>
                                    <div class="module-paid">KES ${data.paid.toLocaleString()}</div>
                                    <div class="module-balance">KES ${data.balance.toLocaleString()}</div>
                                </div>
                                <span class="status-badge status-${data.balance <= 0 ? 'paid' : (data.paid > 0 ? 'partial' : 'unpaid')}">
                                    ${data.balance <= 0 ? 'paid' : (data.paid > 0 ? 'partial' : 'unpaid')}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 30px;">
                    <h4>Statement Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #1a73e8;">KES ${totalFees.toLocaleString()}</div>
                            <div style="font-size: 14px; color: #666;">Total Amount Due</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #0d904f;">KES ${totalPaid.toLocaleString()}</div>
                            <div style="font-size: 14px; color: #666;">Total Amount Paid</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: ${outstanding > 0 ? '#d93025' : '#0d904f'};">KES ${outstanding.toLocaleString()}</div>
                            <div style="font-size: 14px; color: #666;">Outstanding Balance</div>
                        </div>
                    </div>
                </div>
            `;
            
            openModal('viewFeesStatementModal');
        }

        // Print Fees Statement
        function printFeesStatement() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add statement content
            doc.setFontSize(20);
            doc.text('UNITED COLLEGE OF SCIENCE AND TECHNOLOGY', 105, 20, null, null, 'center');
            
            doc.setFontSize(16);
            doc.text('STUDENT FEES STATEMENT', 105, 30, null, null, 'center');
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Statement Date: ${new Date().toLocaleDateString()}`, 20, 50);
            
            // Get student info from modal
            const studentInfo = document.querySelector('#feesStatementContent .info-item');
            if (studentInfo) {
                let yPos = 70;
                doc.setFontSize(12);
                doc.text('Student Information:', 20, yPos);
                yPos += 10;
                
                const infoItems = document.querySelectorAll('#feesStatementContent .info-item');
                infoItems.forEach((item, index) => {
                    if (index < 4) { // First 4 items are student info
                        const text = item.textContent;
                        doc.text(text, 20, yPos);
                        yPos += 10;
                    }
                });
            }
            
            // Show in preview modal
            const pdfDataUri = doc.output('datauristring');
            document.getElementById('pdfIframe').src = pdfDataUri;
            closeModal('viewFeesStatementModal');
            openModal('pdfPreviewModal');
            currentDoc = doc;
        }

        // Download Fees Statement
        function downloadFeesStatement() {
            if (currentDoc) {
                currentDoc.save(`fees_statement_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }

        // Save Additional Fee
        function saveFee() {
            if (!isLoggedIn) return;
            
            const admNo = document.getElementById('feeStudent').value;
            const type = document.getElementById('feeType').value;
            const totalAmount = parseFloat(document.getElementById('feeTotalAmount').value) || 0;
            const amountPaid = parseFloat(document.getElementById('feeAmountPaid').value) || 0;
            const dueDate = document.getElementById('feeDueDate').value;
            const description = document.getElementById('feeDescription').value;
            
            if (!admNo || !type || totalAmount <= 0) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            if (amountPaid > totalAmount) {
                showAlert('Amount paid cannot exceed total amount', 'error');
                return;
            }
            
            const student = findStudentByAdmNo(admNo);
            if (!student) {
                showAlert('Student not found', 'error');
                return;
            }
            
            const feeData = {
                admNo,
                type,
                totalAmount,
                amountPaid,
                balance: totalAmount - amountPaid,
                dueDate,
                description,
                studentName: student.fullName,
                createdAt: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            const newFeeRef = db.ref('additionalFees').push();
            newFeeRef.set(feeData)
                .then(() => {
                    showAlert('Additional fee added successfully!', 'success');
                    closeModal('addFeeModal');
                    document.getElementById('feeForm').reset();
                })
                .catch(error => {
                    console.error('Error adding fee:', error);
                    showAlert('Error adding fee. Please try again.', 'error');
                });
        }

        // Save Course
        function saveCourse() {
            if (!isLoggedIn) return;
            
            const code = document.getElementById('courseCode').value.trim();
            const name = document.getElementById('courseName').value.trim();
            const department = document.getElementById('courseDepartment').value;
            const level = document.getElementById('courseLevel').value;
            const duration = document.getElementById('courseDuration').value;
            const examBody = document.getElementById('courseExamBody').value;
            const annualFee = parseFloat(document.getElementById('courseAnnualFee').value) || 0;
            const description = document.getElementById('courseDescription').value;
            const status = document.getElementById('courseStatus').value;
            
            if (!code || !name || !department || !level || !duration || !examBody || annualFee <= 0) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            // Get selected intakes
            const selectedIntakes = Array.from(document.querySelectorAll('input[name="intake"]:checked'))
                .map(cb => cb.value);
            
            const courseData = {
                courseCode: code,
                courseName: name,
                courseDepartment: department,
                courseLevel: level,
                courseDuration: duration,
                examBody,
                annualTuition: annualFee,
                semesterFee: Math.round(annualFee / 2),
                courseDescription: description,
                intakes: selectedIntakes.join(', '),
                status,
                createdAt: new Date().toISOString(),
                createdBy: 'Admin'
            };
            
            const newCourseRef = db.ref('courses').push();
            newCourseRef.set(courseData)
                .then(() => {
                    showAlert('Course added successfully!', 'success');
                    closeModal('addCourseModal');
                    document.getElementById('courseForm').reset();
                })
                .catch(error => {
                    console.error('Error adding course:', error);
                    showAlert('Error adding course. Please try again.', 'error');
                });
        }

        // Save Exam
        function saveExam() {
            if (!isLoggedIn) return;
            
            const courseId = document.getElementById('examCourse').value;
            const name = document.getElementById('examName').value.trim();
            const type = document.getElementById('examType').value;
            const date = document.getElementById('examDate').value;
            const semester = document.getElementById('examSemester').value;
            const maxMarks = parseFloat(document.getElementById('examMaxMarks').value) || 0;
            const passMark = parseFloat(document.getElementById('examPassMark').value) || 0;
            const description = document.getElementById('examDescription').value;
            const status = document.getElementById('examStatus').value;
            
            if (!courseId || !name || !type || !date || !semester || maxMarks <= 0) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const course = allData.courses[courseId];
            if (!course) {
                showAlert('Course not found', 'error');
                return;
            }
            
            const examData = {
                examId: `EXM${Date.now()}`,
                examName: name,
                examType: type,
                courseId,
                courseCode: course.courseCode,
                courseName: course.courseName,
                examDate: date,
                maxMarks,
                passMark: passMark || Math.round(maxMarks * 0.4),
                semester,
                examDescription: description,
                status,
                createdAt: new Date().toISOString(),
                createdBy: 'Admin'
            };
            
            const newExamRef = db.ref('exams').push();
            newExamRef.set(examData)
                .then(() => {
                    showAlert('Exam scheduled successfully!', 'success');
                    closeModal('addExamModal');
                    document.getElementById('examForm').reset();
                })
                .catch(error => {
                    console.error('Error scheduling exam:', error);
                    showAlert('Error scheduling exam. Please try again.', 'error');
                });
        }

        // Save Hostel Allocation
        function saveHostelAllocation() {
            if (!isLoggedIn) return;
            
            const admNo = document.getElementById('hostelStudent').value;
            const hostelName = document.getElementById('hostelName').value;
            const roomNumber = document.getElementById('hostelRoom').value;
            const allocationDate = document.getElementById('allocationDate').value;
            const notes = document.getElementById('allocationNotes').value;
            
            if (!admNo || !hostelName || !roomNumber || !allocationDate) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const student = findStudentByAdmNo(admNo);
            if (!student) {
                showAlert('Student not found', 'error');
                return;
            }
            
            const allocationData = {
                admNo,
                studentName: student.fullName,
                studentGender: student.gender,
                hostelName,
                roomNumber,
                allocationDate,
                notes,
                status: 'Allocated',
                allocatedBy: 'Admin',
                createdAt: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            const newAllocationRef = db.ref('hostelAllocations').push();
            newAllocationRef.set(allocationData)
                .then(() => {
                    showAlert('Room allocated successfully!', 'success');
                    closeModal('allocateHostelModal');
                    document.getElementById('hostelAllocationForm').reset();
                })
                .catch(error => {
                    console.error('Error allocating room:', error);
                    showAlert('Error allocating room. Please try again.', 'error');
                });
        }

        // Save Class
        function saveClass() {
            if (!isLoggedIn) return;
            
            const courseId = document.getElementById('classCourse').value;
            const name = document.getElementById('className').value.trim();
            const module = document.getElementById('classModule').value;
            const intake = document.getElementById('classIntake').value;
            const year = document.getElementById('classYear').value;
            const capacity = parseInt(document.getElementById('classCapacity').value) || 0;
            const schedule = document.getElementById('classSchedule').value;
            const description = document.getElementById('classDescription').value;
            const status = document.getElementById('classStatus').value;
            
            if (!courseId || !name || !module || !intake || !year || capacity <= 0) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }
            
            const course = allData.courses[courseId];
            if (!course) {
                showAlert('Course not found', 'error');
                return;
            }
            
            const classData = {
                className: name,
                courseId,
                courseCode: course.courseCode,
                courseName: course.courseName,
                module,
                intake,
                year,
                capacity,
                enrolled: 0,
                schedule,
                description,
                status,
                createdAt: new Date().toISOString(),
                createdBy: 'Admin'
            };
            
            const newClassRef = db.ref('classes').push();
            newClassRef.set(classData)
                .then(() => {
                    showAlert('Class created successfully!', 'success');
                    closeModal('addClassModal');
                    document.getElementById('classForm').reset();
                })
                .catch(error => {
                    console.error('Error creating class:', error);
                    showAlert('Error creating class. Please try again.', 'error');
                });
        }

        // Load Finance Data
        function loadFinanceData() {
            const tableBody = document.getElementById('financeTableBody');
            tableBody.innerHTML = '';
            
            const students = Object.values(allData.admissions);
            
            if (students.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No student records found</p>
                            <button class="btn btn-primary" onclick="openModal('addStudentModal')">
                                Add First Student
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            students.forEach(student => {
                const modules = calculateModulePayments(student);
                const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
                const totalPayments = calculateTotalPayments(student);
                const annualFee = parseFloat(
                    student.annualTuition || 
                    (student.semesterFee ? student.semesterFee * 2 : 0) || 
                    0
                );
                const totalFees = annualFee + additionalFeesData.totalFees;
                const totalBalance = totalFees - totalPayments.totalPaid;
                const status = totalBalance <= 0 ? 'paid' : (totalPayments.totalPaid > 0 ? 'partial' : 'unpaid');
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${student.admNo || 'N/A'}</strong></td>
                    <td>${student.fullName || 'Unknown'}</td>
                    <td>${student.courseName || 'N/A'}</td>
                    <td>KES ${annualFee.toLocaleString()}</td>
                    <td>
                        <div class="module-details">
                            ${modules.map(module => `
                                <div class="module-row">
                                    <div class="module-name">${module.name}</div>
                                    <div class="module-amounts">
                                        <div class="module-total">KES ${module.moduleFee.toLocaleString()}</div>
                                        <div class="module-paid">KES ${module.paidAmount.toLocaleString()}</div>
                                        <div class="module-balance">KES ${module.balance.toLocaleString()}</div>
                                    </div>
                                    <span class="status-badge status-${module.status}">${module.status}</span>
                                </div>
                            `).join('')}
                        </div>
                    </td>
                    <td>
                        <div>
                            <strong>KES ${additionalFeesData.totalFees.toLocaleString()}</strong>
                            ${Object.entries(additionalFeesData.feesByType).map(([type, data]) => `
                                <div style="font-size: 12px; color: #666;">
                                    ${type}: KES ${data.total.toLocaleString()}
                                </div>
                            `).join('')}
                        </div>
                    </td>
                    <td>KES ${totalPayments.totalPaid.toLocaleString()}</td>
                    <td><strong style="color: ${totalBalance > 0 ? '#d93025' : '#0d904f'}">KES ${totalBalance.toLocaleString()}</strong></td>
                    <td><span class="status-badge status-${status}">${status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="recordPaymentForStudent('${student.admNo}')">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="viewFeesStatement('${student.admNo}')">
                            <i class="fas fa-file-alt"></i> View Statement
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load Students Data
        function loadStudentsData() {
            const tableBody = document.getElementById('studentsTableBody');
            tableBody.innerHTML = '';
            
            const students = Object.values(allData.admissions);
            
            if (students.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>No students found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.admNo || 'N/A'}</td>
                    <td>${student.fullName || 'Unknown'}</td>
                    <td>${student.gender || 'N/A'}</td>
                    <td>${student.courseName || 'N/A'}</td>
                    <td>${student.courseLevel || 'N/A'}</td>
                    <td>${student.sponsor || 'N/A'}</td>
                    <td>KES ${(student.annualTuition || 0).toLocaleString()}</td>
                    <td><span class="status-badge status-${student.status || 'Active'}">${student.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewStudentDetails('${student.admNo}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="viewFeesStatement('${student.admNo}')">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load Courses Data
        function loadCoursesData() {
            const tableBody = document.getElementById('coursesTableBody');
            tableBody.innerHTML = '';
            
            const courses = Object.values(allData.courses);
            
            // Update summary
            document.getElementById('totalCourses').textContent = courses.length;
            document.getElementById('diplomaCourses').textContent = courses.filter(c => c.courseLevel === 'Diploma').length;
            document.getElementById('certificateCourses').textContent = courses.filter(c => c.courseLevel === 'Certificate').length;
            document.getElementById('activeCourses').textContent = courses.filter(c => c.status === 'Active').length;
            
            if (courses.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-book"></i>
                            <p>No courses found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            courses.forEach(course => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${course.courseCode || 'N/A'}</td>
                    <td>${course.courseName || 'Unknown'}</td>
                    <td>${course.courseDepartment || 'N/A'}</td>
                    <td>${course.courseLevel || 'N/A'}</td>
                    <td>KES ${(course.annualTuition || 0).toLocaleString()}</td>
                    <td>${course.examBody || 'N/A'}</td>
                    <td>${course.courseDuration || 2} Years</td>
                    <td><span class="status-badge status-${course.status || 'Active'}">${course.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewCourseDetails('${course.courseCode}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load Exams Data
        function loadExamsData() {
            const tableBody = document.getElementById('examsTableBody');
            const resultsBody = document.getElementById('resultsTableBody');
            
            tableBody.innerHTML = '';
            resultsBody.innerHTML = '';
            
            const exams = Object.values(allData.exams);
            const results = Object.values(allData.results);
            
            // Load exams
            if (exams.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <p>No exams scheduled</p>
                        </td>
                    </tr>
                `;
            } else {
                exams.forEach(exam => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${exam.examId || 'N/A'}</td>
                        <td>${exam.examName || 'Unknown'}</td>
                        <td>${exam.courseName || 'N/A'}</td>
                        <td>${exam.examType || 'N/A'}</td>
                        <td>${new Date(exam.examDate).toLocaleDateString()}</td>
                        <td>${exam.maxMarks || 0}</td>
                        <td>${exam.semester || 'N/A'}</td>
                        <td><span class="status-badge status-${exam.status || 'Scheduled'}">${exam.status || 'Scheduled'}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="viewExamDetails('${exam.examId}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Load results
            if (results.length === 0) {
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-award"></i>
                            <p>No results found</p>
                        </td>
                    </tr>
                `;
            } else {
                results.forEach(result => {
                    const gradeClass = result.grade && result.grade.includes('DISTINCTION') ? 'grade-distinction' :
                                      result.grade && result.grade.includes('CREDIT') ? 'grade-credit' :
                                      result.grade && result.grade.includes('PASS') ? 'grade-pass' :
                                      'grade-fail';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${result.studentName || 'Unknown'}</td>
                        <td>${result.studentAdmNo || 'N/A'}</td>
                        <td>${result.examName || 'N/A'}</td>
                        <td>${result.courseName || 'N/A'}</td>
                        <td>${result.marks || 0}</td>
                        <td><span class="grade-badge ${gradeClass}">${result.grade || 'N/A'}</span></td>
                        <td>${result.remarks || ''}</td>
                        <td><span class="status-badge status-${result.status || 'Pending'}">${result.status || 'Pending'}</span></td>
                        <td>${new Date(result.uploadedAt).toLocaleDateString()}</td>
                    `;
                    
                    resultsBody.appendChild(row);
                });
            }
        }

        // Load Hostel Data
        function loadHostelData() {
            const tableBody = document.getElementById('hostelTableBody');
            tableBody.innerHTML = '';
            
            const allocations = Object.values(allData.hostelAllocations);
            const hostels = Object.values(allData.hostels);
            
            // Update summary
            document.getElementById('totalHostels').textContent = hostels.length;
            document.getElementById('maleHostels').textContent = hostels.filter(h => h.hostelGender === 'Male').length;
            document.getElementById('femaleHostels').textContent = hostels.filter(h => h.hostelGender === 'Female').length;
            
            let occupiedRooms = 0;
            let totalCapacity = 0;
            hostels.forEach(hostel => {
                totalCapacity += (hostel.totalRooms || 0) * (hostel.bedsPerRoom || 1);
            });
            
            document.getElementById('occupiedRooms').textContent = allocations.filter(a => a.status === 'Allocated').length;
            document.getElementById('availableRooms').textContent = totalCapacity - allocations.filter(a => a.status === 'Allocated').length;
            
            document.getElementById('totalHostedStudents').textContent = allocations.filter(a => a.status === 'Allocated').length;
            document.getElementById('maleHostedStudents').textContent = allocations.filter(a => a.status === 'Allocated' && a.studentGender === 'Male').length;
            document.getElementById('femaleHostedStudents').textContent = allocations.filter(a => a.status === 'Allocated' && a.studentGender === 'Female').length;
            
            // Calculate hostel fee collection
            let hostelFeeCollection = 0;
            let hostelFeeBalance = 0;
            
            Object.values(allData.additionalFees).forEach(fee => {
                if (fee.type === 'Hostel') {
                    hostelFeeCollection += parseFloat(fee.amountPaid || 0);
                    hostelFeeBalance += parseFloat(fee.balance || 0);
                }
            });
            
            document.getElementById('hostelFeeCollection').textContent = `KES ${hostelFeeCollection.toLocaleString()}`;
            document.getElementById('hostelFeeBalance').textContent = `KES ${hostelFeeBalance.toLocaleString()}`;
            
            // Load allocation table
            if (allocations.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-bed"></i>
                            <p>No hostel allocations found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            allocations.forEach(allocation => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${allocation.studentName || 'Unknown'}</td>
                    <td>${allocation.admNo || 'N/A'}</td>
                    <td>${allocation.studentGender || 'N/A'}</td>
                    <td>${allocation.hostelName || 'N/A'}</td>
                    <td>${allocation.roomNumber || 'N/A'}</td>
                    <td>${new Date(allocation.allocationDate).toLocaleDateString()}</td>
                    <td>${allocation.deallocatedAt ? new Date(allocation.deallocatedAt).toLocaleDateString() : '-'}</td>
                    <td><span class="status-badge status-${allocation.status || 'Allocated'}">${allocation.status || 'Allocated'}</span></td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="deallocateHostel('${allocation.admNo}')">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load Classes Data
        function loadClassesData() {
            const tableBody = document.getElementById('classesTableBody');
            tableBody.innerHTML = '';
            
            const classes = Object.values(allData.classes);
            
            // Update summary
            let totalCapacity = 0;
            let totalEnrolled = 0;
            
            classes.forEach(cls => {
                totalCapacity += parseInt(cls.capacity) || 0;
                totalEnrolled += parseInt(cls.enrolled) || 0;
            });
            
            document.getElementById('totalClasses').textContent = classes.length;
            document.getElementById('activeClasses').textContent = classes.filter(c => c.status === 'Active').length;
            document.getElementById('totalCapacity').textContent = totalCapacity;
            document.getElementById('enrolledStudents').textContent = totalEnrolled;
            document.getElementById('availableSlots').textContent = totalCapacity - totalEnrolled;
            
            if (classes.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <p>No classes found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            classes.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cls.className || 'Unknown'}</td>
                    <td>${cls.courseName || 'N/A'}</td>
                    <td>${cls.module || 'N/A'}</td>
                    <td>${cls.intake || 'N/A'} ${cls.year || ''}</td>
                    <td>${cls.capacity || 0}</td>
                    <td>${cls.enrolled || 0}</td>
                    <td>${cls.schedule || 'N/A'}</td>
                    <td><span class="status-badge status-${cls.status || 'Active'}">${cls.status || 'Active'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewClassStudents('${cls.className}')">
                            <i class="fas fa-users"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load Reports Data
        function loadReportsData() {
            // Load gender report
            const students = Object.values(allData.admissions);
            
            let maleCount = 0, maleTotalFees = 0, maleFeesPaid = 0;
            let femaleCount = 0, femaleTotalFees = 0, femaleFeesPaid = 0;
            
            students.forEach(student => {
                const annualFee = parseFloat(
                    student.annualTuition || 
                    (student.semesterFee ? student.semesterFee * 2 : 0) || 
                    0
                );
                const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
                const totalPayments = calculateTotalPayments(student);
                
                const totalFees = annualFee + additionalFeesData.totalFees;
                const totalPaid = totalPayments.totalPaid;
                
                if (student.gender === 'Male') {
                    maleCount++;
                    maleTotalFees += totalFees;
                    maleFeesPaid += totalPaid;
                } else if (student.gender === 'Female') {
                    femaleCount++;
                    femaleTotalFees += totalFees;
                    femaleFeesPaid += totalPaid;
                }
            });
            
            document.getElementById('reportMaleStudents').textContent = maleCount;
            document.getElementById('reportFemaleStudents').textContent = femaleCount;
            document.getElementById('reportMaleFees').textContent = `KES ${maleTotalFees.toLocaleString()}`;
            document.getElementById('reportFemaleFees').textContent = `KES ${femaleTotalFees.toLocaleString()}`;
            
            // Update gender chart
            if (!genderChart) {
                const genderCtx = document.getElementById('genderReportChart').getContext('2d');
                genderChart = new Chart(genderCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Male', 'Female'],
                        datasets: [{
                            data: [maleCount, femaleCount],
                            backgroundColor: ['#1a73e8', '#ff6d00']
                        }]
                    }
                });
            } else {
                genderChart.data.datasets[0].data = [maleCount, femaleCount];
                genderChart.update();
            }
            
            // Load course level report
            let diplomaCount = 0, diplomaTotalFees = 0, diplomaFeesPaid = 0;
            let certificateCount = 0, certificateTotalFees = 0, certificateFeesPaid = 0;
            
            students.forEach(student => {
                const annualFee = parseFloat(
                    student.annualTuition || 
                    (student.semesterFee ? student.semesterFee * 2 : 0) || 
                    0
                );
                const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
                const totalPayments = calculateTotalPayments(student);
                
                const totalFees = annualFee + additionalFeesData.totalFees;
                const totalPaid = totalPayments.totalPaid;
                
                if (student.courseLevel === 'Diploma') {
                    diplomaCount++;
                    diplomaTotalFees += totalFees;
                    diplomaFeesPaid += totalPaid;
                } else if (student.courseLevel === 'Certificate') {
                    certificateCount++;
                    certificateTotalFees += totalFees;
                    certificateFeesPaid += totalPaid;
                }
            });
            
            document.getElementById('reportDiplomaStudents').textContent = diplomaCount;
            document.getElementById('reportCertificateStudents').textContent = certificateCount;
            document.getElementById('reportDiplomaRevenue').textContent = `KES ${diplomaTotalFees.toLocaleString()}`;
            document.getElementById('reportCertificateRevenue').textContent = `KES ${certificateTotalFees.toLocaleString()}`;
            
            // Update course level chart
            if (!courseLevelChart) {
                const courseLevelCtx = document.getElementById('courseLevelChart').getContext('2d');
                courseLevelChart = new Chart(courseLevelCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Diploma', 'Certificate'],
                        datasets: [{
                            label: 'Number of Students',
                            data: [diplomaCount, certificateCount],
                            backgroundColor: ['#1a73e8', '#0d904f']
                        }]
                    }
                });
            } else {
                courseLevelChart.data.datasets[0].data = [diplomaCount, certificateCount];
                courseLevelChart.update();
            }
            
            // Load detailed fee report
            const detailedBody = document.getElementById('detailedReportBody');
            detailedBody.innerHTML = '';
            
            // Calculate fees by type
            const feeTypes = {
                'Course Fees': { total: 0, paid: 0, students: 0 },
                'Examination Fees': { total: 0, paid: 0, students: 0 },
                'Hostel Fees': { total: 0, paid: 0, students: 0 },
                'Other Fees': { total: 0, paid: 0, students: 0 }
            };
            
            // Course fees
            students.forEach(student => {
                const annualFee = parseFloat(
                    student.annualTuition || 
                    (student.semesterFee ? student.semesterFee * 2 : 0) || 
                    0
                );
                feeTypes['Course Fees'].total += annualFee;
                feeTypes['Course Fees'].students++;
            });
            
            // Additional fees
            Object.values(allData.additionalFees).forEach(fee => {
                if (fee) {
                    const type = fee.type === 'Examination' ? 'Examination Fees' :
                                fee.type === 'Hostel' ? 'Hostel Fees' : 'Other Fees';
                    
                    feeTypes[type].total += parseFloat(fee.totalAmount || 0);
                    feeTypes[type].paid += parseFloat(fee.amountPaid || 0);
                    feeTypes[type].students++;
                }
            });
            
            // Add rows for each fee type
            Object.entries(feeTypes).forEach(([type, data]) => {
                if (data.total > 0) {
                    const balance = data.total - data.paid;
                    const collectionRate = data.total > 0 ? Math.round((data.paid / data.total) * 100) : 0;
                    const status = balance <= 0 ? 'paid' : (data.paid > 0 ? 'partial' : 'unpaid');
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${type}</td>
                        <td>KES ${data.total.toLocaleString()}</td>
                        <td>KES ${data.paid.toLocaleString()}</td>
                        <td>KES ${balance.toLocaleString()}</td>
                        <td>${data.students}</td>
                        <td>${collectionRate}%</td>
                        <td><span class="status-badge status-${status}">${status}</span></td>
                    `;
                    
                    detailedBody.appendChild(row);
                }
            });
        }

        // Modal Functions
        function openModal(modalId) {
            if (!isLoggedIn) {
                showAlert('Please login first', 'error');
                return;
            }
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Toggle Theme
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            const themeToggle = document.querySelector('.theme-toggle');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }

        // Toggle Sidebar
        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // Show Loading
        function showLoading() {
            // Implement loading indicator if needed
        }

        function hideLoading() {
            // Hide loading indicator
        }

        // Show Alert
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Create alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            `;
            
            // Add to page
            document.querySelector('.main-content').prepend(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Record Payment for Specific Student
        function recordPaymentForStudent(admNo) {
            const studentSelect = document.getElementById('paymentStudent');
            studentSelect.value = admNo;
            loadStudentBalance();
            openModal('recordPaymentModal');
        }

        // View Student Details
        function viewStudentDetails(admNo) {
            const student = findStudentByAdmNo(admNo);
            if (!student) {
                showAlert('Student not found', 'error');
                return;
            }
            
            const modules = calculateModulePayments(student);
            const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
            const totalPayments = calculateTotalPayments(student);
            
            const content = document.getElementById('studentDetailsContent');
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div>
                        <h3>Personal Information</h3>
                        <div class="info-item">
                            <span>Admission Number:</span>
                            <span>${student.admNo}</span>
                        </div>
                        <div class="info-item">
                            <span>Full Name:</span>
                            <span>${student.fullName}</span>
                        </div>
                        <div class="info-item">
                            <span>Gender:</span>
                            <span>${student.gender}</span>
                        </div>
                        <div class="info-item">
                            <span>Course:</span>
                            <span>${student.courseName}</span>
                        </div>
                        <div class="info-item">
                            <span>Sponsorship:</span>
                            <span>${student.sponsor}</span>
                        </div>
                        <div class="info-item">
                            <span>Intake:</span>
                            <span>${student.intake}</span>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Financial Summary</h3>
                        <div class="info-item">
                            <span>Annual Fee:</span>
                            <span>KES ${(student.annualTuition || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Total Paid:</span>
                            <span>KES ${totalPayments.totalPaid.toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Balance:</span>
                            <span>KES ${((student.annualTuition || 0) + additionalFeesData.totalFees - totalPayments.totalPaid).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>Module Payments</h3>
                    <div class="module-details">
                        ${modules.map(module => `
                            <div class="module-row">
                                <div class="module-name">${module.name}</div>
                                <div class="module-amounts">
                                    <div class="module-total">KES ${module.moduleFee.toLocaleString()}</div>
                                    <div class="module-paid">KES ${module.paidAmount.toLocaleString()}</div>
                                    <div class="module-balance">KES ${module.balance.toLocaleString()}</div>
                                </div>
                                <span class="status-badge status-${module.status}">${module.status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>Additional Fees</h3>
                    ${Object.entries(additionalFeesData.feesByType).map(([type, data]) => `
                        <div class="info-item">
                            <span>${type}:</span>
                            <span>KES ${data.total.toLocaleString()} (Paid: KES ${data.paid.toLocaleString()})</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            openModal('viewStudentModal');
        }

        // Generate Receipt
        function generateReceipt(admNo, paymentData = null) {
            const student = findStudentByAdmNo(admNo);
            if (!student) {
                showAlert('Student not found', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Generate receipt content
            doc.setFontSize(20);
            doc.text('UNITED COLLEGE OF SCIENCE AND TECHNOLOGY', 105, 20, null, null, 'center');
            
            doc.setFontSize(16);
            doc.text('OFFICIAL RECEIPT', 105, 30, null, null, 'center');
            
            // Student details
            doc.setFontSize(12);
            doc.text(`Admission No: ${student.admNo}`, 20, 50);
            doc.text(`Student Name: ${student.fullName}`, 20, 60);
            doc.text(`Course: ${student.courseName}`, 20, 70);
            
            if (paymentData) {
                doc.text(`Payment Type: ${paymentData.type}`, 20, 80);
                doc.text(`Amount: KES ${paymentData.amountPaid.toLocaleString()}`, 20, 90);
                doc.text(`Date: ${new Date(paymentData.timestamp).toLocaleDateString()}`, 20, 100);
            }
            
            doc.text('Receipt No: ' + Date.now().toString().slice(-8), 20, 110);
            doc.text('Date: ' + new Date().toLocaleDateString(), 20, 120);
            
            // Show in preview modal
            const pdfDataUri = doc.output('datauristring');
            document.getElementById('pdfIframe').src = pdfDataUri;
            openModal('pdfPreviewModal');
            currentDoc = doc;
        }

        // Generate Statement
        function generateStatement(student) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Generate statement content
            doc.setFontSize(20);
            doc.text('UNITED COLLEGE OF SCIENCE AND TECHNOLOGY', 105, 20, null, null, 'center');
            
            doc.setFontSize(16);
            doc.text('STUDENT FINANCIAL STATEMENT', 105, 30, null, null, 'center');
            
            // Student details
            doc.setFontSize(12);
            doc.text(`Admission No: ${student.admNo}`, 20, 50);
            doc.text(`Student Name: ${student.fullName}`, 20, 60);
            doc.text(`Course: ${student.courseName}`, 20, 70);
            doc.text(`Statement Date: ${new Date().toLocaleDateString()}`, 20, 80);
            
            // Financial summary
            const modules = calculateModulePayments(student);
            const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
            const totalPayments = calculateTotalPayments(student);
            const annualFee = student.annualTuition || 0;
            
            let yPos = 100;
            
            doc.setFontSize(14);
            doc.text('Financial Summary', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.text(`Annual Course Fee: KES ${annualFee.toLocaleString()}`, 20, yPos);
            yPos += 10;
            
            modules.forEach(module => {
                doc.text(`${module.name}: KES ${module.paidAmount.toLocaleString()} / KES ${module.moduleFee.toLocaleString()}`, 20, yPos);
                yPos += 10;
            });
            
            if (additionalFeesData.totalFees > 0) {
                doc.text(`Additional Fees: KES ${additionalFeesData.totalFees.toLocaleString()}`, 20, yPos);
                yPos += 10;
            }
            
            doc.text(`Total Paid: KES ${totalPayments.totalPaid.toLocaleString()}`, 20, yPos);
            yPos += 10;
            
            const balance = annualFee + additionalFeesData.totalFees - totalPayments.totalPaid;
            doc.text(`Outstanding Balance: KES ${balance.toLocaleString()}`, 20, yPos);
            
            // Show in preview modal
            const pdfDataUri = doc.output('datauristring');
            document.getElementById('pdfIframe').src = pdfDataUri;
            openModal('pdfPreviewModal');
            currentDoc = doc;
        }

        // Export to Excel
        function exportToExcel(type) {
            if (!isLoggedIn) return;
            
            let data = [];
            let fileName = '';
            
            switch(type) {
                case 'finance':
                    // Export financial data
                    Object.values(allData.admissions).forEach(student => {
                        const modules = calculateModulePayments(student);
                        const additionalFeesData = calculateStudentAdditionalFees(student.admNo);
                        const totalPayments = calculateTotalPayments(student);
                        
                        data.push({
                            'Adm No': student.admNo,
                            'Student Name': student.fullName,
                            'Course': student.courseName,
                            'Annual Fee': student.annualTuition || 0,
                            'Module 1 Paid': modules[0]?.paidAmount || 0,
                            'Module 2 Paid': modules[1]?.paidAmount || 0,
                            'Module 3 Paid': modules[2]?.paidAmount || 0,
                            'Additional Fees': additionalFeesData.totalFees,
                            'Total Paid': totalPayments.totalPaid,
                            'Balance': (student.annualTuition || 0) + additionalFeesData.totalFees - totalPayments.totalPaid
                        });
                    });
                    fileName = 'financial_records.xlsx';
                    break;
                    
                case 'students':
                    // Export student data
                    Object.values(allData.admissions).forEach(student => {
                        data.push({
                            'Adm No': student.admNo,
                            'Full Name': student.fullName,
                            'Gender': student.gender,
                            'Course': student.courseName,
                            'Level': student.courseLevel,
                            'Sponsorship': student.sponsor,
                            'Phone': student.phone || '',
                            'Email': student.email || '',
                            'Status': student.status || 'Active'
                        });
                    });
                    fileName = 'student_records.xlsx';
                    break;
                    
                // Add other export types as needed
            }
            
            if (data.length === 0) {
                showAlert('No data to export', 'warning');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, fileName);
            
            showAlert('Export completed successfully', 'success');
        }

        // Print PDF
        function printPDF() {
            if (currentDoc) {
                currentDoc.autoPrint();
                window.open(currentDoc.output('bloburl'), '_blank');
            }
        }

        // Download PDF
        function downloadPDF() {
            if (currentDoc) {
                currentDoc.save(`ucst_document_${new Date().toISOString().split('T')[0]}.pdf`);
            }
        }

        // Utility Functions
        function updateStudentGender() {
            // Update hostel gender based on student selection
            const studentSelect = document.getElementById('hostelStudent');
            const student = findStudentByAdmNo(studentSelect.value);
            
            if (student) {
                // Filter hostels by student gender
                updateAvailableRooms(student.gender);
            }
        }

        function updateAvailableRooms(gender = null) {
            const hostelSelect = document.getElementById('hostelName');
            const roomSelect = document.getElementById('hostelRoom');
            
            if (!hostelSelect.value) {
                roomSelect.innerHTML = '<option value="">Select Room</option>';
                return;
            }
            
            // Find selected hostel
            const selectedHostel = Object.values(allData.hostels).find(
                h => h.hostelName === hostelSelect.value
            );
            
            if (selectedHostel) {
                // Update hostel info display
                document.getElementById('hostelTypeDisplay').textContent = selectedHostel.hostelType || '-';
                document.getElementById('bedsPerRoomDisplay').textContent = selectedHostel.bedsPerRoom || '-';
                
                // Calculate available beds
                const allocations = Object.values(allData.hostelAllocations).filter(
                    a => a.hostelName === hostelSelect.value && a.status === 'Allocated'
                );
                
                const totalBeds = (selectedHostel.totalRooms || 0) * (selectedHostel.bedsPerRoom || 1);
                const occupiedBeds = allocations.length;
                const availableBeds = totalBeds - occupiedBeds;
                
                document.getElementById('availableBedsDisplay').textContent = availableBeds;
                
                // Update room dropdown
                roomSelect.innerHTML = '<option value="">Select Room</option>';
                
                // Simple room listing - in real app, you'd want more sophisticated logic
                for (let i = 1; i <= (selectedHostel.totalRooms || 0); i++) {
                    const roomAllocations = allocations.filter(a => a.roomNumber === `Room ${i}`);
                    if (roomAllocations.length < (selectedHostel.bedsPerRoom || 1)) {
                        const option = document.createElement('option');
                        option.value = `Room ${i}`;
                        option.textContent = `Room ${i} (${(selectedHostel.bedsPerRoom || 1) - roomAllocations.length} beds available)`;
                        roomSelect.appendChild(option);
                    }
                }
            }
        }

        // Deallocate Hostel
        function deallocateHostel(admNo) {
            if (!confirm('Are you sure you want to deallocate this room?')) {
                return;
            }
            
            // Find the allocation
            const allocationKey = Object.keys(allData.hostelAllocations).find(
                key => allData.hostelAllocations[key].admNo === admNo && 
                       allData.hostelAllocations[key].status === 'Allocated'
            );
            
            if (allocationKey) {
                const updates = {};
                updates[`/hostelAllocations/${allocationKey}/status`] = 'Deallocated';
                updates[`/hostelAllocations/${allocationKey}/deallocatedAt`] = new Date().toISOString();
                
                db.ref().update(updates)
                    .then(() => {
                        showAlert('Room deallocated successfully', 'success');
                    })
                    .catch(error => {
                        console.error('Error deallocating room:', error);
                        showAlert('Error deallocating room', 'error');
                    });
            }
        }

        // Generate Financial Report
        function generateFinancialReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add report header
            doc.setFontSize(20);
            doc.text('UCST FINANCIAL REPORT', 105, 20, null, null, 'center');
            
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, null, null, 'center');
            
            // Add summary statistics
            let yPos = 50;
            
            doc.setFontSize(16);
            doc.text('Summary Statistics', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(12);
            doc.text(`Total Students: ${Object.values(allData.admissions).length}`, 20, yPos);
            yPos += 10;
            
            // Calculate total revenue
            let totalRevenue = 0;
            Object.values(allData.admissions).forEach(student => {
                totalRevenue += parseFloat(student.annualTuition || 0);
            });
            
            Object.values(allData.additionalFees).forEach(fee => {
                if (fee) {
                    totalRevenue += parseFloat(fee.totalAmount || 0);
                }
            });
            
            doc.text(`Total Revenue: KES ${totalRevenue.toLocaleString()}`, 20, yPos);
            yPos += 10;
            
            // Calculate total collected
            let totalCollected = 0;
            Object.values(allData.payments).forEach(payment => {
                if (payment) {
                    totalCollected += parseFloat(payment.amountPaid || 0);
                }
            });
            
            Object.values(allData.additionalFees).forEach(fee => {
                if (fee) {
                    totalCollected += parseFloat(fee.amountPaid || 0);
                }
            });
            
            doc.text(`Total Collected: KES ${totalCollected.toLocaleString()}`, 20, yPos);
            yPos += 10;
            
            doc.text(`Outstanding Balance: KES ${(totalRevenue - totalCollected).toLocaleString()}`, 20, yPos);
            yPos += 10;
            
            doc.text(`Collection Rate: ${totalRevenue > 0 ? Math.round((totalCollected / totalRevenue) * 100) : 0}%`, 20, yPos);
            
            // Show in preview modal
            const pdfDataUri = doc.output('datauristring');
            document.getElementById('pdfIframe').src = pdfDataUri;
            openModal('pdfPreviewModal');
            currentDoc = doc;
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        // Search Functionality
        document.getElementById('searchBox').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = e.target.value.toLowerCase();
                
                // Search logic based on current tab
                switch(currentTab) {
                    case 'students':
                        // Filter student table
                        filterTable('studentsTableBody', searchTerm);
                        break;
                    case 'finance':
                        // Filter finance table
                        filterTable('financeTableBody', searchTerm);
                        break;
                    case 'courses':
                        // Filter courses table
                        filterTable('coursesTableBody', searchTerm);
                        break;
                    // Add other tabs as needed
                }
            }
        });

        function filterTable(tableBodyId, searchTerm) {
            const rows = document.querySelectorAll(`#${tableBodyId} tr`);
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Initialize the application
        console.log('UCST Management System Initialized');
        console.log('Login Credentials: admin / 1234');
        console.log('All modules integrated: Login, Students, Finance, Courses, Exams, Hostel, Classes, Reports');
    </script>
</body>
</html>