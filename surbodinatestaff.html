<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UCST - Staff Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2062f0;
            --primary-light: #4a86f8;
            --primary-dark: #0a3cb9;
            --secondary: #3943d6;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Georgia, 'Times New Roman', Times, serif;
            background: #f5f7fb;
            color: #333;
            transition: var(--transition);
            overflow-x: hidden;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            text-decoration: none;
            color: white;
            position: relative;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255,255,255,0.1);
            border-left-color: white;
        }

        .menu-item i {
            margin-right: 12px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        /* Mobile Sidebar Close Button */
        .sidebar-close-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            width: 40px;
            height: 40px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .sidebar-close-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            color: var(--dark);
            padding: 0 20px;
            height: var(--header-height);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .header-left h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
        }

        .user-role {
            font-size: 0.8rem;
            color: #666;
        }

        /* Main */
        main {
            padding: 30px;
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: 600;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .card-icon.primary { background: var(--primary); }
        .card-icon.success { background: var(--success); }
        .card-icon.warning { background: var(--warning); }
        .card-icon.danger { background: var(--danger); }
        .card-icon.info { background: var(--info); }

        .card-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .card-footer {
            font-size: 0.8rem;
            color: var(--secondary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .tab {
            padding: 15px 20px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: rgba(32, 98, 240, 0.05);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background: var(--light);
            font-weight: 600;
            color: var(--secondary);
        }

        tr:hover {
            background: rgba(0,123,255,0.03);
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* Buttons */
        button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: #fff;
        }

        .btn-warning {
            background: var(--warning);
            color: #000;
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-info {
            background: var(--info);
            color: #fff;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--secondary);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            transition: var(--transition);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(32, 98, 240, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            width: 700px;
            max-height: 90%;
            overflow: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1100;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .success-message.show {
            transform: translateX(0);
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.on-leave {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Department cards */
        .departments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .department-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }

        .department-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .department-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .staff-count {
            color: var(--secondary);
            font-size: 0.9rem;
        }

        /* Search input */
        #searchBox {
            padding: 8px 15px;
            border-radius: 30px;
            border: 1px solid #ddd;
            width: 250px;
            margin-right: 15px;
            transition: var(--transition);
        }

        #searchBox:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(32, 98, 240, 0.2);
        }

        /* Attendance grid */
        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .attendance-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .attendance-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        /* Settings Styles */
        .settings-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .settings-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
            }
            .form-row {
                flex-direction: column;
            }
            #searchBox {
                width: 180px;
            }
            .departments-grid {
                grid-template-columns: 1fr;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            /* Sidebar Mobile Styles */
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
                box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            }
            
            /* Show close button on mobile */
            .sidebar-close-btn {
                display: block;
                position: absolute;
                top: 20px;
                right: 20px;
            }
            
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 999;
                background: var(--primary);
                color: white;
                border: none;
                border-radius: 5px;
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            }
            
            /* Header adjustments for mobile */
            header {
                padding-left: 70px;
            }
            
            .header-left h1 {
                font-size: 1.2rem;
            }
            
            /* Adjust modal for mobile */
            .modal-content {
                width: 95%;
                max-height: 95%;
                padding: 15px;
                margin: 10px;
            }
            
            /* Overlay for mobile sidebar */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            
            .sidebar-overlay.active {
                display: block;
            }
        }

        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                flex-direction: column;
            }
            #searchBox {
                width: 150px;
            }
            .header-left h1 {
                font-size: 1.1rem;
            }
            main {
                padding: 15px;
            }
            .mobile-menu-btn {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            cursor: pointer;
        }

        /* Mobile Navbar Styles */
        .mobile-navbar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--primary);
            color: white;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 0;
        }

        .mobile-navbar.active {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: var(--transition);
            flex: 1;
            text-align: center;
        }

        .mobile-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .mobile-nav-item span {
            font-size: 0.8rem;
        }

        .mobile-nav-item.active {
            background: rgba(255,255,255,0.2);
        }

        .mobile-nav-item:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
<div class="dashboard-container">
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div>
                <h2>UCST College</h2>
                <p>Staff Management System</p>
            </div>
            <button class="sidebar-close-btn" id="sidebarCloseBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-menu">
            <a href="#" class="menu-item active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="staff">
                <i class="fas fa-users"></i>
                <span>Staff Management</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="attendance">
                <i class="fas fa-clipboard-check"></i>
                <span>Attendance</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="payroll">
                <i class="fas fa-money-bill-wave"></i>
                <span>Payroll</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="departments">
                <i class="fas fa-sitemap"></i>
                <span>Departments</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="leaves">
                <i class="fas fa-calendar-alt"></i>
                <span>Leave Management</span>
                <span class="notification-badge" id="leaveNotificationBadge" style="display: none;">0</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="reports">
                <i class="fas fa-chart-bar"></i>
                <span>Reports</span>
            </a>
            
            <a href="#" class="menu-item" data-tab="settings">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <header>
            <div class="header-left">
                <h1>Non-Teaching Staff Management</h1>
            </div>
            
            <div class="header-right">
                <input type="text" id="searchBox" placeholder="Search staff...">
                <div class="user-profile">
                    <div class="user-avatar">HR</div>
                    <div class="user-info">
                        <div class="user-name">HR Manager</div>
                        <div class="user-role">Human Resources</div>
                    </div>
                </div>
            </div>
        </header>

        <main>
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="dashboard">
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Total Staff</div>
                            <div class="card-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalStaff">0</div>
                        <div class="card-footer">Non-teaching staff members</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Present Today</div>
                            <div class="card-icon success">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="card-value" id="presentToday">0</div>
                        <div class="card-footer">Staff present today</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">On Leave</div>
                            <div class="card-icon warning">
                                <i class="fas fa-calendar-minus"></i>
                            </div>
                        </div>
                        <div class="card-value" id="onLeave">0</div>
                        <div class="card-footer">Staff on leave</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Departments</div>
                            <div class="card-icon info">
                                <i class="fas fa-sitemap"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalDepartments">12</div>
                        <div class="card-footer">Active departments</div>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="table-container">
                    <div class="card-header">
                        <h3>Recent Staff Activities</h3>
                        <button class="btn-primary" onclick="openStaffModal()">
                            <i class="fas fa-plus"></i> Add Staff
                        </button>
                    </div>
                    <table id="recentActivitiesTable">
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Employee ID</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Status</th>
                                <th>Last Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentActivitiesTableBody">
                            <tr><td colspan="7">Loading staff data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Staff Management Tab -->
            <div class="tab-content" id="staff">
                <div class="card-header">
                    <h3>Staff Management</h3>
                    <div>
                        <button class="btn-primary" onclick="openStaffModal()">
                            <i class="fas fa-plus"></i> Add Staff
                        </button>
                        <button class="btn-info" onclick="exportStaffList()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="staffTable">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Full Name</th>
                                <th>Department</th>
                                <th>Position</th>
                                <th>Contact</th>
                                <th>Employment Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <tr><td colspan="8">Loading staff data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Attendance Tab -->
            <div class="tab-content" id="attendance">
                <div class="card-header">
                    <h3>Attendance Management</h3>
                    <div>
                        <button class="btn-success" onclick="openAttendanceModal()">
                            <i class="fas fa-check-circle"></i> Mark Attendance
                        </button>
                        <button class="btn-info" onclick="generateAttendanceReport()">
                            <i class="fas fa-chart-bar"></i> Report
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="attendanceDate">Date</label>
                        <input type="date" id="attendanceDate">
                    </div>
                    <div class="form-group">
                        <label for="attendanceDepartment">Department</label>
                        <select id="attendanceDepartment">
                            <option value="">All Departments</option>
                            <option value="Administration">Administration</option>
                            <option value="Finance & Accounts">Finance & Accounts</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="ICT Department">ICT Department</option>
                            <option value="Library">Library</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Security">Security</option>
                            <option value="Transport">Transport</option>
                            <option value="Catering">Catering</option>
                            <option value="Health Services">Health Services</option>
                            <option value="Registry">Registry</option>
                            <option value="Procurement">Procurement</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="attendanceTable">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Staff Name</th>
                                <th>Department</th>
                                <th>Time In</th>
                                <th>Time Out</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceTableBody">
                            <tr><td colspan="8">Select date to view attendance</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Payroll Tab -->
            <div class="tab-content" id="payroll">
                <div class="card-header">
                    <h3>Payroll Management</h3>
                    <div>
                        <button class="btn-primary" onclick="processPayroll()">
                            <i class="fas fa-calculator"></i> Process Payroll
                        </button>
                        <button class="btn-success" onclick="generatePayslips()">
                            <i class="fas fa-file-invoice"></i> Generate Payslips
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="payrollMonth">Payroll Month</label>
                        <input type="month" id="payrollMonth">
                    </div>
                    <div class="form-group">
                        <label for="payrollDepartment">Department</label>
                        <select id="payrollDepartment">
                            <option value="">All Departments</option>
                            <option value="Administration">Administration</option>
                            <option value="Finance & Accounts">Finance & Accounts</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="ICT Department">ICT Department</option>
                            <option value="Library">Library</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Security">Security</option>
                            <option value="Transport">Transport</option>
                            <option value="Catering">Catering</option>
                            <option value="Health Services">Health Services</option>
                            <option value="Registry">Registry</option>
                            <option value="Procurement">Procurement</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="payrollTable">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Staff Name</th>
                                <th>Basic Salary</th>
                                <th>Allowances</th>
                                <th>Deductions</th>
                                <th>Net Salary</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <tr><td colspan="8">Select month to view payroll</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Departments Tab -->
            <div class="tab-content" id="departments">
                <div class="card-header">
                    <h3>Department Management</h3>
                    <button class="btn-primary" onclick="openDepartmentModal()">
                        <i class="fas fa-plus"></i> Add Department
                    </button>
                </div>
                
                <div class="departments-grid" id="departmentsGrid">
                    <!-- Department cards will be dynamically generated here -->
                </div>
            </div>

            <!-- Leave Management Tab -->
            <div class="tab-content" id="leaves">
                <div class="card-header">
                    <h3>Leave Management</h3>
                    <button class="btn-primary" onclick="openLeaveModal()">
                        <i class="fas fa-plus"></i> Apply Leave
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="leavesTable">
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Employee ID</th>
                                <th>Leave Type</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leavesTableBody">
                            <tr><td colspan="8">Loading leave records...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div class="tab-content" id="reports">
                <div class="card-header">
                    <h3>Reports & Analytics</h3>
                    <div>
                        <button class="btn-info" onclick="generateStaffReport()">
                            <i class="fas fa-users"></i> Staff Report
                        </button>
                        <button class="btn-warning" onclick="generateAttendanceSummary()">
                            <i class="fas fa-chart-pie"></i> Attendance Summary
                        </button>
                        <button class="btn-success" onclick="generatePayrollReport()">
                            <i class="fas fa-file-pdf"></i> Payroll Report
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportDepartment">Department</label>
                        <select id="reportDepartment">
                            <option value="">All Departments</option>
                            <option value="Administration">Administration</option>
                            <option value="Finance & Accounts">Finance & Accounts</option>
                            <option value="Human Resources">Human Resources</option>
                            <option value="ICT Department">ICT Department</option>
                            <option value="Library">Library</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Security">Security</option>
                            <option value="Transport">Transport</option>
                            <option value="Catering">Catering</option>
                            <option value="Health Services">Health Services</option>
                            <option value="Registry">Registry</option>
                            <option value="Procurement">Procurement</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportPeriod">Period</label>
                        <select id="reportPeriod">
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportYear">Year</label>
                        <select id="reportYear">
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                        </select>
                    </div>
                </div>
                
                <div class="attendance-grid">
                    <div class="attendance-card">
                        <div class="card-title">Average Attendance</div>
                        <div class="attendance-value" id="avgAttendance">0%</div>
                        <div class="card-footer">This month</div>
                    </div>
                    <div class="attendance-card">
                        <div class="card-title">Leave Utilization</div>
                        <div class="attendance-value" id="leaveUtilization">0%</div>
                        <div class="card-footer">Annual leave used</div>
                    </div>
                    <div class="attendance-card">
                        <div class="card-title">Staff Turnover</div>
                        <div class="attendance-value" id="staffTurnover">0%</div>
                        <div class="card-footer">This year</div>
                    </div>
                    <div class="attendance-card">
                        <div class="card-title">Overtime Hours</div>
                        <div class="attendance-value" id="overtimeHours">0</div>
                        <div class="card-footer">This month</div>
                    </div>
                </div>
                
                <div id="reportResults" class="table-container" style="margin-top: 20px;">
                    <h4 style="padding: 15px; border-bottom: 1px solid #ddd;">Detailed Report</h4>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Department</th>
                                <th>Total Staff</th>
                                <th>Present</th>
                                <th>On Leave</th>
                                <th>Absent</th>
                                <th>Attendance %</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <tr><td colspan="6">Select filters to generate report</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="settings">
                <div class="settings-section">
                    <h3>System Settings</h3>
                    <div class="form-group">
                        <label for="systemName">System Name</label>
                        <input type="text" id="systemName" value="UCST Staff Management System" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Administrator Email</label>
                        <input type="email" id="adminEmail" value="admin@ucst.edu" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="autoBackup">Automatic Backup</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoBackup" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Enable daily automatic backups</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="backupTime">Backup Time</label>
                        <input type="time" id="backupTime" value="02:00" class="form-control">
                    </div>
                    <button class="btn-primary" onclick="saveSystemSettings()">Save System Settings</button>
                </div>

                <div class="settings-section">
                    <h3>Attendance Settings</h3>
                    <div class="form-group">
                        <label for="workStartTime">Work Start Time</label>
                        <input type="time" id="workStartTime" value="08:00" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="workEndTime">Work End Time</label>
                        <input type="time" id="workEndTime" value="17:00" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="lateThreshold">Late Threshold (minutes)</label>
                        <input type="number" id="lateThreshold" value="15" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="autoLogout">Auto Logout After Hours</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoLogout">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Enable automatic logout after work hours</span>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveAttendanceSettings()">Save Attendance Settings</button>
                </div>

                <div class="settings-section">
                    <h3>Notification Settings</h3>
                    <div class="form-group">
                        <label for="emailNotifications">Email Notifications</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="emailNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Receive email notifications</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="leaveApprovals">Leave Approval Notifications</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="leaveApprovals" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Notify on leave applications</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="payrollAlerts">Payroll Alerts</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="payrollAlerts" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Alert before payroll processing</span>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="saveNotificationSettings()">Save Notification Settings</button>
                </div>

                <div class="settings-section">
                    <h3>Database Management</h3>
                    <div class="form-group">
                        <label>Backup Database</label>
                        <button class="btn-info" onclick="backupDatabase()">
                            <i class="fas fa-download"></i> Create Backup
                        </button>
                    </div>
                    <div class="form-group">
                        <label>Clear Cache</label>
                        <button class="btn-warning" onclick="clearCache()">
                            <i class="fas fa-broom"></i> Clear System Cache
                        </button>
                    </div>
                    <div class="form-group">
                        <label>System Logs</label>
                        <button class="btn-info" onclick="viewSystemLogs()">
                            <i class="fas fa-file-alt"></i> View Logs
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Mobile Navbar -->
<div class="mobile-navbar" id="mobileNavbar">
    <a href="#" class="mobile-nav-item active" data-tab="dashboard">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
    </a>
    <a href="#" class="mobile-nav-item" data-tab="staff">
        <i class="fas fa-users"></i>
        <span>Staff</span>
    </a>
    <a href="#" class="mobile-nav-item" data-tab="attendance">
        <i class="fas fa-clipboard-check"></i>
        <span>Attendance</span>
    </a>
    <a href="#" class="mobile-nav-item" data-tab="menu" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
        <span>Menu</span>
    </a>
</div>

<!-- Staff Modal -->
<div class="modal" id="staffModal">
    <div class="modal-content">
        <h3 id="staffModalTitle">Add New Staff Member</h3>
        <form id="staffForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="staffFirstName">First Name</label>
                    <input type="text" id="staffFirstName" required>
                </div>
                <div class="form-group">
                    <label for="staffLastName">Last Name</label>
                    <input type="text" id="staffLastName" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="staffDepartment">Department</label>
                    <select id="staffDepartment" required>
                        <option value="">-- Select Department --</option>
                        <option value="Administration">Administration</option>
                        <option value="Finance & Accounts">Finance & Accounts</option>
                        <option value="Human Resources">Human Resources</option>
                        <option value="ICT Department">ICT Department</option>
                        <option value="Library">Library</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Security">Security</option>
                        <option value="Transport">Transport</option>
                        <option value="Catering">Catering</option>
                        <option value="Health Services">Health Services</option>
                        <option value="Registry">Registry</option>
                        <option value="Procurement">Procurement</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="staffPosition">Position</label>
                    <input type="text" id="staffPosition" required list="positionSuggestions">
                    <datalist id="positionSuggestions">
                        <!-- Position suggestions will be populated dynamically -->
                    </datalist>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="staffEmail">Email</label>
                    <input type="email" id="staffEmail" required>
                </div>
                <div class="form-group">
                    <label for="staffPhone">Phone</label>
                    <input type="tel" id="staffPhone" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="staffSalary">Basic Salary</label>
                    <input type="number" id="staffSalary" required>
                </div>
                <div class="form-group">
                    <label for="staffEmploymentDate">Employment Date</label>
                    <input type="date" id="staffEmploymentDate" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="staffAddress">Address</label>
                <textarea id="staffAddress" rows="2"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary" id="staffSubmitBtn">Save Staff</button>
                <button type="button" class="btn-danger" onclick="closeStaffModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Staff View Modal -->
<div class="modal" id="staffViewModal">
    <div class="modal-content" style="max-width: 600px;">
        <h3>Staff Details</h3>
        <div id="staffDetailsContent"></div>
        <div class="modal-actions">
            <button class="btn-danger" onclick="closeModal('staffViewModal')">Close</button>
        </div>
    </div>
</div>

<!-- Department Modal -->
<div class="modal" id="departmentModal">
    <div class="modal-content">
        <h3>Add New Department</h3>
        <form id="departmentForm">
            <div class="form-group">
                <label for="departmentName">Department Name</label>
                <input type="text" id="departmentName" required>
            </div>
            
            <div class="form-group">
                <label for="departmentHead">Department Head</label>
                <select id="departmentHead">
                    <option value="">-- Select Head --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="departmentDescription">Description</label>
                <textarea id="departmentDescription" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="departmentColor">Department Color</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="color" id="departmentColor" value="#2062f0" style="width: 60px; height: 40px;">
                    <input type="text" id="departmentColorText" value="#2062f0" style="flex: 1;" placeholder="#2062f0">
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Save Department</button>
                <button type="button" class="btn-danger" onclick="closeDepartmentModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Attendance Modal -->
<div class="modal" id="attendanceModal">
    <div class="modal-content" style="max-width: 900px;">
        <h3>Mark Attendance</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="markAttendanceDate">Date</label>
                <input type="date" id="markAttendanceDate">
            </div>
            <div class="form-group">
                <label for="markAttendanceDepartment">Department</label>
                <select id="markAttendanceDepartment">
                    <option value="">All Departments</option>
                    <option value="Administration">Administration</option>
                    <option value="Finance & Accounts">Finance & Accounts</option>
                    <option value="Human Resources">Human Resources</option>
                    <option value="ICT Department">ICT Department</option>
                    <option value="Library">Library</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Security">Security</option>
                    <option value="Transport">Transport</option>
                    <option value="Catering">Catering</option>
                    <option value="Health Services">Health Services</option>
                    <option value="Registry">Registry</option>
                    <option value="Procurement">Procurement</option>
                </select>
            </div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Staff Name</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Time In</th>
                        <th>Time Out</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="attendanceMarkTableBody">
                    <!-- Attendance marking rows will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div class="modal-actions">
            <button class="btn-success" onclick="saveAttendance()">Save Attendance</button>
            <button class="btn-danger" onclick="closeModal('attendanceModal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Leave Modal -->
<div class="modal" id="leaveModal">
    <div class="modal-content">
        <h3>Apply for Leave</h3>
        <form id="leaveForm">
            <div class="form-group">
                <label for="leaveStaff">Staff Member</label>
                <select id="leaveStaff" required>
                    <option value="">-- Select Staff --</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="leaveType">Leave Type</label>
                    <select id="leaveType" required>
                        <option value="">-- Select Type --</option>
                        <option value="Annual">Annual Leave</option>
                        <option value="Sick">Sick Leave</option>
                        <option value="Maternity">Maternity Leave</option>
                        <option value="Paternity">Paternity Leave</option>
                        <option value="Emergency">Emergency Leave</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="leaveDuration">Duration (Days)</label>
                    <input type="number" id="leaveDuration" min="1" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="leaveStart">Start Date</label>
                    <input type="date" id="leaveStart" required>
                </div>
                <div class="form-group">
                    <label for="leaveEnd">End Date</label>
                    <input type="date" id="leaveEnd" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="leaveReason">Reason</label>
                <textarea id="leaveReason" rows="3" required></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Apply for Leave</button>
                <button type="button" class="btn-danger" onclick="closeLeaveModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Success Message -->
<div class="success-message" id="successMessage">
    <i class="fas fa-check-circle"></i>
    <span>Operation completed successfully!</span>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyAQZ1_Grh00sFgOp8pxkKff10sMFSw9xlc",
    authDomain: "jnnp-system.firebaseapp.com",
    databaseURL: "https://jnnp-system-default-rtdb.firebaseio.com",
    projectId: "jnnp-system",
    storageBucket: "jnnp-system.firebasestorage.app", 
    messagingSenderId: "769232855377",
    appId: "1:769232855377:web:e3ba51e3e25cc24735f370"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global variables
let staff = {};
let departments = {};
let attendance = {};
let payroll = {};
let leaves = {};
let isDataLoaded = false;
let currentEditStaffId = null;

// Hardcoded department list for dropdowns
const departmentList = [
    "Administration",
    "Finance & Accounts",
    "Human Resources",
    "ICT Department",
    "Library",
    "Maintenance",
    "Security",
    "Transport",
    "Catering",
    "Health Services",
    "Registry",
    "Procurement"
];

// Common positions for each department
const departmentPositions = {
    "Administration": ["Administrative Officer", "Executive Secretary", "Office Assistant", "Receptionist", "Records Officer"],
    "Finance & Accounts": ["Chief Accountant", "Accountant", "Accounts Assistant", "Payroll Officer", "Bursar"],
    "Human Resources": ["HR Manager", "HR Officer", "Recruitment Officer", "Training Coordinator", "Welfare Officer"],
    "ICT Department": ["ICT Manager", "Systems Administrator", "Network Engineer", "IT Support", "Database Administrator"],
    "Library": ["Librarian", "Assistant Librarian", "Library Assistant", "Cataloguer", "Research Assistant"],
    "Maintenance": ["Maintenance Manager", "Electrician", "Plumber", "Carpenter", "Grounds Keeper", "Cleaner"],
    "Security": ["Chief Security Officer", "Security Supervisor", "Security Guard", "Gate Keeper"],
    "Transport": ["Transport Manager", "Driver", "Mechanic", "Transport Coordinator"],
    "Catering": ["Catering Manager", "Cook", "Kitchen Assistant", "Server", "Store Keeper"],
    "Health Services": ["Nurse", "Medical Officer", "Health Assistant", "First Aid Officer"],
    "Registry": ["Registry Officer", "Records Clerk", "Documentation Officer", "Admissions Officer"],
    "Procurement": ["Procurement Officer", "Store Keeper", "Purchasing Assistant", "Inventory Controller"]
};

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    initializeDepartmentDropdowns();
    loadData();
    setupMobileMenu();
    setupMobileNavbar();
    checkMobileView();
});

// Check if mobile view and setup accordingly
function checkMobileView() {
    if (window.innerWidth <= 768) {
        document.getElementById('mobileNavbar').classList.add('active');
    } else {
        document.getElementById('mobileNavbar').classList.remove('active');
    }
}

// Setup mobile navbar functionality
function setupMobileNavbar() {
    const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
    
    mobileNavItems.forEach(item => {
        item.addEventListener('click', function(e) {
            if (this.getAttribute('data-tab') === 'menu') {
                e.preventDefault();
                // Open sidebar
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebarOverlay').classList.add('active');
            } else {
                e.preventDefault();
                const tabId = this.getAttribute('data-tab');
                
                // Update active state
                mobileNavItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // Switch tab
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                // Update sidebar menu item
                const sidebarItem = document.querySelector(`.menu-item[data-tab="${tabId}"]`);
                if (sidebarItem) {
                    sidebarItem.classList.add('active');
                }
            }
        });
    });
}

// Setup mobile menu functionality
function setupMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    
    // Open sidebar from top button
    mobileMenuBtn.addEventListener('click', function() {
        sidebar.classList.add('active');
        sidebarOverlay.classList.add('active');
    });
    
    // Open sidebar from mobile navbar menu item
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', function() {
            sidebar.classList.add('active');
            sidebarOverlay.classList.add('active');
        });
    }
    
    // Close sidebar
    sidebarCloseBtn.addEventListener('click', function() {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    });
    
    // Close sidebar when clicking overlay
    sidebarOverlay.addEventListener('click', function() {
        sidebar.classList.remove('active');
        sidebarOverlay.classList.remove('active');
    });
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768 && !sidebar.contains(e.target) && 
            !mobileMenuBtn.contains(e.target) && 
            (!mobileMenuToggle || !mobileMenuToggle.contains(e.target))) {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }
    });
    
    // Close sidebar when clicking a menu item
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                
                // Update mobile navbar active state
                const tabId = this.getAttribute('data-tab');
                document.querySelectorAll('.mobile-nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                    if (navItem.getAttribute('data-tab') === tabId) {
                        navItem.classList.add('active');
                    }
                });
            }
        });
    });
    
    // Check on resize
    window.addEventListener('resize', function() {
        checkMobileView();
    });
}

// Initialize all department dropdowns with hardcoded values
function initializeDepartmentDropdowns() {
    const departmentSelects = [
        document.getElementById('staffDepartment'),
        document.getElementById('attendanceDepartment'),
        document.getElementById('payrollDepartment'),
        document.getElementById('reportDepartment'),
        document.getElementById('markAttendanceDepartment')
    ];
    
    departmentSelects.forEach(select => {
        if (select) {
            // Clear existing options except the first one
            const firstOption = select.options[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Add all departments from the hardcoded list
            departmentList.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }
    });
}

// Load data from Firebase (staff, attendance, payroll, leaves)
function loadData() {
    console.log("Loading staff data from Firebase...");
    
    // Load staff
    db.ref("non_teaching_staff").once("value").then(snapshot => {
        staff = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(staff).length} staff members`);
        updateDashboardCards();
        updateStaffSelects();
        renderStaffTable();
        renderRecentActivities();
        renderDepartmentsGrid();
        checkDataLoaded();
    });

    // Load attendance
    db.ref("staff_attendance").once("value").then(snapshot => {
        attendance = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(attendance).length} attendance records`);
        checkDataLoaded();
    });

    // Load payroll
    db.ref("staff_payroll").once("value").then(snapshot => {
        payroll = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(payroll).length} payroll records`);
        checkDataLoaded();
    });

    // Load leaves
    db.ref("staff_leaves").once("value").then(snapshot => {
        leaves = snapshot.val() || {};
        console.log(`Loaded ${Object.keys(leaves).length} leave records`);
        renderLeavesTable();
        updateDashboardCards();
        updateLeaveNotifications();
        checkDataLoaded();
    });
}

function checkDataLoaded() {
    if (Object.keys(staff).length >= 0) {
        isDataLoaded = true;
        console.log("All staff data loaded successfully");
    }
}

// Setup event listeners
function setupEventListeners() {
    // Tab switching for desktop sidebar
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            // Update mobile navbar active state
            document.querySelectorAll('.mobile-nav-item').forEach(navItem => {
                navItem.classList.remove('active');
                if (navItem.getAttribute('data-tab') === tabId) {
                    navItem.classList.add('active');
                }
            });
            
            // Close mobile sidebar after selection
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        });
    });

    // Search functionality
    document.getElementById('searchBox').addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        filterStaffTable(searchTerm);
    });

    // Form submissions
    document.getElementById('staffForm').addEventListener('submit', handleStaffSubmit);
    document.getElementById('departmentForm').addEventListener('submit', handleDepartmentSubmit);
    document.getElementById('leaveForm').addEventListener('submit', handleLeaveSubmit);

    // Date change listeners
    document.getElementById('attendanceDate').addEventListener('change', loadAttendanceForDate);
    document.getElementById('payrollMonth').addEventListener('change', loadPayrollForMonth);

    // Report filters
    document.getElementById('reportDepartment').addEventListener('change', generateReports);
    document.getElementById('reportPeriod').addEventListener('change', generateReports);

    // Leave date calculations
    document.getElementById('leaveStart').addEventListener('change', calculateLeaveDuration);
    document.getElementById('leaveEnd').addEventListener('change', calculateLeaveDuration);

    // Department color sync
    const colorInput = document.getElementById('departmentColor');
    const colorText = document.getElementById('departmentColorText');
    if (colorInput && colorText) {
        colorInput.addEventListener('input', function() {
            colorText.value = this.value;
        });
        colorText.addEventListener('input', function() {
            colorInput.value = this.value;
        });
    }

    // Enhanced department change for attendance and payroll
    document.getElementById('attendanceDepartment').addEventListener('change', function() {
        loadStaffByDepartment(this.value, 'attendance');
    });
    
    document.getElementById('payrollDepartment').addEventListener('change', function() {
        loadStaffByDepartment(this.value, 'payroll');
    });

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
}

// Update leave notifications badge
function updateLeaveNotifications() {
    const pendingLeaves = Object.values(leaves).filter(leave => leave.status === 'Pending').length;
    const notificationBadge = document.getElementById('leaveNotificationBadge');
    
    if (pendingLeaves > 0) {
        notificationBadge.textContent = pendingLeaves;
        notificationBadge.style.display = 'flex';
    } else {
        notificationBadge.style.display = 'none';
    }
}

// Load staff by department for different modules
function loadStaffByDepartment(department, module) {
    let tbody;
    let tableData = [];
    
    switch(module) {
        case 'attendance':
            tbody = document.getElementById('attendanceTableBody');
            tableData = generateAttendanceTableData(department);
            break;
        case 'payroll':
            tbody = document.getElementById('payrollTableBody');
            tableData = generatePayrollTableData(department);
            break;
    }
    
    if (tableData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8">No staff found in ${department || 'selected department'}</td></tr>`;
        return;
    }
    
    tbody.innerHTML = tableData.join('');
}

// Generate attendance table rows based on department
function generateAttendanceTableData(department) {
    const filteredStaff = Object.entries(staff).filter(([id, staffMember]) => {
        if (staffMember.status !== 'Active') return false;
        if (department && staffMember.department !== department) return false;
        return true;
    });
    
    return filteredStaff.map(([id, staffMember]) => {
        const today = new Date().toISOString().split('T')[0];
        const todayAttendance = Object.values(attendance).find(att => 
            att.date === today && att.records?.some(record => record.staffId === id)
        );
        
        const staffAttendance = todayAttendance?.records?.find(record => record.staffId === id);
        
        return `
            <tr>
                <td>${staffMember.employeeId}</td>
                <td>${staffMember.firstName} ${staffMember.lastName}</td>
                <td>${staffMember.department}</td>
                <td>${staffAttendance?.timeIn || '--:--'}</td>
                <td>${staffAttendance?.timeOut || '--:--'}</td>
                <td><span class="status-badge ${staffAttendance?.status === 'Present' ? 'active' : staffAttendance?.status === 'Late' ? 'pending' : 'inactive'}">${staffAttendance?.status || 'Not Marked'}</span></td>
                <td>${staffAttendance?.remarks || '-'}</td>
                <td>
                    <button class="btn-warning" onclick="markIndividualAttendance('${id}')">
                        <i class="fas fa-edit"></i> Mark
                    </button>
                </td>
            </tr>
        `;
    });
}

// Generate payroll table rows based on department
function generatePayrollTableData(department) {
    const filteredStaff = Object.entries(staff).filter(([id, staffMember]) => {
        if (staffMember.status !== 'Active') return false;
        if (department && staffMember.department !== department) return false;
        return true;
    });
    
    return filteredStaff.map(([id, staffMember]) => {
        const payrollMonth = document.getElementById('payrollMonth').value;
        const payrollRecord = Object.values(payroll).find(p => 
            p.staffId === id && p.month === payrollMonth
        );
        
        return `
            <tr>
                <td>${staffMember.employeeId}</td>
                <td>${staffMember.firstName} ${staffMember.lastName}</td>
                <td>$${staffMember.salary || '0'}</td>
                <td>$${payrollRecord?.allowances || '0'}</td>
                <td>$${payrollRecord?.deductions || '0'}</td>
                <td>$${payrollRecord?.netSalary || staffMember.salary || '0'}</td>
                <td><span class="status-badge ${payrollRecord ? 'active' : 'pending'}">${payrollRecord ? 'Processed' : 'Pending'}</span></td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-info" onclick="viewPayslip('${id}', '${payrollMonth}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-warning" onclick="editPayroll('${id}', '${payrollMonth}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
}

// Update dashboard cards
function updateDashboardCards() {
    // Total staff
    document.getElementById('totalStaff').textContent = Object.keys(staff).length;
    
    // Calculate present today (mock data for demo)
    const presentToday = Object.keys(staff).length - 2; // Mock calculation
    document.getElementById('presentToday').textContent = presentToday;
    
    // Calculate staff on leave
    const onLeave = Object.values(leaves).filter(leave => 
        leave.status === 'Approved' && isDateInRange(new Date(), leave.startDate, leave.endDate)
    ).length;
    document.getElementById('onLeave').textContent = onLeave;
    
    // Total departments (hardcoded)
    document.getElementById('totalDepartments').textContent = departmentList.length;
}

// Update staff dropdowns
function updateStaffSelects() {
    const staffSelects = [
        document.getElementById('leaveStaff'),
        document.getElementById('departmentHead')
    ];
    
    staffSelects.forEach(select => {
        if (select) {
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Staff --</option>';
            
            Object.entries(staff).forEach(([id, staffMember]) => {
                if (staffMember.status === 'Active') {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${staffMember.employeeId} - ${staffMember.firstName} ${staffMember.lastName}`;
                    select.appendChild(option);
                }
            });
            
            if (currentValue && staff[currentValue]) {
                select.value = currentValue;
            }
        }
    });
}

// Enhanced staff table rendering with delete button
function renderStaffTable() {
    const tbody = document.getElementById('staffTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(staff).length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No staff members found</td></tr>';
        return;
    }
    
    Object.entries(staff).forEach(([id, staffMember]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${staffMember.employeeId || 'N/A'}</td>
            <td>${staffMember.firstName} ${staffMember.lastName}</td>
            <td>${staffMember.department || 'N/A'}</td>
            <td>${staffMember.position || 'N/A'}</td>
            <td>${staffMember.phone || 'N/A'}<br>${staffMember.email || 'N/A'}</td>
            <td>${staffMember.employmentDate || 'N/A'}</td>
            <td><span class="status-badge ${staffMember.status === 'Active' ? 'active' : 'inactive'}">${staffMember.status || 'Active'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="viewStaff('${id}')" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-warning" onclick="editStaff('${id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-danger" onclick="deleteStaff('${id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Enhanced edit staff function with modal
function editStaff(staffId) {
    if (!staff[staffId]) {
        alert('Staff member not found');
        return;
    }
    
    const staffMember = staff[staffId];
    currentEditStaffId = staffId;
    
    // Populate the existing staff modal with data
    document.getElementById('staffModal').style.display = 'flex';
    document.getElementById('staffModalTitle').textContent = 'Edit Staff Member';
    document.getElementById('staffSubmitBtn').textContent = 'Update Staff';
    
    // Fill form with existing data
    document.getElementById('staffFirstName').value = staffMember.firstName || '';
    document.getElementById('staffLastName').value = staffMember.lastName || '';
    document.getElementById('staffDepartment').value = staffMember.department || '';
    document.getElementById('staffPosition').value = staffMember.position || '';
    document.getElementById('staffEmail').value = staffMember.email || '';
    document.getElementById('staffPhone').value = staffMember.phone || '';
    document.getElementById('staffSalary').value = staffMember.salary || '';
    document.getElementById('staffEmploymentDate').value = staffMember.employmentDate || '';
    document.getElementById('staffAddress').value = staffMember.address || '';
    
    // Add event listener for department change to suggest positions
    const departmentSelect = document.getElementById('staffDepartment');
    const positionInput = document.getElementById('staffPosition');
    
    // Remove existing listener to avoid duplicates
    departmentSelect.removeEventListener('change', handleDepartmentChange);
    departmentSelect.addEventListener('change', handleDepartmentChange);
    
    function handleDepartmentChange() {
        const selectedDept = departmentSelect.value;
        
        if (selectedDept && departmentPositions[selectedDept]) {
            // Create a datalist for position suggestions
            let datalist = document.getElementById('positionSuggestions');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'positionSuggestions';
                positionInput.parentNode.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            departmentPositions[selectedDept].forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                datalist.appendChild(option);
            });
            
            positionInput.setAttribute('list', 'positionSuggestions');
            positionInput.placeholder = `e.g., ${departmentPositions[selectedDept][0]}`;
        } else {
            positionInput.removeAttribute('list');
            positionInput.placeholder = 'Enter position title';
        }
    }
}

// Delete staff function with confirmation
function deleteStaff(staffId) {
    if (!staff[staffId]) {
        alert('Staff member not found');
        return;
    }
    
    const staffMember = staff[staffId];
    
    if (confirm(`Are you sure you want to permanently delete ${staffMember.firstName} ${staffMember.lastName}? This action cannot be undone.`)) {
        // Show loading state
        showSuccessMessage('Deleting staff member...');
        
        db.ref('non_teaching_staff/' + staffId).remove()
            .then(() => {
                showSuccessMessage('Staff member deleted successfully!');
                loadData();
            })
            .catch(error => {
                alert('Error deleting staff: ' + error.message);
            });
    }
}

// Enhanced staff form submission with validation
function handleStaffSubmit(e) {
    e.preventDefault();
    
    if (!validateStaffForm()) {
        return;
    }
    
    const staffData = {
        firstName: document.getElementById('staffFirstName').value.trim(),
        lastName: document.getElementById('staffLastName').value.trim(),
        department: document.getElementById('staffDepartment').value,
        position: document.getElementById('staffPosition').value.trim(),
        email: document.getElementById('staffEmail').value.trim(),
        phone: document.getElementById('staffPhone').value.trim(),
        salary: parseFloat(document.getElementById('staffSalary').value),
        employmentDate: document.getElementById('staffEmploymentDate').value,
        address: document.getElementById('staffAddress').value.trim(),
        updatedAt: new Date().toISOString()
    };
    
    let staffId;
    let message;
    
    if (currentEditStaffId) {
        // Update existing staff
        staffId = currentEditStaffId;
        message = 'Staff member updated successfully!';
        
        // Preserve existing fields that shouldn't change
        staffData.employeeId = staff[staffId].employeeId;
        staffData.status = staff[staffId].status;
        staffData.createdAt = staff[staffId].createdAt;
    } else {
        // Add new staff
        staffId = 'STAFF' + Date.now();
        staffData.employeeId = 'STF' + new Date().getFullYear() + (Object.keys(staff).length + 1).toString().padStart(3, '0');
        staffData.status = 'Active';
        staffData.createdAt = new Date().toISOString();
        staffData.createdBy = 'hr_manager';
        message = 'Staff member added successfully!';
    }
    
    // Show loading state
    const submitBtn = document.getElementById('staffSubmitBtn');
    const originalText = submitBtn.textContent;
    submitBtn.innerHTML = '<div class="loading"></div> Saving...';
    submitBtn.disabled = true;
    
    // Save to Firebase
    db.ref('non_teaching_staff/' + staffId).set(staffData)
        .then(() => {
            showSuccessMessage(message);
            closeStaffModal();
            loadData();
        })
        .catch(error => {
            alert('Error saving staff: ' + error.message);
        })
        .finally(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        });
}

function validateStaffForm() {
    const requiredFields = [
        'staffFirstName', 'staffLastName', 'staffDepartment', 
        'staffPosition', 'staffEmail', 'staffPhone', 'staffSalary'
    ];
    
    for (let field of requiredFields) {
        const element = document.getElementById(field);
        if (!element.value.trim()) {
            alert(`Please fill in ${field.replace('staff', '').replace(/([A-Z])/g, ' $1').trim()}`);
            element.focus();
            return false;
        }
    }
    
    // Validate email format
    const email = document.getElementById('staffEmail').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        alert('Please enter a valid email address');
        document.getElementById('staffEmail').focus();
        return false;
    }
    
    return true;
}

// Render recent activities
function renderRecentActivities() {
    const tbody = document.getElementById('recentActivitiesTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(staff).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7">No staff data available</td></tr>';
        return;
    }
    
    // Show only recent 10 staff members
    const recentStaff = Object.entries(staff)
        .sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0))
        .slice(0, 10);
    
    recentStaff.forEach(([id, staffMember]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${staffMember.firstName} ${staffMember.lastName}</td>
            <td>${staffMember.employeeId || 'N/A'}</td>
            <td>${staffMember.department || 'N/A'}</td>
            <td>${staffMember.position || 'N/A'}</td>
            <td><span class="status-badge ${staffMember.status === 'Active' ? 'active' : 'inactive'}">${staffMember.status || 'Active'}</span></td>
            <td>${formatDate(staffMember.employmentDate) || 'N/A'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="viewStaff('${id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Enhanced department card rendering with hardcoded departments
function renderDepartmentsGrid() {
    const grid = document.getElementById('departmentsGrid');
    grid.innerHTML = '';
    
    departmentList.forEach(departmentName => {
        // Count staff in this department
        const departmentStaff = Object.values(staff).filter(staffMember => 
            staffMember.department === departmentName && staffMember.status === 'Active'
        ).length;
        
        const departmentCard = document.createElement('div');
        departmentCard.className = 'department-card';
        departmentCard.style.borderLeftColor = getDepartmentColor(departmentName);
        
        departmentCard.innerHTML = `
            <div class="department-header">
                <div>
                    <div class="department-name">${departmentName}</div>
                    <div class="staff-count">${departmentStaff} staff member${departmentStaff !== 1 ? 's' : ''}</div>
                </div>
                <span class="status-badge active">Active</span>
            </div>
            <div class="department-info">
                <p style="margin-bottom: 10px; color: #666;">${getDepartmentDescription(departmentName)}</p>
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #888;">
                    <span><strong>Common Positions:</strong></span>
                    <span>${getCommonPositionsCount(departmentName)}</span>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: 15px;">
                <button class="btn-info" onclick="viewDepartment('${departmentName}')">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="btn-primary" onclick="addStaffToDepartment('${departmentName}')">
                    <i class="fas fa-user-plus"></i> Add Staff
                </button>
            </div>
        `;
        grid.appendChild(departmentCard);
    });
}

// Enhanced department view functionality
function viewDepartment(departmentName) {
    const departmentStaff = Object.values(staff).filter(staffMember => 
        staffMember.department === departmentName && staffMember.status === 'Active'
    );
    
    const modalHTML = `
        <div class="modal" id="departmentViewModal" style="display: flex;">
            <div class="modal-content" style="max-width: 800px;">
                <h3>${departmentName} - Staff Details</h3>
                <div style="margin-bottom: 20px;">
                    <p><strong>Total Staff:</strong> ${departmentStaff.length}</p>
                    <p><strong>Common Positions:</strong> ${getCommonPositionsCount(departmentName)}</p>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Staff Name</th>
                                <th>Position</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Employment Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${departmentStaff.map(staffMember => `
                                <tr>
                                    <td>${staffMember.employeeId}</td>
                                    <td>${staffMember.firstName} ${staffMember.lastName}</td>
                                    <td>${staffMember.position}</td>
                                    <td>${staffMember.email}</td>
                                    <td>${staffMember.phone}</td>
                                    <td>${staffMember.employmentDate}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="modal-actions">
                    <button class="btn-danger" onclick="closeModal('departmentViewModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Enhanced leaves table rendering with decline/delete
function renderLeavesTable() {
    const tbody = document.getElementById('leavesTableBody');
    tbody.innerHTML = '';
    
    if (Object.keys(leaves).length === 0) {
        tbody.innerHTML = '<tr><td colspan="8">No leave records found</td></tr>';
        return;
    }
    
    Object.entries(leaves).forEach(([id, leave]) => {
        const staffMember = staff[leave.staffId] || {};
        const duration = calculateDateDifference(leave.startDate, leave.endDate);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${staffMember.firstName} ${staffMember.lastName}</td>
            <td>${staffMember.employeeId || 'N/A'}</td>
            <td>${leave.leaveType || 'N/A'}</td>
            <td>${leave.startDate || 'N/A'}</td>
            <td>${leave.endDate || 'N/A'}</td>
            <td>${duration} days</td>
            <td><span class="status-badge ${getLeaveStatusClass(leave.status)}">${leave.status || 'Pending'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn-info" onclick="viewLeave('${id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${leave.status === 'Pending' ? `
                    <button class="btn-success" onclick="approveLeave('${id}')" title="Approve">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn-warning" onclick="declineLeave('${id}')" title="Decline">
                        <i class="fas fa-times"></i>
                    </button>
                    ` : `
                    <button class="btn-danger" onclick="deleteLeave('${id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    `}
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Approve leave function
function approveLeave(leaveId) {
    if (confirm('Are you sure you want to approve this leave application?')) {
        // Update leave status in Firebase
        db.ref('staff_leaves/' + leaveId).update({ 
            status: 'Approved',
            processedAt: new Date().toISOString(),
            processedBy: 'hr_manager'
        })
        .then(() => {
            showSuccessMessage('Leave application approved');
            
            // Update staff dashboard notification
            const leave = leaves[leaveId];
            if (leave) {
                // Send notification to staff dashboard
                const notificationId = 'NOTIF' + Date.now();
                const notificationData = {
                    type: 'leave_approved',
                    message: `Your ${leave.leaveType} leave from ${leave.startDate} to ${leave.endDate} has been approved.`,
                    staffId: leave.staffId,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                db.ref('staff_notifications/' + notificationId).set(notificationData)
                    .then(() => {
                        console.log('Notification sent to staff dashboard');
                    })
                    .catch(error => {
                        console.error('Error sending notification:', error);
                    });
            }
            
            loadData();
        })
        .catch(error => alert('Error approving leave: ' + error.message));
    }
}

// Decline leave function
function declineLeave(leaveId) {
    if (confirm('Are you sure you want to decline this leave application?')) {
        db.ref('staff_leaves/' + leaveId).update({ 
            status: 'Declined',
            processedAt: new Date().toISOString(),
            processedBy: 'hr_manager'
        })
        .then(() => {
            showSuccessMessage('Leave application declined');
            
            // Update staff dashboard notification
            const leave = leaves[leaveId];
            if (leave) {
                // Send notification to staff dashboard
                const notificationId = 'NOTIF' + Date.now();
                const notificationData = {
                    type: 'leave_declined',
                    message: `Your ${leave.leaveType} leave from ${leave.startDate} to ${leave.endDate} has been declined.`,
                    staffId: leave.staffId,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                db.ref('staff_notifications/' + notificationId).set(notificationData)
                    .then(() => {
                        console.log('Notification sent to staff dashboard');
                    })
                    .catch(error => {
                        console.error('Error sending notification:', error);
                    });
            }
            
            loadData();
        })
        .catch(error => alert('Error declining leave: ' + error.message));
    }
}

// Delete leave function
function deleteLeave(leaveId) {
    if (confirm('Are you sure you want to permanently delete this leave record?')) {
        db.ref('staff_leaves/' + leaveId).remove()
        .then(() => {
            showSuccessMessage('Leave record deleted successfully');
            loadData();
        })
        .catch(error => alert('Error deleting leave: ' + error.message));
    }
}

function getLeaveStatusClass(status) {
    switch(status) {
        case 'Approved': return 'active';
        case 'Pending': return 'pending';
        case 'Declined': return 'inactive';
        default: return 'inactive';
    }
}

// Enhanced payroll processing with preview
function processPayroll() {
    const payrollMonth = document.getElementById('payrollMonth').value;
    if (!payrollMonth) {
        alert('Please select a payroll month');
        return;
    }
    
    const selectedDept = document.getElementById('payrollDepartment').value;
    const payrollData = generatePayrollPreview(selectedDept, payrollMonth);
    
    // Show preview modal
    showPayrollPreview(payrollData, payrollMonth);
}

function generatePayrollPreview(department, month) {
    const filteredStaff = Object.entries(staff).filter(([id, staffMember]) => {
        if (staffMember.status !== 'Active') return false;
        if (department && staffMember.department !== department) return false;
        return true;
    });
    
    return filteredStaff.map(([id, staffMember]) => {
        const basicSalary = staffMember.salary || 0;
        const allowances = calculateAllowances(staffMember);
        const deductions = calculateDeductions(staffMember);
        const netSalary = basicSalary + allowances - deductions;
        
        return {
            staffId: id,
            employeeId: staffMember.employeeId,
            staffName: `${staffMember.firstName} ${staffMember.lastName}`,
            department: staffMember.department,
            basicSalary: basicSalary,
            allowances: allowances,
            deductions: deductions,
            netSalary: netSalary,
            month: month
        };
    });
}

// Payroll preview modal
function showPayrollPreview(payrollData, month) {
    const previewHTML = `
        <div class="modal" id="payrollPreviewModal" style="display: flex;">
            <div class="modal-content" style="max-width: 900px;">
                <h3>Payroll Preview - ${month}</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Staff Name</th>
                                <th>Department</th>
                                <th>Basic Salary</th>
                                <th>Allowances</th>
                                <th>Deductions</th>
                                <th>Net Salary</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payrollData.map(item => `
                                <tr>
                                    <td>${item.employeeId}</td>
                                    <td>${item.staffName}</td>
                                    <td>${item.department}</td>
                                    <td>$${item.basicSalary.toFixed(2)}</td>
                                    <td>$${item.allowances.toFixed(2)}</td>
                                    <td>$${item.deductions.toFixed(2)}</td>
                                    <td><strong>$${item.netSalary.toFixed(2)}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background: var(--light);">
                                <td colspan="3"><strong>Total</strong></td>
                                <td><strong>$${payrollData.reduce((sum, item) => sum + item.basicSalary, 0).toFixed(2)}</strong></td>
                                <td><strong>$${payrollData.reduce((sum, item) => sum + item.allowances, 0).toFixed(2)}</strong></td>
                                <td><strong>$${payrollData.reduce((sum, item) => sum + item.deductions, 0).toFixed(2)}</strong></td>
                                <td><strong>$${payrollData.reduce((sum, item) => sum + item.netSalary, 0).toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-actions">
                    <button class="btn-success" onclick="savePayroll('${month}')">
                        <i class="fas fa-save"></i> Save Payroll
                    </button>
                    <button class="btn-primary" onclick="generatePayslipsPreview()">
                        <i class="fas fa-file-invoice"></i> Generate Payslips
                    </button>
                    <button class="btn-danger" onclick="closeModal('payrollPreviewModal')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', previewHTML);
}

function savePayroll(month) {
    const selectedDept = document.getElementById('payrollDepartment').value;
    const payrollData = generatePayrollPreview(selectedDept, month);
    
    showSuccessMessage('Processing payroll...');
    
    // Save each payroll record
    const promises = payrollData.map(item => {
        const payrollId = `PAY${month.replace('-', '')}_${item.staffId}`;
        const payrollRecord = {
            ...item,
            processedAt: new Date().toISOString(),
            status: 'Processed'
        };
        
        return db.ref('staff_payroll/' + payrollId).set(payrollRecord);
    });
    
    Promise.all(promises)
        .then(() => {
            closeModal('payrollPreviewModal');
            showSuccessMessage('Payroll processed successfully!');
            loadPayrollForMonth();
        })
        .catch(error => {
            alert('Error processing payroll: ' + error.message);
        });
}

// Enhanced attendance summary similar to pay report
function generateAttendanceSummary() {
    const selectedDept = document.getElementById('reportDepartment').value;
    const period = document.getElementById('reportPeriod').value;
    
    const summaryData = generateAttendanceSummaryData(selectedDept, period);
    showAttendanceSummaryModal(summaryData, period, selectedDept);
}

function generateAttendanceSummaryData(department, period) {
    const filteredStaff = Object.values(staff).filter(staffMember => {
        if (staffMember.status !== 'Active') return false;
        if (department && staffMember.department !== department) return false;
        return true;
    });
    
    // Calculate attendance statistics (mock data for demo)
    return filteredStaff.map(staffMember => {
        const totalDays = 22; // Assuming 22 working days
        const presentDays = Math.floor(totalDays * 0.85); // 85% attendance
        const absentDays = totalDays - presentDays;
        const lateDays = Math.floor(presentDays * 0.1); // 10% late
        const attendanceRate = (presentDays / totalDays * 100).toFixed(1);
        
        return {
            employeeId: staffMember.employeeId,
            staffName: `${staffMember.firstName} ${staffMember.lastName}`,
            department: staffMember.department,
            totalDays: totalDays,
            presentDays: presentDays,
            absentDays: absentDays,
            lateDays: lateDays,
            attendanceRate: attendanceRate
        };
    });
}

function showAttendanceSummaryModal(summaryData, period, department) {
    const modalHTML = `
        <div class="modal" id="attendanceSummaryModal" style="display: flex;">
            <div class="modal-content" style="max-width: 900px;">
                <h3>Attendance Summary - ${period} ${department ? `- ${department}` : ''}</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Staff Name</th>
                                <th>Department</th>
                                <th>Total Days</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Late</th>
                                <th>Attendance Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summaryData.map(item => `
                                <tr>
                                    <td>${item.employeeId}</td>
                                    <td>${item.staffName}</td>
                                    <td>${item.department}</td>
                                    <td>${item.totalDays}</td>
                                    <td>${item.presentDays}</td>
                                    <td>${item.absentDays}</td>
                                    <td>${item.lateDays}</td>
                                    <td><strong>${item.attendanceRate}%</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="modal-actions">
                    <button class="btn-danger" onclick="closeModal('attendanceSummaryModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Filter staff table
function filterStaffTable(searchTerm) {
    const rows = document.querySelectorAll('#staffTableBody tr');
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function openStaffModal(staffId = null) {
    document.getElementById('staffModal').style.display = 'flex';
    
    // Reset form and state
    document.getElementById('staffForm').reset();
    currentEditStaffId = staffId;
    
    // Set modal title
    if (staffId) {
        document.getElementById('staffModalTitle').textContent = 'Edit Staff Member';
        document.getElementById('staffSubmitBtn').textContent = 'Update Staff';
        
        // Populate form with existing data
        const staffMember = staff[staffId];
        document.getElementById('staffFirstName').value = staffMember.firstName || '';
        document.getElementById('staffLastName').value = staffMember.lastName || '';
        document.getElementById('staffDepartment').value = staffMember.department || '';
        document.getElementById('staffPosition').value = staffMember.position || '';
        document.getElementById('staffEmail').value = staffMember.email || '';
        document.getElementById('staffPhone').value = staffMember.phone || '';
        document.getElementById('staffSalary').value = staffMember.salary || '';
        document.getElementById('staffEmploymentDate').value = staffMember.employmentDate || '';
        document.getElementById('staffAddress').value = staffMember.address || '';
    } else {
        document.getElementById('staffModalTitle').textContent = 'Add New Staff Member';
        document.getElementById('staffSubmitBtn').textContent = 'Save Staff';
        // Set current date as default employment date
        document.getElementById('staffEmploymentDate').valueAsDate = new Date();
    }
    
    // Add event listener for department change to suggest positions
    const departmentSelect = document.getElementById('staffDepartment');
    const positionInput = document.getElementById('staffPosition');
    
    // Remove existing listener to avoid duplicates
    departmentSelect.removeEventListener('change', handleDepartmentChange);
    departmentSelect.addEventListener('change', handleDepartmentChange);
    
    function handleDepartmentChange() {
        const selectedDept = departmentSelect.value;
        
        if (selectedDept && departmentPositions[selectedDept]) {
            // Create a datalist for position suggestions
            let datalist = document.getElementById('positionSuggestions');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'positionSuggestions';
                positionInput.parentNode.appendChild(datalist);
            }
            
            datalist.innerHTML = '';
            departmentPositions[selectedDept].forEach(position => {
                const option = document.createElement('option');
                option.value = position;
                datalist.appendChild(option);
            });
            
            positionInput.setAttribute('list', 'positionSuggestions');
            positionInput.placeholder = `e.g., ${departmentPositions[selectedDept][0]}`;
        } else {
            positionInput.removeAttribute('list');
            positionInput.placeholder = 'Enter position title';
        }
    }
}

function closeStaffModal() {
    document.getElementById('staffModal').style.display = 'none';
    document.getElementById('staffForm').reset();
    currentEditStaffId = null;
}

// View staff details
function viewStaff(staffId) {
    if (!staff[staffId]) {
        alert('Staff member not found');
        return;
    }
    
    const staffMember = staff[staffId];
    
    // Populate details
    document.getElementById('staffDetailsContent').innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label><strong>Employee ID:</strong></label>
                <div>${staffMember.employeeId || 'N/A'}</div>
            </div>
            <div class="form-group">
                <label><strong>Full Name:</strong></label>
                <div>${staffMember.firstName} ${staffMember.lastName}</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label><strong>Department:</strong></label>
                <div>${staffMember.department || 'N/A'}</div>
            </div>
            <div class="form-group">
                <label><strong>Position:</strong></label>
                <div>${staffMember.position || 'N/A'}</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label><strong>Email:</strong></label>
                <div>${staffMember.email || 'N/A'}</div>
            </div>
            <div class="form-group">
                <label><strong>Phone:</strong></label>
                <div>${staffMember.phone || 'N/A'}</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label><strong>Employment Date:</strong></label>
                <div>${staffMember.employmentDate || 'N/A'}</div>
            </div>
            <div class="form-group">
                <label><strong>Status:</strong></label>
                <div><span class="status-badge ${staffMember.status === 'Active' ? 'active' : 'inactive'}">${staffMember.status || 'Active'}</span></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label><strong>Basic Salary:</strong></label>
                <div>$${staffMember.salary || '0'}</div>
            </div>
            <div class="form-group">
                <label><strong>Created:</strong></label>
                <div>${formatDate(staffMember.createdAt) || 'N/A'}</div>
            </div>
        </div>
        ${staffMember.address ? `
        <div class="form-group">
            <label><strong>Address:</strong></label>
            <div>${staffMember.address}</div>
        </div>
        ` : ''}
    `;
    
    document.getElementById('staffViewModal').style.display = 'flex';
}

function openDepartmentModal() {
    document.getElementById('departmentModal').style.display = 'flex';
}

function closeDepartmentModal() {
    document.getElementById('departmentModal').style.display = 'none';
    document.getElementById('departmentForm').reset();
}

// Handle department form submission
function handleDepartmentSubmit(e) {
    e.preventDefault();
    
    const departmentData = {
        departmentName: document.getElementById('departmentName').value,
        departmentHead: document.getElementById('departmentHead').value,
        description: document.getElementById('departmentDescription').value,
        color: document.getElementById('departmentColor').value,
        createdAt: new Date().toISOString(),
        createdBy: 'hr_manager',
        status: 'Active'
    };
    
    // Generate department ID
    const departmentId = 'DEPT' + Date.now();
    
    // Save to Firebase
    db.ref('departments/' + departmentId).set(departmentData)
        .then(() => {
            showSuccessMessage('Department created successfully!');
            closeDepartmentModal();
            // Refresh data
            loadData();
        })
        .catch(error => {
            alert('Error creating department: ' + error.message);
        });
}

// Realistic attendance marking modal
function openAttendanceModal() {
    document.getElementById('attendanceModal').style.display = 'flex';
    // Set current date as default
    document.getElementById('markAttendanceDate').valueAsDate = new Date();
    loadStaffForAttendance();
}

function loadStaffForAttendance() {
    const tbody = document.getElementById('attendanceMarkTableBody');
    const selectedDept = document.getElementById('markAttendanceDepartment').value;
    
    tbody.innerHTML = '';
    
    Object.entries(staff).forEach(([id, staffMember]) => {
        if (staffMember.status === 'Active' && (!selectedDept || staffMember.department === selectedDept)) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${staffMember.employeeId}</td>
                <td>${staffMember.firstName} ${staffMember.lastName}</td>
                <td>${staffMember.department}</td>
                <td>
                    <select class="attendance-status" data-staff-id="${id}">
                        <option value="Present">Present</option>
                        <option value="Absent">Absent</option>
                        <option value="Late">Late</option>
                        <option value="Leave">On Leave</option>
                    </select>
                </td>
                <td><input type="time" class="time-in" data-staff-id="${id}"></td>
                <td><input type="time" class="time-out" data-staff-id="${id}"></td>
                <td><input type="text" class="remarks" data-staff-id="${id}" placeholder="Remarks"></td>
            `;
            tbody.appendChild(tr);
        }
    });
}

function saveAttendance() {
    const date = document.getElementById('markAttendanceDate').value;
    if (!date) {
        alert('Please select a date');
        return;
    }
    
    const attendanceData = [];
    
    document.querySelectorAll('#attendanceMarkTableBody tr').forEach(row => {
        const staffId = row.querySelector('.attendance-status').getAttribute('data-staff-id');
        const status = row.querySelector('.attendance-status').value;
        const timeIn = row.querySelector('.time-in').value;
        const timeOut = row.querySelector('.time-out').value;
        const remarks = row.querySelector('.remarks').value;
        
        attendanceData.push({
            staffId,
            date,
            status,
            timeIn,
            timeOut,
            remarks
        });
    });
    
    // Save to Firebase
    const attendanceId = 'ATT' + Date.now();
    db.ref('staff_attendance/' + attendanceId).set({
        date: date,
        records: attendanceData,
        markedBy: 'hr_manager',
        markedAt: new Date().toISOString()
    })
    .then(() => {
        showSuccessMessage('Attendance marked successfully!');
        closeModal('attendanceModal');
        loadData();
    })
    .catch(error => {
        alert('Error saving attendance: ' + error.message);
    });
}

function openLeaveModal() {
    document.getElementById('leaveModal').style.display = 'flex';
    // Set current date as default
    const today = new Date();
    document.getElementById('leaveStart').valueAsDate = today;
    document.getElementById('leaveEnd').valueAsDate = today;
}

function closeLeaveModal() {
    document.getElementById('leaveModal').style.display = 'none';
    document.getElementById('leaveForm').reset();
}

// Handle leave form submission
function handleLeaveSubmit(e) {
    e.preventDefault();
    
    const leaveData = {
        staffId: document.getElementById('leaveStaff').value,
        leaveType: document.getElementById('leaveType').value,
        startDate: document.getElementById('leaveStart').value,
        endDate: document.getElementById('leaveEnd').value,
        duration: parseInt(document.getElementById('leaveDuration').value),
        reason: document.getElementById('leaveReason').value,
        status: 'Pending',
        appliedDate: new Date().toISOString(),
        appliedBy: 'hr_manager'
    };
    
    // Generate leave ID
    const leaveId = 'LEAVE' + Date.now();
    
    // Save to Firebase
    db.ref('staff_leaves/' + leaveId).set(leaveData)
        .then(() => {
            showSuccessMessage('Leave application submitted successfully!');
            closeLeaveModal();
            // Refresh data
            loadData();
        })
        .catch(error => {
            alert('Error applying for leave: ' + error.message);
        });
}

// Calculate leave duration
function calculateLeaveDuration() {
    const startDate = new Date(document.getElementById('leaveStart').value);
    const endDate = new Date(document.getElementById('leaveEnd').value);
    
    if (startDate && endDate && startDate <= endDate) {
        const timeDiff = endDate.getTime() - startDate.getTime();
        const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 to include both start and end dates
        document.getElementById('leaveDuration').value = dayDiff;
    }
}

// Generate reports
function generateReports() {
    const selectedDepartment = document.getElementById('reportDepartment').value;
    const selectedPeriod = document.getElementById('reportPeriod').value;
    
    const tbody = document.getElementById('reportTableBody');
    tbody.innerHTML = '';
    
    let departmentsToShow = departmentList;
    
    // Filter departments if specific department selected
    if (selectedDepartment) {
        departmentsToShow = [selectedDepartment];
    }
    
    departmentsToShow.forEach(departmentName => {
        // Count staff in this department
        const departmentStaff = Object.values(staff).filter(staffMember => 
            staffMember.department === departmentName && staffMember.status === 'Active'
        ).length;
        
        // Mock attendance data for demo
        const present = Math.floor(departmentStaff * 0.85); // 85% attendance
        const onLeave = Math.floor(departmentStaff * 0.08); // 8% on leave
        const absent = departmentStaff - present - onLeave;
        const attendanceRate = departmentStaff > 0 ? ((present / departmentStaff) * 100).toFixed(1) : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${departmentName}</td>
            <td>${departmentStaff}</td>
            <td>${present}</td>
            <td>${onLeave}</td>
            <td>${absent}</td>
            <td>${attendanceRate}%</td>
        `;
        tbody.appendChild(tr);
    });
    
    // Update summary cards
    document.getElementById('avgAttendance').textContent = '85%';
    document.getElementById('leaveUtilization').textContent = '42%';
    document.getElementById('staffTurnover').textContent = '8%';
    document.getElementById('overtimeHours').textContent = '156';
    
    if (departmentsToShow.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No data available for selected filters</td></tr>';
    }
}

// Settings functions
function saveSystemSettings() {
    const systemName = document.getElementById('systemName').value;
    const adminEmail = document.getElementById('adminEmail').value;
    const autoBackup = document.getElementById('autoBackup').checked;
    const backupTime = document.getElementById('backupTime').value;
    
    // Save to Firebase or localStorage
    const settings = {
        systemName,
        adminEmail,
        autoBackup,
        backupTime,
        lastUpdated: new Date().toISOString()
    };
    
    localStorage.setItem('systemSettings', JSON.stringify(settings));
    showSuccessMessage('System settings saved successfully!');
}

function saveAttendanceSettings() {
    const workStartTime = document.getElementById('workStartTime').value;
    const workEndTime = document.getElementById('workEndTime').value;
    const lateThreshold = document.getElementById('lateThreshold').value;
    const autoLogout = document.getElementById('autoLogout').checked;
    
    const settings = {
        workStartTime,
        workEndTime,
        lateThreshold,
        autoLogout,
        lastUpdated: new Date().toISOString()
    };
    
    localStorage.setItem('attendanceSettings', JSON.stringify(settings));
    showSuccessMessage('Attendance settings saved successfully!');
}

function saveNotificationSettings() {
    const emailNotifications = document.getElementById('emailNotifications').checked;
    const leaveApprovals = document.getElementById('leaveApprovals').checked;
    const payrollAlerts = document.getElementById('payrollAlerts').checked;
    
    const settings = {
        emailNotifications,
        leaveApprovals,
        payrollAlerts,
        lastUpdated: new Date().toISOString()
    };
    
    localStorage.setItem('notificationSettings', JSON.stringify(settings));
    showSuccessMessage('Notification settings saved successfully!');
}

function backupDatabase() {
    showSuccessMessage('Database backup created successfully!');
}

function clearCache() {
    localStorage.removeItem('systemSettings');
    localStorage.removeItem('attendanceSettings');
    localStorage.removeItem('notificationSettings');
    showSuccessMessage('System cache cleared successfully!');
}

function viewSystemLogs() {
    alert('System logs would be displayed here in a real implementation');
}

// Payroll functions
function calculateAllowances(staffMember) {
    // Implement your allowance calculation logic
    return (staffMember.salary || 0) * 0.1; // 10% as example
}

function calculateDeductions(staffMember) {
    // Implement your deduction calculation logic
    return (staffMember.salary || 0) * 0.05; // 5% as example
}

function generatePayslips() {
    showSuccessMessage('Payslips generated successfully!');
}

// Leave management functions
function viewLeave(leaveId) {
    const leave = leaves[leaveId];
    const staffMember = staff[leave.staffId] || {};
    
    alert(`Leave Details:\n\nStaff: ${staffMember.firstName} ${staffMember.lastName}\nType: ${leave.leaveType}\nDuration: ${leave.duration} days\nStatus: ${leave.status}\nReason: ${leave.reason}`);
}

// Report functions
function generateStaffReport() {
    generateReports();
    showSuccessMessage('Staff report generated!');
}

function generatePayrollReport() {
    showSuccessMessage('Payroll report generated!');
}

function generateAttendanceReport() {
    generateReports();
    showSuccessMessage('Attendance report generated successfully!');
}

// Export functions
function exportStaffList() {
    showSuccessMessage('Staff list exported successfully!');
}

// Utility functions
function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    successMsg.querySelector('span').textContent = message;
    successMsg.classList.add('show');
    
    setTimeout(() => {
        successMsg.classList.remove('show');
    }, 3000);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function getStaffName(staffId) {
    const staffMember = staff[staffId];
    return staffMember ? `${staffMember.firstName} ${staffMember.lastName}` : 'Unknown';
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function calculateDateDifference(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const timeDiff = end.getTime() - start.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
}

function isDateInRange(date, startDate, endDate) {
    const checkDate = new Date(date);
    const start = new Date(startDate);
    const end = new Date(endDate);
    return checkDate >= start && checkDate <= end;
}

// Helper function to get department color
function getDepartmentColor(departmentName) {
    const colors = {
        "Administration": "#2062f0",
        "Finance & Accounts": "#28a745",
        "Human Resources": "#ffc107",
        "ICT Department": "#17a2b8",
        "Library": "#6f42c1",
        "Maintenance": "#fd7e14",
        "Security": "#e83e8c",
        "Transport": "#20c997",
        "Catering": "#dc3545",
        "Health Services": "#6610f2",
        "Registry": "#0dcaf0",
        "Procurement": "#198754"
    };
    return colors[departmentName] || '#2062f0';
}

// Helper function to get department description
function getDepartmentDescription(departmentName) {
    const descriptions = {
        "Administration": "General administration and management staff",
        "Finance & Accounts": "Financial management, accounting, and payroll",
        "Human Resources": "Staff recruitment, training, and welfare",
        "ICT Department": "Information technology and systems support",
        "Library": "Library services and resource management",
        "Maintenance": "Facilities maintenance and repairs",
        "Security": "Campus security and safety",
        "Transport": "College transport and fleet management",
        "Catering": "Food services and cafeteria management",
        "Health Services": "Medical and health support services",
        "Registry": "Student records and documentation",
        "Procurement": "Purchasing and supplies management"
    };
    return descriptions[departmentName] || 'Department description not available';
}

// Helper function to get common positions count
function getCommonPositionsCount(departmentName) {
    return departmentPositions[departmentName] ? departmentPositions[departmentName].length : 0;
}

// Function to quickly add staff to a specific department
function addStaffToDepartment(departmentName) {
    openStaffModal();
    // Pre-select the department
    setTimeout(() => {
        document.getElementById('staffDepartment').value = departmentName;
        // Trigger the department change event to load positions
        const event = new Event('change');
        document.getElementById('staffDepartment').dispatchEvent(event);
    }, 100);
}

// Placeholder functions for additional features
function loadAttendanceForDate() {
    showSuccessMessage('Attendance data loaded for selected date!');
}

function loadPayrollForMonth() {
    showSuccessMessage('Payroll data loaded for selected month!');
}

function markIndividualAttendance(staffId) {
    alert(`Mark attendance for staff ID: ${staffId}`);
}

function viewPayslip(staffId, month) {
    alert(`View payslip for staff ID: ${staffId} for ${month}`);
}

function editPayroll(staffId, month) {
    alert(`Edit payroll for staff ID: ${staffId} for ${month}`);
}

function generatePayslipsPreview() {
    showSuccessMessage('Payslips preview generated!');
}

// Initialize date fields and load settings
window.onload = function() {
    const today = new Date();
    document.getElementById('staffEmploymentDate').valueAsDate = today;
    document.getElementById('attendanceDate').valueAsDate = today;
    document.getElementById('leaveStart').valueAsDate = today;
    document.getElementById('leaveEnd').valueAsDate = today;
    document.getElementById('markAttendanceDate').valueAsDate = today;
    
    // Set payroll month to current month
    const currentMonth = today.toISOString().slice(0, 7);
    document.getElementById('payrollMonth').value = currentMonth;
    
    // Load saved settings
    loadSavedSettings();
};

function loadSavedSettings() {
    // Load system settings
    const systemSettings = JSON.parse(localStorage.getItem('systemSettings'));
    if (systemSettings) {
        document.getElementById('systemName').value = systemSettings.systemName || 'UCST Staff Management System';
        document.getElementById('adminEmail').value = systemSettings.adminEmail || 'admin@ucst.edu';
        document.getElementById('autoBackup').checked = systemSettings.autoBackup || false;
        document.getElementById('backupTime').value = systemSettings.backupTime || '02:00';
    }
    
    // Load attendance settings
    const attendanceSettings = JSON.parse(localStorage.getItem('attendanceSettings'));
    if (attendanceSettings) {
        document.getElementById('workStartTime').value = attendanceSettings.workStartTime || '08:00';
        document.getElementById('workEndTime').value = attendanceSettings.workEndTime || '17:00';
        document.getElementById('lateThreshold').value = attendanceSettings.lateThreshold || '15';
        document.getElementById('autoLogout').checked = attendanceSettings.autoLogout || false;
    }
    
    // Load notification settings
    const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings'));
    if (notificationSettings) {
        document.getElementById('emailNotifications').checked = notificationSettings.emailNotifications || false;
        document.getElementById('leaveApprovals').checked = notificationSettings.leaveApprovals || false;
        document.getElementById('payrollAlerts').checked = notificationSettings.payrollAlerts || false;
    }
}
</script>
</body>
</html>